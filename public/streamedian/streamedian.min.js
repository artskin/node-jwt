"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},classCallCheck=function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")},createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),defineProperty=function(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj},get=function get(object,property,receiver){null===object&&(object=Function.prototype);var desc=Object.getOwnPropertyDescriptor(object,property);if(void 0===desc){var parent=Object.getPrototypeOf(object);return null===parent?void 0:get(parent,property,receiver)}if("value"in desc)return desc.value;var getter=desc.get;return void 0!==getter?getter.call(receiver):void 0},inherits=function(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)},possibleConstructorReturn=function(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call},slicedToArray=function(){return function(arr,i){if(Array.isArray(arr))return arr;if(Symbol.iterator in Object(arr))return function(arr,i){var _arr=[],_n=!0,_d=!1,_e=void 0;try{for(var _s,_i=arr[Symbol.iterator]();!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{!_n&&_i.return&&_i.return()}finally{if(_d)throw _e}}return _arr}(arr,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),LogLevel={Error:0,Warn:1,Log:2,Debug:3},DEFAULT_LOG_LEVEL=LogLevel.Debug;function setDefaultLogLevel(level){DEFAULT_LOG_LEVEL=level}var Logger=function(){function Logger(){var level=arguments.length>0&&void 0!==arguments[0]?arguments[0]:DEFAULT_LOG_LEVEL,tag=arguments[1];classCallCheck(this,Logger),this.tag=tag,this.setLevel(level)}return createClass(Logger,[{key:"setLevel",value:function(level){this.level=level}},{key:"_log",value:function(lvl,args){args=Array.prototype.slice.call(args),this.tag&&args.unshift("["+this.tag+"]"),this.level>=lvl&&console[Logger.level_map[lvl]].apply(console,args)}},{key:"log",value:function(){this._log(LogLevel.Log,arguments)}},{key:"debug",value:function(){this._log(LogLevel.Debug,arguments)}},{key:"error",value:function(){this._log(LogLevel.Error,arguments)}},{key:"warn",value:function(){this._log(LogLevel.Warn,arguments)}}],[{key:"level_map",get:function(){var _ref;return defineProperty(_ref={},LogLevel.Debug,"log"),defineProperty(_ref,LogLevel.Log,"log"),defineProperty(_ref,LogLevel.Warn,"warn"),defineProperty(_ref,LogLevel.Error,"error"),_ref}}]),Logger}(),taggedLoggers=new Map;function getTagged(tag){return taggedLoggers.has(tag)||taggedLoggers.set(tag,new Logger(DEFAULT_LOG_LEVEL,tag)),taggedLoggers.get(tag)}var Log=new Logger;function __async(g){return new Promise(function(s,j){function c(a,x){try{var r=g[x?"throw":"next"](a)}catch(e){return void j(e)}r.done?s(r.value):Promise.resolve(r.value).then(c,d)}function d(e){c(e,1)}c()})}var Url=function(){function Url(){classCallCheck(this,Url)}return createClass(Url,null,[{key:"parse",value:function(url){var ret={},result=/^([^:]+):\/\/([^\/]+)(.*)$/.exec(url);if(!result)throw new Error("bad url");ret.full=url,ret.protocol=result[1],ret.urlpath=result[3];var parts=ret.urlpath.split("/");ret.basename=parts.pop().split(/\?|#/)[0],ret.basepath=parts.join("/");var loginSplit=result[2].split(/(.+)@(.+)$/).filter(function(e){return e}),hostport=loginSplit[0].split(":"),userpass=[null,null];return 2===loginSplit.length&&(userpass=loginSplit[0].split(":"),hostport=loginSplit[1].split(":")),ret.user=userpass[0],ret.pass=userpass[1],ret.host=hostport[0],ret.auth=ret.user&&ret.pass?ret.user+":"+ret.pass:"",ret.port=null==hostport[1]?Url.protocolDefaultPort(ret.protocol):hostport[1],ret.portDefined=null!=hostport[1],ret.location=ret.host+":"+ret.port,"unix"==ret.protocol&&(ret.socket=ret.port,ret.port=void 0),ret}},{key:"full",value:function(parsed){return parsed.protocol+"://"+parsed.location+"/"+parsed.urlpath}},{key:"isAbsolute",value:function(url){return/^[^:]+:\/\//.test(url)}},{key:"protocolDefaultPort",value:function(protocol){switch(protocol){case"rtsp":return 554;case"http":return 80;case"https":return 443}return 0}}]),Url}(),listener=Symbol("event_listener"),listeners=Symbol("event_listeners"),DestructibleEventListener=function(){function DestructibleEventListener(eventListener){classCallCheck(this,DestructibleEventListener),this[listener]=eventListener,this[listeners]=new Map}return createClass(DestructibleEventListener,[{key:"clear",value:function(){if(this[listeners]){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=this[listeners][Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var entry=_step.value,_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=entry[1][Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var fn=_step2.value;this[listener].removeEventListener(entry[0],fn)}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}this[listeners].clear()}},{key:"destroy",value:function(){this.clear(),this[listeners]=null}},{key:"on",value:function(event,selector,fn){return void 0==fn&&(fn=selector,selector=null),selector?this.addEventListener(event,function(e){e.target.matches(selector)&&fn(e)}):this.addEventListener(event,fn)}},{key:"addEventListener",value:function(event,fn){return this[listeners].has(event)||this[listeners].set(event,new Set),this[listeners].get(event).add(fn),this[listener].addEventListener(event,fn,!1),fn}},{key:"removeEventListener",value:function(event,fn){if(this[listener].removeEventListener(event,fn,!1),this[listeners].has(event)){var ev=this[listeners].get(event);ev.delete(fn),ev.size||this[listeners].delete(event)}}},{key:"dispatchEvent",value:function(event){this[listener]&&this[listener].dispatchEvent(event)}}]),DestructibleEventListener}(),EventEmitter=function(){function EventEmitter(){var element=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;classCallCheck(this,EventEmitter),this[listener]=new DestructibleEventListener(element||document.createElement("div"))}return createClass(EventEmitter,[{key:"clear",value:function(){this[listener]&&this[listener].clear()}},{key:"destroy",value:function(){this[listener]&&(this[listener].destroy(),this[listener]=null)}},{key:"on",value:function(event,selector,fn){return this[listener]?this[listener].on(event,selector,fn):null}},{key:"addEventListener",value:function(event,fn){return this[listener]?this[listener].addEventListener(event,fn,!1):null}},{key:"removeEventListener",value:function(event,fn){this[listener]&&this[listener].removeEventListener(event,fn,!1)}},{key:"dispatchEvent",value:function(event,data){this[listener]&&this[listener].dispatchEvent(new CustomEvent(event,{detail:data}))}}]),EventEmitter}(),EventSourceWrapper=function(){function EventSourceWrapper(eventSource){classCallCheck(this,EventSourceWrapper),this.eventSource=eventSource,this[listeners]=new Map}return createClass(EventSourceWrapper,[{key:"on",value:function(event,selector,fn){this[listeners].has(event)||this[listeners].set(event,new Set);var listener=this.eventSource.on(event,selector,fn);listener&&this[listeners].get(event).add(listener)}},{key:"off",value:function(event,fn){this.eventSource.removeEventListener(event,fn)}},{key:"clear",value:function(){this.eventSource.clear(),this[listeners].clear()}},{key:"destroy",value:function(){this.eventSource.clear(),this[listeners]=null,this.eventSource=null}}]),EventSourceWrapper}();function CircularBuffer(capacity){if(!(this instanceof CircularBuffer))return new CircularBuffer(capacity);if("object"==(void 0===capacity?"undefined":_typeof(capacity))&&Array.isArray(capacity._buffer)&&"number"==typeof capacity._capacity&&"number"==typeof capacity._first&&"number"==typeof capacity._size)for(var prop in capacity)capacity.hasOwnProperty(prop)&&(this[prop]=capacity[prop]);else{if("number"!=typeof capacity||capacity%1!=0||capacity<1)throw new TypeError("Invalid capacity");this._buffer=new Array(capacity),this._capacity=capacity,this._first=0,this._size=0}}CircularBuffer.prototype={size:function(){return this._size},capacity:function(){return this._capacity},enq:function(value){this._first>0?this._first--:this._first=this._capacity-1,this._buffer[this._first]=value,this._size<this._capacity&&this._size++},push:function(value){this._size==this._capacity?(this._buffer[this._first]=value,this._first=(this._first+1)%this._capacity):(this._buffer[(this._first+this._size)%this._capacity]=value,this._size++)},deq:function(){if(0==this._size)throw new RangeError("dequeue on empty buffer");var value=this._buffer[(this._first+this._size-1)%this._capacity];return this._size--,value},pop:function(){return this.deq()},shift:function(){if(0==this._size)throw new RangeError("shift on empty buffer");var value=this._buffer[this._first];return this._first==this._capacity-1?this._first=0:this._first++,this._size--,value},get:function(start,end){if(0==this._size&&0==start&&(void 0==end||0==end))return[];if("number"!=typeof start||start%1!=0||start<0)throw new TypeError("Invalid start");if(start>=this._size)throw new RangeError("Index past end of buffer: "+start);if(void 0==end)return this._buffer[(this._first+start)%this._capacity];if("number"!=typeof end||end%1!=0||end<0)throw new TypeError("Invalid end");if(end>=this._size)throw new RangeError("Index past end of buffer: "+end);return this._first+start>=this._capacity&&(start-=this._capacity,end-=this._capacity),this._first+end<this._capacity?this._buffer.slice(this._first+start,this._first+end+1):this._buffer.slice(this._first+start,this._capacity).concat(this._buffer.slice(0,this._first+end+1-this._capacity))},toarray:function(){return 0==this._size?[]:this.get(0,this._size-1)}};var MP4=function(){function MP4(){classCallCheck(this,MP4)}return createClass(MP4,null,[{key:"init",value:function(){var i;MP4.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],mvex:[],mvhd:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};for(i in MP4.types)MP4.types.hasOwnProperty(i)&&(MP4.types[i]=[i.charCodeAt(0),i.charCodeAt(1),i.charCodeAt(2),i.charCodeAt(3)]);var videoHdlr=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),audioHdlr=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);MP4.HDLR_TYPES={video:videoHdlr,audio:audioHdlr};var dref=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),stco=new Uint8Array([0,0,0,0,0,0,0,0]);MP4.STTS=MP4.STSC=MP4.STCO=stco,MP4.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),MP4.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),MP4.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),MP4.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);var majorBrand=new Uint8Array([105,115,111,109]),avc1Brand=new Uint8Array([97,118,99,49]),minorVersion=new Uint8Array([0,0,0,1]);MP4.FTYP=MP4.box(MP4.types.ftyp,majorBrand,minorVersion,majorBrand,avc1Brand),MP4.DINF=MP4.box(MP4.types.dinf,MP4.box(MP4.types.dref,dref))}},{key:"box",value:function(type){for(var _len=arguments.length,payload=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++)payload[_key-1]=arguments[_key];for(var result,size=8,i=payload.length,len=i;i--;)size+=payload[i].byteLength;for((result=new Uint8Array(size))[0]=size>>24&255,result[1]=size>>16&255,result[2]=size>>8&255,result[3]=255&size,result.set(type,4),i=0,size=8;i<len;++i)result.set(payload[i],size),size+=payload[i].byteLength;return result}},{key:"hdlr",value:function(type){return MP4.box(MP4.types.hdlr,MP4.HDLR_TYPES[type])}},{key:"mdat",value:function(data){return MP4.box(MP4.types.mdat,data)}},{key:"mdhd",value:function(timescale,duration){return MP4.box(MP4.types.mdhd,new Uint8Array([0,0,0,0,0,0,0,2,0,0,0,3,timescale>>24&255,timescale>>16&255,timescale>>8&255,255&timescale,duration>>24,duration>>16&255,duration>>8&255,255&duration,85,196,0,0]))}},{key:"mdia",value:function(track){return MP4.box(MP4.types.mdia,MP4.mdhd(track.timescale,track.duration),MP4.hdlr(track.type),MP4.minf(track))}},{key:"mfhd",value:function(sequenceNumber){return MP4.box(MP4.types.mfhd,new Uint8Array([0,0,0,0,sequenceNumber>>24,sequenceNumber>>16&255,sequenceNumber>>8&255,255&sequenceNumber]))}},{key:"minf",value:function(track){return"audio"===track.type?MP4.box(MP4.types.minf,MP4.box(MP4.types.smhd,MP4.SMHD),MP4.DINF,MP4.stbl(track)):MP4.box(MP4.types.minf,MP4.box(MP4.types.vmhd,MP4.VMHD),MP4.DINF,MP4.stbl(track))}},{key:"moof",value:function(sn,baseMediaDecodeTime,track){return MP4.box(MP4.types.moof,MP4.mfhd(sn),MP4.traf(track,baseMediaDecodeTime))}},{key:"moov",value:function(tracks,duration,timescale){for(var i=tracks.length,boxes=[];i--;)boxes[i]=MP4.trak(tracks[i]);return MP4.box.apply(null,[MP4.types.moov,MP4.mvhd(timescale,duration)].concat(boxes).concat(MP4.mvex(tracks)))}},{key:"mvex",value:function(tracks){for(var i=tracks.length,boxes=[];i--;)boxes[i]=MP4.trex(tracks[i]);return MP4.box.apply(null,[MP4.types.mvex].concat(boxes))}},{key:"mvhd",value:function(timescale,duration){var bytes=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,2,timescale>>24&255,timescale>>16&255,timescale>>8&255,255&timescale,duration>>24&255,duration>>16&255,duration>>8&255,255&duration,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return MP4.box(MP4.types.mvhd,bytes)}},{key:"sdtp",value:function(track){var flags,i,samples=track.samples||[],bytes=new Uint8Array(4+samples.length);for(i=0;i<samples.length;i++)flags=samples[i].flags,bytes[i+4]=flags.dependsOn<<4|flags.isDependedOn<<2|flags.hasRedundancy;return MP4.box(MP4.types.sdtp,bytes)}},{key:"stbl",value:function(track){return MP4.box(MP4.types.stbl,MP4.stsd(track),MP4.box(MP4.types.stts,MP4.STTS),MP4.box(MP4.types.stsc,MP4.STSC),MP4.box(MP4.types.stsz,MP4.STSZ),MP4.box(MP4.types.stco,MP4.STCO))}},{key:"avc1",value:function(track){var i,data,len,sps=[],pps=[];for(i=0;i<track.sps.length;i++)len=(data=track.sps[i]).byteLength,sps.push(len>>>8&255),sps.push(255&len),sps=sps.concat(Array.prototype.slice.call(data));for(i=0;i<track.pps.length;i++)len=(data=track.pps[i]).byteLength,pps.push(len>>>8&255),pps.push(255&len),pps=pps.concat(Array.prototype.slice.call(data));var avcc=MP4.box(MP4.types.avcC,new Uint8Array([1,sps[3],sps[4],sps[5],255,224|track.sps.length].concat(sps).concat([track.pps.length]).concat(pps))),width=track.width,height=track.height;return MP4.box(MP4.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,width>>8&255,255&width,height>>8&255,255&height,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,98,105,110,101,108,112,114,111,46,114,117,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),avcc,MP4.box(MP4.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])))}},{key:"esds",value:function(track){var configlen=track.config.byteLength,data=new Uint8Array(26+configlen+3);return data.set([0,0,0,0,3,23+configlen,0,1,0,4,15+configlen,64,21,0,0,0,0,0,0,0,0,0,0,0,5,configlen]),data.set(track.config,26),data.set([6,1,2],26+configlen),data}},{key:"mp4a",value:function(track){var audiosamplerate=track.audiosamplerate;return MP4.box(MP4.types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,track.channelCount,0,16,0,0,0,0,audiosamplerate>>8&255,255&audiosamplerate,0,0]),MP4.box(MP4.types.esds,MP4.esds(track)))}},{key:"stsd",value:function(track){return"audio"===track.type?MP4.box(MP4.types.stsd,MP4.STSD,MP4.mp4a(track)):MP4.box(MP4.types.stsd,MP4.STSD,MP4.avc1(track))}},{key:"tkhd",value:function(track){var id=track.id,duration=track.duration,width=track.width,height=track.height,volume=track.volume;return MP4.box(MP4.types.tkhd,new Uint8Array([0,0,0,7,0,0,0,0,0,0,0,0,id>>24&255,id>>16&255,id>>8&255,255&id,0,0,0,0,duration>>24,duration>>16&255,duration>>8&255,255&duration,0,0,0,0,0,0,0,0,0,0,0,0,volume>>0&255,volume%1*10>>0&255,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,width>>8&255,255&width,0,0,height>>8&255,255&height,0,0]))}},{key:"traf",value:function(track,baseMediaDecodeTime){var sampleDependencyTable=MP4.sdtp(track),id=track.id;return MP4.box(MP4.types.traf,MP4.box(MP4.types.tfhd,new Uint8Array([0,0,0,0,id>>24,id>>16&255,id>>8&255,255&id])),MP4.box(MP4.types.tfdt,new Uint8Array([0,0,0,0,baseMediaDecodeTime>>24,baseMediaDecodeTime>>16&255,baseMediaDecodeTime>>8&255,255&baseMediaDecodeTime])),MP4.trun(track,sampleDependencyTable.length+16+16+8+16+8+8),sampleDependencyTable)}},{key:"trak",value:function(track){return track.duration=track.duration||4294967295,MP4.box(MP4.types.trak,MP4.tkhd(track),MP4.mdia(track))}},{key:"trex",value:function(track){var id=track.id;return MP4.box(MP4.types.trex,new Uint8Array([0,0,0,0,id>>24,id>>16&255,id>>8&255,255&id,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}},{key:"trun",value:function(track,offset){var i,sample,duration,size,flags,cts,samples=track.samples||[],len=samples.length,arraylen=12+16*len,array=new Uint8Array(arraylen);for(offset+=8+arraylen,array.set([0,0,15,1,len>>>24&255,len>>>16&255,len>>>8&255,255&len,offset>>>24&255,offset>>>16&255,offset>>>8&255,255&offset],0),i=0;i<len;i++)duration=(sample=samples[i]).duration,size=sample.size,flags=sample.flags,cts=sample.cts,array.set([duration>>>24&255,duration>>>16&255,duration>>>8&255,255&duration,size>>>24&255,size>>>16&255,size>>>8&255,255&size,flags.isLeading<<2|flags.dependsOn,flags.isDependedOn<<6|flags.hasRedundancy<<4|flags.paddingValue<<1|flags.isNonSync,61440&flags.degradPrio,15&flags.degradPrio,cts>>>24&255,cts>>>16&255,cts>>>8&255,255&cts],12+16*i);return MP4.box(MP4.types.trun,array)}},{key:"initSegment",value:function(tracks,duration,timescale){MP4.types||MP4.init();var result,movie=MP4.moov(tracks,duration,timescale);return(result=new Uint8Array(MP4.FTYP.byteLength+movie.byteLength)).set(MP4.FTYP),result.set(movie,MP4.FTYP.byteLength),result}}]),MP4}(),DataView$1=window.DataView;function PublicPromise(){var resolvePromise,rejectPromise,promise=new Promise(function(resolve,reject){resolvePromise=resolve,rejectPromise=reject});return promise.resolve=resolvePromise,promise.reject=rejectPromise,promise}var LOG_TAG$1="mse",Log$4=getTagged(LOG_TAG$1),MSEBuffer=function(){function MSEBuffer(parent,codec){classCallCheck(this,MSEBuffer),this.mediaSource=parent.mediaSource,this.players=parent.players,this._parent=parent,this._queue=[],this.codec=codec,this._destroyed=!1,this._lastClearEnd=0,Log$4.debug("Use codec: "+codec),this._sourceBuffer=this.mediaSource.addSourceBuffer(codec),this.eventSource=new EventEmitter(this._sourceBuffer),this.eventSource.addEventListener("updateend",this._onUpdateEnd.bind(this)),this.eventSource.addEventListener("error",this._onError.bind(this))}return createClass(MSEBuffer,[{key:"destroy",value:function(){var _this=this;this._destroyed=!0;var cleanup=[],noop=function(e){},q=this._queue,inProgress=q[0];this._queue=q.slice(0,1),inProgress&&cleanup.push(inProgress.p.catch(noop));for(var i=1;i<q.length;i++)q[i].p.catch(noop),q[i].p.reject();return Promise.all(cleanup).then(function(){_this.eventSource.destroy(),_this.eventSource=null,_this.mediaSource.removeSourceBuffer(_this._sourceBuffer),_this._sourceBuffer=null,_this._queue={},_this._lastClearEnd=0})}},{key:"setLive",value:function(is_live){this.is_live=is_live}},{key:"appendBuffer",value:function(data){return this._enqueueOperations(this._opAppend.bind(this,data))}},{key:"clear",value:function(){return this._enqueueOperations(this._opRemove.bind(this,0,this.mediaSource.duration))}},{key:"remove",value:function(start,end){return this._enqueueOperations(this._opRemove.bind(this,start,end))}},{key:"_clearLiveBuffer",value:function(){if(this.is_live){var buffered=this._sourceBuffer.buffered;if(0!=buffered.length){var start=buffered.start(0),end=buffered.end(0),clearEnd=this.players[0].currentTime-MSEBuffer.LIVE_BUFFER_DURATION;end-start<MSEBuffer.LIVE_BUFFER_DURATION||start>=clearEnd||clearEnd-this._lastClearEnd<MSEBuffer.LIVE_BUFFER_DURATION||(this._lastClearEnd=clearEnd,this.remove(start,clearEnd))}}}},{key:"_enqueueOperations",value:function(start){if(this._destroyed)return Promise.reject();var op={start:start,p:new PublicPromise};if(this._queue.push(op),1==this._queue.length)try{op.start()}catch(exception){op.p.reject(exception),this._popFromQueue()}}},{key:"_popFromQueue",value:function(){this._queue.shift();var next=this._queue[0];if(next)try{next.start()}catch(exception){console.log("pop op: ",exception),next.p.reject(exception),this._popFromQueue()}}},{key:"_onUpdateEnd",value:function(){var op=this._queue[0];op?this._sourceBuffer.updating?console.log("SourceBuffer should not be updating on updateend!"):(op.p.resolve(),this._popFromQueue()):console.log("Spurious updateend event!")}},{key:"_onError",value:function(){var op=this._queue[0];if(op)if(this._sourceBuffer.updating)console.log("SourceBuffer should not be updating on updateend!");else{var code=this.mediaSource.error?this.mediaSource.error.code:0;op.p.reject(new Error("media source error: "+code))}else console.log("Spurious updateend event!")}},{key:"_adjustPlaySpeed",value:function(){if(0!=this._sourceBuffer.buffered.length){var player=this.players[0],end=this._sourceBuffer.buffered.end(0),currentTime=this.players[0].currentTime;1==player.playbackRate?currentTime<end-MSEBuffer.FAST_FORWARD_BEGIN_DURATION&&(player.playbackRate=1.5,console.log("begin fast forward readyState: ",player.readyState,"currentTime: ",currentTime,"buffer end",end)):player.playbackRate>1&&currentTime>=end-MSEBuffer.FAST_FORWARD_END_DURATION&&(player.playbackRate=1,console.log("end fast forward readyState: ",player.readyState,"currentTime: ",currentTime,"buffer end",end))}}},{key:"_opAppend",value:function(data){this._adjustPlaySpeed();try{this._sourceBuffer.appendBuffer(data)}catch(e){console.log("_opAppend aapendbuffere error ",e)}this._clearLiveBuffer()}},{key:"_opRemove",value:function(start,end){end<=start?this.onUpdateEnd_():(Log$4.debug("cleaing streaming buffer: ",start,end),this._sourceBuffer.remove(start,end))}},{key:"_opAbort",value:function(){var appendWindowStart=this._sourceBuffer.appendWindowStart,appendWindowEnd=this._sourceBuffer.appendWindowEnd;this._sourceBuffer.abort(),this._sourceBuffer.appendWindowStart=appendWindowStart,this._sourceBuffer.appendWindowEnd=appendWindowEnd,this._onUpdateEnd()}},{key:"_opFlush",value:function(){if(0!=this.mediaSource.buffered.length)throw new Error("flush_ should only be used after clearing all data!");this.mediaSource.currentTime-=.001,this._onUpdateEnd()}}],[{key:"LIVE_BUFFER_DURATION",get:function(){return 60}},{key:"FAST_FORWARD_END_DURATION",get:function(){return 3}},{key:"FAST_FORWARD_BEGIN_DURATION",get:function(){return 6}}]),MSEBuffer}(),MSE=function(){function MSE(players){classCallCheck(this,MSE),this.players=players;var playing=this.players.map(function(video,idx){return video.onplaying=function(){playing[idx]=!0},video.onpause=function(){playing[idx]=!1},!video.paused});this.playing=playing,this.mediaSource=new MediaSource,this.eventSource=new EventEmitter(this.mediaSource),this._reset()}return createClass(MSE,null,[{key:"isSupported",value:function(codecs){return window.MediaSource&&window.MediaSource.isTypeSupported('video/mp4; codecs="'+codecs.join(",")+'"')}},{key:"ErrorNotes",get:function(){var _ref;return defineProperty(_ref={},MediaError.MEDIA_ERR_ABORTED,"fetching process aborted by user"),defineProperty(_ref,MediaError.MEDIA_ERR_NETWORK,"error occurred when downloading"),defineProperty(_ref,MediaError.MEDIA_ERR_DECODE,"error occurred when decoding"),defineProperty(_ref,MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED,"audio/video not supported"),_ref}}]),createClass(MSE,[{key:"destroy",value:function(){this._reset(),this.eventSource.destroy(),this.mediaSource=null,this.eventSource=null}},{key:"play",value:function(){var _this2=this;this.players.forEach(function(video,idx){if(video.paused&&!_this2.playing[idx]){var p=video.play();void 0!==p&&p.catch(function(error){console.log("auto play disabled by browser: ",error)}).then(function(){Log$4.debug("player "+idx+": play")})}})}},{key:"setLive",value:function(is_live){for(var idx in this.buffers)this.buffers[idx].setLive(is_live);this.is_live=is_live}},{key:"_resetBuffers",value:function(){var _this3=this;this.players.forEach(function(video,idx){!video.paused&&_this3.playing[idx]&&(video.pause(),video.currentTime=0)});var promises=[];for(var idx in this.buffers)promises.push(this.buffers[idx].destroy());return 0==promises.length?Promise.resolve():(this.buffers={},Promise.all(promises).then(function(){"open"==_this3.mediaSource.readyState&&(_this3.mediaSource.duration=0,_this3.mediaSource.endOfStream())}))}},{key:"attachMediaSource",value:function(){var _this4=this;return this._resetBuffers().then(function(e){return Log$4.debug("source buffers reset."),_this4._reset(),_this4.players.forEach(function(video){video.src=URL.createObjectURL(_this4.mediaSource)}),_this4._setupEvents()})}},{key:"_setupEvents",value:function(){var _this5=this;return this.eventSource.clear(),this.resolved=!1,this.mediaReady=new Promise(function(resolve,reject){_this5._sourceOpen=function(){Log$4.debug("Media source opened: "+_this5.mediaSource.readyState),_this5.resolved||(_this5.resolved=!0,resolve())},_this5._sourceEnded=function(){Log$4.debug("Media source ended: "+_this5.mediaSource.readyState)},_this5._sourceClose=function(){Log$4.debug("Media source closed: "+_this5.mediaSource.readyState),_this5.resolved&&_this5.eventSource.dispatchEvent("sourceclosed")},_this5.eventSource.addEventListener("sourceopen",_this5._sourceOpen),_this5.eventSource.addEventListener("sourceended",_this5._sourceEnded),_this5.eventSource.addEventListener("sourceclose",_this5._sourceClose)}),this.mediaReady}},{key:"_reset",value:function(){this.ready=!1,this.resolved=!1,this.buffers={}}},{key:"setCodec",value:function(track,mimeCodec){var _this6=this;return this.mediaReady.then(function(){_this6.buffers[track]=new MSEBuffer(_this6,mimeCodec),_this6.buffers[track].setLive(_this6.is_live)})}},{key:"feed",value:function(track,data){var _this7=this;this.buffers[track]&&(Array.isArray(data)?data.forEach(function(e){_this7.buffers[track].appendBuffer(e)}):this.buffers[track].appendBuffer(data))}}]),MSE}(),Log$5=getTagged("remuxer:base"),track_id=1,BaseRemuxer=function(){function BaseRemuxer(timescale,scaleFactor,params){classCallCheck(this,BaseRemuxer),this.timeOffset=0,this.timescale=timescale,this.scaleFactor=scaleFactor,this.readyToDecode=!1,this.samples=[],this.seq=1,this.tsAlign=1}return createClass(BaseRemuxer,null,[{key:"getTrackID",value:function(){return track_id++}},{key:"MP4_TIMESCALE",get:function(){return 9e4}}]),createClass(BaseRemuxer,[{key:"scaled",value:function(timestamp){return timestamp/this.scaleFactor}},{key:"unscaled",value:function(timestamp){return timestamp*this.scaleFactor}},{key:"remux",value:function(unit){return!!unit&&(this.samples.push({unit:unit,pts:unit.pts,dts:unit.dts}),!0)}},{key:"setConfig",value:function(config){}},{key:"insertDscontinuity",value:function(){this.samples.push(null)}},{key:"init",value:function(initPTS,initDTS){var shouldInitialize=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this.initPTS=Math.min(initPTS,this.samples[0].dts),this.initDTS=Math.min(initDTS,this.samples[0].dts),Log$5.debug("Initial pts="+this.initPTS+" dts="+this.initDTS+" offset="+this.unscaled(this.timeOffset)),this.initialized=shouldInitialize}},{key:"flush",value:function(){this.seq++,this.mp4track.len=0,this.mp4track.samples=[]}},{key:"getPayloadBase",value:function(sampleFunction,setupSample){return!!(this.readyToDecode&&this.initialized&&this.samples.length)||null}},{key:"setOOBDataHandler",value:function(f){this._oobHandler=f}},{key:"sendOOBData",value:function(data){this._oobHandler&&this._oobHandler(data)}}],[{key:"toMS",value:function(timestamp){return timestamp/90}},{key:"dtsSortFunc",value:function(a,b){return a.dts-b.dts}}]),BaseRemuxer}(),Log$3=getTagged("remuxer:aac"),AACRemuxer=function(_BaseRemuxer){function AACRemuxer(timescale){var scaleFactor=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,params=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};classCallCheck(this,AACRemuxer);var _this=possibleConstructorReturn(this,(AACRemuxer.__proto__||Object.getPrototypeOf(AACRemuxer)).call(this,timescale,scaleFactor));return _this.codecstring=MSE.CODEC_AAC,_this.units=[],_this.initDTS=void 0,_this.nextAacPts=void 0,_this.lastPts=0,_this.firstDTS=0,_this.firstPTS=0,_this.duration=params.duration||0,_this.initialized=!1,_this.mp4track={id:BaseRemuxer.getTrackID(),type:"audio",fragmented:!0,channelCount:0,audiosamplerate:_this.timescale,duration:0,timescale:_this.timescale,volume:1,samples:[],config:"",len:0},params.config&&_this.setConfig(params.config),_this}return inherits(AACRemuxer,BaseRemuxer),createClass(AACRemuxer,[{key:"setConfig",value:function(config){this.mp4track.channelCount=config.channels,this.mp4track.audiosamplerate=config.samplerate,this.mp4track.duration||(this.mp4track.duration=(this.duration?this.duration:0)*config.samplerate),this.mp4track.timescale=config.samplerate,this.mp4track.config=config.config,this.mp4track.codec=config.codec,this.timescale=config.samplerate,this.scaleFactor=BaseRemuxer.MP4_TIMESCALE/config.samplerate,this.expectedSampleDuration=1024*this.scaleFactor,this.readyToDecode=!0}},{key:"remux",value:function(aac){get(AACRemuxer.prototype.__proto__||Object.getPrototypeOf(AACRemuxer.prototype),"remux",this).call(this,aac)&&(this.mp4track.len+=aac.getSize())}},{key:"getPayload",value:function(){if(!this.readyToDecode||!this.samples.length)return null;this.samples.sort(function(a,b){return a.dts-b.dts});for(var payload=new Uint8Array(this.mp4track.len),offset=0,samples=this.mp4track.samples,mp4Sample=void 0,lastDTS=void 0,pts=void 0,dts=void 0;this.samples.length;){var sample=this.samples.shift();if(null===sample){this.nextDts=void 0;break}var unit=sample.unit;if(pts=sample.pts-this.initDTS,dts=sample.dts-this.initDTS,void 0===lastDTS){if(this.nextDts){var delta=Math.round(this.scaled(pts-this.nextAacPts));if(Math.abs(delta)<600&&delta){if(delta>0)Log$3.log(delta+" ms hole between AAC samples detected,filling it");else if(delta<-12){Log$3.log(-delta+" ms overlapping between AAC samples detected, drop frame"),this.mp4track.len-=unit.getSize();continue}pts=dts=this.nextAacPts}}this.firstDTS=Math.max(0,dts)}mp4Sample={size:unit.getSize(),cts:0,duration:1024,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1}},payload.set(unit.getData(),offset),offset+=unit.getSize(),samples.push(mp4Sample),lastDTS=dts}return samples.length?(this.nextDts=pts+this.expectedSampleDuration,new Uint8Array(payload.buffer,0,this.mp4track.len)):null}}]),AACRemuxer}(),ExpGolomb=function(){function ExpGolomb(data){classCallCheck(this,ExpGolomb),this.data=data,this.bytesAvailable=this.data.byteLength,this.word=0,this.bitsAvailable=0}return createClass(ExpGolomb,[{key:"loadWord",value:function(){var position=this.data.byteLength-this.bytesAvailable,workingBytes=new Uint8Array(4),availableBytes=Math.min(4,this.bytesAvailable);if(0===availableBytes)throw new Error("no bytes available");workingBytes.set(this.data.subarray(position,position+availableBytes)),this.word=new DataView(workingBytes.buffer,workingBytes.byteOffset,workingBytes.byteLength).getUint32(0),this.bitsAvailable=8*availableBytes,this.bytesAvailable-=availableBytes}},{key:"skipBits",value:function(count){var skipBytes;this.bitsAvailable>count?(this.word<<=count,this.bitsAvailable-=count):(count-=this.bitsAvailable,count-=(skipBytes=count>>3)<<3,this.bytesAvailable-=skipBytes,this.loadWord(),this.word<<=count,this.bitsAvailable-=count)}},{key:"readBits",value:function(size){var bits=Math.min(this.bitsAvailable,size),valu=this.word>>>32-bits;return size>32&&Log.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=bits,this.bitsAvailable>0?this.word<<=bits:this.loadWord(),(bits=size-bits)>0?valu<<bits|this.readBits(bits):valu}},{key:"skipLZ",value:function(){var leadingZeroCount;for(leadingZeroCount=0;leadingZeroCount<this.bitsAvailable;++leadingZeroCount)if(0!=(this.word&2147483648>>>leadingZeroCount))return this.word<<=leadingZeroCount,this.bitsAvailable-=leadingZeroCount,leadingZeroCount;return this.loadWord(),leadingZeroCount+this.skipLZ()}},{key:"skipUEG",value:function(){this.skipBits(1+this.skipLZ())}},{key:"skipEG",value:function(){this.skipBits(1+this.skipLZ())}},{key:"readUEG",value:function(){var clz=this.skipLZ();return this.readBits(clz+1)-1}},{key:"readEG",value:function(){var valu=this.readUEG();return 1&valu?1+valu>>>1:-1*(valu>>>1)}},{key:"readBoolean",value:function(){return 1===this.readBits(1)}},{key:"readUByte",value:function(){return this.readBits(8)}},{key:"readUShort",value:function(){return this.readBits(16)}},{key:"readUInt",value:function(){return this.readBits(32)}}]),ExpGolomb}();function appendByteArray(buffer1,buffer2){var tmp=new Uint8Array((0|buffer1.byteLength)+(0|buffer2.byteLength));return tmp.set(buffer1,0),tmp.set(buffer2,0|buffer1.byteLength),tmp}function base64ToArrayBuffer(base64){for(var binary_string=window.atob(base64),len=binary_string.length,bytes=new Uint8Array(len),i=0;i<len;i++)bytes[i]=binary_string.charCodeAt(i);return bytes.buffer}function hexToByteArray(hex){for(var len=hex.length>>1,bufView=new Uint8Array(len),i=0;i<len;i++)bufView[i]=parseInt(hex.substr(i<<1,2),16);return bufView}function bitSlice(bytearray){for(var start=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,end=arguments.length>2&&void 0!==arguments[2]?arguments[2]:8*bytearray.byteLength,byteLen=Math.ceil((end-start)/8),res=new Uint8Array(byteLen),startByte=start>>>3,endByte=(end>>>3)-1,bitOffset=7&start,nBitOffset=8-bitOffset,endOffset=8-end&7,i=0;i<byteLen;++i){var tail=0;i<endByte&&(tail=bytearray[startByte+i+1]>>nBitOffset,i==endByte-1&&endOffset<8&&(tail>>=endOffset,tail<<=endOffset)),res[i]=bytearray[startByte+i]<<bitOffset|tail}return res}var BitArray=function(){function BitArray(src){classCallCheck(this,BitArray),this.src=new DataView(src.buffer,src.byteOffset,src.byteLength),this.bitpos=0,this.byte=this.src.getUint8(0),this.bytepos=0}return createClass(BitArray,[{key:"readBits",value:function(length){if(32<(0|length)||0==(0|length))throw new Error("too big");for(var result=0,i=length;i>0;--i)result=(0|result)<<1|(0|this.byte)>>8-++this.bitpos&1,(0|this.bitpos)>=8&&(this.byte=this.src.getUint8(++this.bytepos),this.bitpos&=7);return result}},{key:"skipBits",value:function(length){return this.bitpos+=7&(0|length),this.bytepos+=(0|length)>>>3,this.bitpos>7&&(this.bitpos&=7,++this.bytepos),this.finished()?this.bytepos-this.src.byteLength-this.src.bitpos:(this.byte=this.src.getUint8(this.bytepos),0)}},{key:"finished",value:function(){return this.bytepos>=this.src.byteLength}}]),BitArray}(),NALU=function(){function NALU(ntype,nri,data,dts,pts){classCallCheck(this,NALU),this.data=data,this.ntype=ntype,this.nri=nri,this.dts=dts,this.pts=pts||this.dts}return createClass(NALU,null,[{key:"type",value:function(nalu){return nalu.ntype in NALU.TYPES?NALU.TYPES[nalu.ntype]:"UNKNOWN"}},{key:"NDR",get:function(){return 1}},{key:"IDR",get:function(){return 5}},{key:"SEI",get:function(){return 6}},{key:"SPS",get:function(){return 7}},{key:"PPS",get:function(){return 8}},{key:"STAP_A",get:function(){return 24}},{key:"STAP_B",get:function(){return 25}},{key:"FU_A",get:function(){return 28}},{key:"FU_B",get:function(){return 29}},{key:"TYPES",get:function(){var _ref;return defineProperty(_ref={},NALU.IDR,"IDR"),defineProperty(_ref,NALU.SEI,"SEI"),defineProperty(_ref,NALU.SPS,"SPS"),defineProperty(_ref,NALU.PPS,"PPS"),defineProperty(_ref,NALU.NDR,"NDR"),_ref}}]),createClass(NALU,[{key:"appendData",value:function(idata){this.data=appendByteArray(this.data,idata)}},{key:"toString",value:function(){return NALU.type(this)+"("+this.data.byteLength+"): NRI: "+this.getNri()+", PTS: "+this.pts+", DTS: "+this.dts}},{key:"getNri",value:function(){return this.nri>>5}},{key:"type",value:function(){return this.ntype}},{key:"isSpsPps",value:function(){return this.ntype==NALU.SPS||this.ntype==NALU.PPS}},{key:"isKeyframe",value:function(){return this.ntype==NALU.IDR}},{key:"isDataType",value:function(){return this.ntype==NALU.SPS||this.ntype==NALU.PPS||this.ntype==NALU.NDR||this.ntype==NALU.IDR||this.ntype==NALU.SEI}},{key:"isSEI",value:function(){return this.ntype==NALU.SEI}},{key:"getSize",value:function(){return 5+this.data.byteLength}},{key:"getData",value:function(){var header=new Uint8Array(5+this.data.byteLength),view=new DataView(header.buffer);return view.setUint32(0,this.data.byteLength+1),view.setUint8(4,0|96&this.nri|31&this.ntype),header.set(this.data,5),header}},{key:"getRBSPData",value:function(){for(var length=this.data.byteLength,src=this.data,i=0;i+1<length;i+=2)if(0==src[i]&&(i>0&&0==src[i-1]&&i--,i+2<length&&0==src[i+1]&&src[i+2]<=3)){3!=src[i+2]&&0!=src[i+2]&&(length=i);break}if(i>=length-1)return this.data.slice(0,length);for(var buf=new ArrayBuffer(length),dst=new Uint8Array(buf),t=0;t<i;t++)dst[t]=src[t];for(var si=i,di=i;si+2<length;){if(src[si+2]>3)dst[di++]=src[si++],dst[di++]=src[si++];else if(0==src[si]&&0==src[si+1]&&0!=src[si+2]){if(3==src[si+2]){dst[di++]=0,dst[di++]=0,si+=3;continue}return new Uint8Array(buf,0,di)}dst[di++]=src[si++]}for(;si<length;)dst[di++]=src[si++];return new Uint8Array(buf,0,di)}}]),NALU}(),SEIMessage=function(){function SEIMessage(rbsp){classCallCheck(this,SEIMessage),this._rbsp=rbsp,this._parse()}return createClass(SEIMessage,null,[{key:"SEI_TYPE_USER_DATA_UNREGISTERED",get:function(){return 5}}]),createClass(SEIMessage,[{key:"_parse",value:function(){var decoder=new ExpGolomb(this._rbsp);this._payloadType=SEIMessage.readFFLongUint(decoder),this._payloadSize=SEIMessage.readFFLongUint(decoder),this._payload=new Uint8Array(this._payloadSize);for(var i=0;i<this._payloadSize;i++)this._payload[i]=decoder.readUByte()}},{key:"payloadType",get:function(){return this._payloadType}},{key:"payload",get:function(){return this._payload}},{key:"rbsp",get:function(){return this._rbsp}},{key:"payloadSize",get:function(){return this._payloadSize}}],[{key:"readFFLongUint",value:function(r){var v=0,b=0;for(b=r.readUByte();255===b;)v+=b,b=r.readUByte();return v+=b}}]),SEIMessage}(),H264Parser=function(){function H264Parser(remuxer){classCallCheck(this,H264Parser),this.remuxer=remuxer,this.track=remuxer.mp4track,this.seenIDR=!1,this.headerSPS=null,this.headerPPS=null}return createClass(H264Parser,[{key:"msToScaled",value:function(timestamp){return(timestamp-this.remuxer.timeOffset)*this.remuxer.scaleFactor}},{key:"setHeaderSPS",value:function(sps){this.headerSPS=sps}},{key:"setHeaderPPS",value:function(pps){this.headerPPS=pps}},{key:"parseSPS",value:function(sps){var config=H264Parser.readSPS(new Uint8Array(sps));this.track.width=config.width,this.track.height=config.height,this.track.sps=[new Uint8Array(sps)],this.track.codec="avc1.";for(var codecarray=new DataView(sps.buffer,sps.byteOffset+1,4),i=0;i<3;++i){var h=codecarray.getUint8(i).toString(16);h.length<2&&(h="0"+h),this.track.codec+=h}}},{key:"parsePPS",value:function(pps){this.track.pps=[new Uint8Array(pps)]}},{key:"checkReady",value:function(){!this.remuxer.readyToDecode&&this.track.pps&&this.track.sps&&(this.remuxer.readyToDecode=!0)}},{key:"parseNAL",value:function(unit){if(!unit)return!1;var push=!1,sprops=!1;switch(unit.type()){case NALU.NDR:push=this.seenIDR;break;case NALU.IDR:!this.track.pps&&this.headerPPS&&this.parsePPS(this.headerPPS),!this.track.sps&&this.headerSPS&&this.parseSPS(this.headerSPS),this.checkReady(),this.seenIDR=!0,push=!0;break;case NALU.PPS:this.track.pps||(this.parsePPS(unit.getData().subarray(4)),this.checkReady()),sprops=!0;break;case NALU.SPS:this.track.sps||(this.parseSPS(unit.getData().subarray(4)),this.checkReady()),sprops=!0;break;case NALU.SEI:}return unit.getNri()>0&&!sprops&&(push=!0),push}}],[{key:"skipScalingList",value:function(decoder,count){for(var lastScale=8,nextScale=8,j=0;j<count;j++)0!==nextScale&&(nextScale=(lastScale+decoder.readEG()+256)%256),lastScale=0===nextScale?lastScale:nextScale}},{key:"readSPS",value:function(data){var profileIdc,picWidthInMbsMinus1,picHeightInMapUnitsMinus1,frameMbsOnlyFlag,decoder=new ExpGolomb(data),frameCropLeftOffset=0,frameCropRightOffset=0,frameCropTopOffset=0,frameCropBottomOffset=0,sarScale=1,numRefFramesInPicOrderCntCycle=void 0,scalingListCount=void 0;if(decoder.readUByte(),profileIdc=decoder.readUByte(),decoder.readBits(5),decoder.skipBits(3),decoder.readUByte(),decoder.skipUEG(),100===profileIdc||110===profileIdc||122===profileIdc||244===profileIdc||44===profileIdc||83===profileIdc||86===profileIdc||118===profileIdc||128===profileIdc){var chromaFormatIdc=decoder.readUEG();if(3===chromaFormatIdc&&decoder.skipBits(1),decoder.skipUEG(),decoder.skipUEG(),decoder.skipBits(1),decoder.readBoolean()){scalingListCount=3!==chromaFormatIdc?8:12;for(var i=0;i<scalingListCount;++i)decoder.readBoolean()&&(i<6?H264Parser.skipScalingList(decoder,16):H264Parser.skipScalingList(decoder,64))}}decoder.skipUEG();var picOrderCntType=decoder.readUEG();if(0===picOrderCntType)decoder.readUEG();else if(1===picOrderCntType){decoder.skipBits(1),decoder.skipEG(),decoder.skipEG(),numRefFramesInPicOrderCntCycle=decoder.readUEG();for(var _i=0;_i<numRefFramesInPicOrderCntCycle;++_i)decoder.skipEG()}if(decoder.skipUEG(),decoder.skipBits(1),picWidthInMbsMinus1=decoder.readUEG(),picHeightInMapUnitsMinus1=decoder.readUEG(),0===(frameMbsOnlyFlag=decoder.readBits(1))&&decoder.skipBits(1),decoder.skipBits(1),decoder.readBoolean()&&(frameCropLeftOffset=decoder.readUEG(),frameCropRightOffset=decoder.readUEG(),frameCropTopOffset=decoder.readUEG(),frameCropBottomOffset=decoder.readUEG()),decoder.readBoolean()){if(decoder.readBoolean()){var sarRatio=void 0;switch(decoder.readUByte()){case 1:sarRatio=[1,1];break;case 2:sarRatio=[12,11];break;case 3:sarRatio=[10,11];break;case 4:sarRatio=[16,11];break;case 5:sarRatio=[40,33];break;case 6:sarRatio=[24,11];break;case 7:sarRatio=[20,11];break;case 8:sarRatio=[32,11];break;case 9:sarRatio=[80,33];break;case 10:sarRatio=[18,11];break;case 11:sarRatio=[15,11];break;case 12:sarRatio=[64,33];break;case 13:sarRatio=[160,99];break;case 14:sarRatio=[4,3];break;case 15:sarRatio=[3,2];break;case 16:sarRatio=[2,1];break;case 255:sarRatio=[decoder.readUByte()<<8|decoder.readUByte(),decoder.readUByte()<<8|decoder.readUByte()]}sarRatio&&(sarScale=sarRatio[0]/sarRatio[1])}if(decoder.readBoolean()&&decoder.skipBits(1),decoder.readBoolean()&&(decoder.skipBits(4),decoder.readBoolean()&&decoder.skipBits(24)),decoder.readBoolean()&&(decoder.skipUEG(),decoder.skipUEG()),decoder.readBoolean()){var unitsInTick=decoder.readUInt(),timeScale=decoder.readUInt(),fixedFrameRate=decoder.readBoolean(),frameDuration=timeScale/(2*unitsInTick);console.log("h264: timescale: "+timeScale+"; unitsInTick: "+unitsInTick+"; fixedFramerate: "+fixedFrameRate+"; avgFrameDuration: "+frameDuration)}}return{width:Math.ceil((16*(picWidthInMbsMinus1+1)-2*frameCropLeftOffset-2*frameCropRightOffset)*sarScale),height:(2-frameMbsOnlyFlag)*(picHeightInMapUnitsMinus1+1)*16-(frameMbsOnlyFlag?2:4)*(frameCropTopOffset+frameCropBottomOffset)}}},{key:"readSliceType",value:function(decoder){return decoder.readUByte(),decoder.readUEG(),decoder.readUEG()}}]),H264Parser}(),Log$6=getTagged("remuxer:h264"),H264Remuxer=function(_BaseRemuxer){function H264Remuxer(timescale){var scaleFactor=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,params=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};classCallCheck(this,H264Remuxer);var _this=possibleConstructorReturn(this,(H264Remuxer.__proto__||Object.getPrototypeOf(H264Remuxer)).call(this,timescale,scaleFactor));if(_this.nextDts=void 0,_this.readyToDecode=!1,_this.initialized=!1,_this.firstDTS=0,_this.firstPTS=0,_this.lastDTS=void 0,_this.lastSampleDuration=0,_this.lastDurations=[],_this.tsAlign=Math.round(_this.timescale/60),_this.mp4track={id:BaseRemuxer.getTrackID(),type:"video",len:0,fragmented:!0,sps:"",pps:"",width:0,height:0,timescale:timescale,duration:timescale,samples:[]},_this.samples=[],_this.lastGopDTS=-99999999999999,_this.gop=[],_this.foundIDR=!1,_this.offset=0,_this.h264=new H264Parser(_this),params.sps){var arr=new Uint8Array(params.sps);7==(31&arr[0])?_this.setSPS(arr):console.log("bad SPS in SDP")}if(params.pps){var _arr=new Uint8Array(params.pps);8==(31&_arr[0])?_this.setPPS(_arr):console.log("bad PPS in SDP")}return _this.mp4track.pps&&_this.mp4track.sps&&(_this.readyToDecode=!0),_this.lastFrame={pts:0,nalus:[]},_this}return inherits(H264Remuxer,BaseRemuxer),createClass(H264Remuxer,[{key:"_scaled",value:function(timestamp){return timestamp>>>this.scaleFactor}},{key:"_unscaled",value:function(timestamp){return timestamp<<this.scaleFactor}},{key:"setSPS",value:function(sps){this.h264.setHeaderSPS(sps)}},{key:"setPPS",value:function(pps){this.h264.setHeaderPPS(pps)}},{key:"remuxSEI",value:function(nalu){try{var sei=new SEIMessage(nalu.getRBSPData());if(sei.payload.length<=16)return;this.sendOOBData({codec:"h264",type:"sei",subtype:sei.payloadType,payload:sei.payload,dts:nalu.dts,pts:nalu.pts,scaledPTS:(nalu.pts+this.offset)/this.timescale,foundIDR:this.foundIDR})}catch(e){console.log("Bad SEI: ",nalu,e)}}},{key:"mergeNalus",value:function(nalus){if(0!=nalus.length){var newNalu=nalus[0],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=nalus.slice(1)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var nalu=_step.value;newNalu.appendData(appendByteArray(new Uint8Array([0,0,0,1]),nalu.getData().subarray(4)))}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return newNalu}}},{key:"remuxNalu",value:function(nalu){if(this.h264.parseNAL(nalu))if(nalu.pts!=this.lastFrame.pts){var newNalu=this.mergeNalus(this.lastFrame.nalus);if(newNalu&&this.gop.push(newNalu),this.lastFrame.pts=nalu.pts,this.lastFrame.nalus=[nalu],this.lastGopDTS<nalu.dts){var _iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=this.gop[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var unit=_step2.value;unit.ntype==NALU.IDR&&(this.foundIDR=!0),get(H264Remuxer.prototype.__proto__||Object.getPrototypeOf(H264Remuxer.prototype),"remux",this).call(this,unit)&&(this.mp4track.len+=unit.getSize())}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}this.gop=[],this.lastGopDTS=nalu.dts}}else this.lastFrame.nalus.push(nalu)}},{key:"remux",value:function(nalu){nalu.type()===NALU.SEI?this.remuxSEI(nalu):this.remuxNalu(nalu)}},{key:"getOffset",value:function(){return this.offset}},{key:"getPayload",value:function(){if(!this.getPayloadBase())return null;for(var payload=new Uint8Array(this.mp4track.len),offset=0,samples=this.mp4track.samples,mp4Sample=void 0,lastDTS=void 0,pts=void 0,dts=void 0;this.samples.length;){var sample=this.samples.shift();if(null===sample){this.nextDts=void 0;break}var unit=sample.unit;if(pts=sample.pts+this.offset,(dts=sample.dts+this.offset)<lastDTS&&(this.offset=this.offset+lastDTS-dts,pts=sample.pts+this.offset,dts=sample.dts+this.offset),void 0!==lastDTS){var sampleDuration=this.scaled(dts-lastDTS);if(sampleDuration<0){Log$6.log("invalid AVC sample duration at PTS/DTS: "+pts+"/"+dts+"|lastDTS: "+lastDTS+":"+sampleDuration),this.mp4track.len-=unit.getSize();continue}this.lastDurations.push(sampleDuration),this.lastDurations.length>100&&this.lastDurations.shift(),mp4Sample.duration=sampleDuration}else{if(this.nextDts){var delta=dts-this.nextDts;if(Math.abs(Math.round(BaseRemuxer.toMS(delta)))<600)delta&&(dts=this.nextDts,pts=Math.max(pts-delta,dts));else if(delta<0){Log$6.log("skip frame from the past at DTS="+dts+" with expected DTS="+this.nextDts),this.mp4track.len-=unit.getSize();continue}}this.firstDTS=Math.max(0,dts)}var flags=(mp4Sample={size:unit.getSize(),duration:0,cts:this.scaled(pts-dts),flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0}}).flags;!0===sample.unit.isKeyframe()?(flags.dependsOn=2,flags.isNonSync=0):(flags.dependsOn=1,flags.isNonSync=1),payload.set(unit.getData(),offset),offset+=unit.getSize(),samples.push(mp4Sample),lastDTS=dts}if(!samples.length)return null;var avgDuration=this.lastDurations.reduce(function(a,b){return(0|a)+(0|b)},0)/(this.lastDurations.length||1)|0;if(samples.length>=2?(this.lastSampleDuration=avgDuration,mp4Sample.duration=avgDuration):mp4Sample.duration=this.lastSampleDuration,samples.length&&(!this.nextDts||navigator.userAgent.toLowerCase().indexOf("chrome")>-1)){var _flags=samples[0].flags;_flags.dependsOn=2,_flags.isNonSync=0}return this.nextDts=dts+this.unscaled(this.lastSampleDuration),new Uint8Array(payload.buffer,0,this.mp4track.len)}}]),H264Remuxer}(),StreamType$1=function(){function StreamType(){classCallCheck(this,StreamType)}return createClass(StreamType,null,[{key:"VIDEO",get:function(){return 1}},{key:"AUDIO",get:function(){return 2}},{key:"map",get:function(){var _ref;return defineProperty(_ref={},StreamType.VIDEO,"video"),defineProperty(_ref,StreamType.AUDIO,"audio"),_ref}}]),StreamType}(),PayloadType=function(){function PayloadType(){classCallCheck(this,PayloadType)}return createClass(PayloadType,null,[{key:"H264",get:function(){return 1}},{key:"AAC",get:function(){return 2}},{key:"map",get:function(){var _ref2;return defineProperty(_ref2={},PayloadType.H264,"video"),defineProperty(_ref2,PayloadType.AAC,"audio"),_ref2}},{key:"string_map",get:function(){return{H264:PayloadType.H264,AAC:PayloadType.AAC,"MP4A-LATM":PayloadType.AAC,"MPEG4-GENERIC":PayloadType.AAC}}}]),PayloadType}(),AACParser=function(){function AACParser(){classCallCheck(this,AACParser)}return createClass(AACParser,null,[{key:"parseAudioSpecificConfig",value:function(bytesOrBits){var config=void 0,bitpos=(config=bytesOrBits.byteLength?new BitArray(bytesOrBits):bytesOrBits).bitpos+8*(config.src.byteOffset+config.bytepos),prof=config.readBits(5);this.codec="mp4a.40."+prof;var sfi=config.readBits(4);15==sfi&&config.skipBits(24);var channels=config.readBits(4);return{config:bitSlice(new Uint8Array(config.src.buffer),bitpos,bitpos+16),codec:"mp4a.40."+prof,samplerate:AACParser.SampleRates[sfi],channels:channels}}},{key:"parseStreamMuxConfig",value:function(bytes){var config=new BitArray(bytes);if(!config.readBits(1))return config.skipBits(14),AACParser.parseAudioSpecificConfig(config)}},{key:"SampleRates",get:function(){return[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350]}}]),AACParser}(),AACFrame=function(){function AACFrame(data,dts,pts){classCallCheck(this,AACFrame),this.dts=dts,this.pts=pts||this.dts,this.data=data}return createClass(AACFrame,[{key:"getData",value:function(){return this.data}},{key:"getSize",value:function(){return this.data.byteLength}}]),AACFrame}(),LOG_TAG="remuxer",Log$2=getTagged(LOG_TAG),_REMUXER_UNINITED=0,_REMUXER_INITILIZING=1,_REMUXER_RUNNING=2,_REMUXER_DESTROYED=3,Remuxer=function(){function Remuxer(mediaElement){var _this=this;classCallCheck(this,Remuxer),this.mse=new MSE([mediaElement]),this.eventSource=new EventEmitter,this.mseEventSource=new EventSourceWrapper(this.mse.eventSource),this._reset(),this.errorListener=this._mseClose.bind(this),this.closeListener=this._mseClose.bind(this),this.offset=0,this._initMSEHandlers(),this._oobBuffer=new CircularBuffer(1e3),this._oobHandler=function(data){_this._oobBuffer.size()==_this._oobBuffer.capacity()&&_this._oobBuffer.deq(),_this._oobBuffer.enq(data)}}return createClass(Remuxer,null,[{key:"TrackConverters",get:function(){var _ref;return defineProperty(_ref={},PayloadType.H264,H264Remuxer),defineProperty(_ref,PayloadType.AAC,AACRemuxer),_ref}},{key:"TrackScaleFactor",get:function(){var _ref2;return defineProperty(_ref2={},PayloadType.H264,1),defineProperty(_ref2,PayloadType.AAC,0),_ref2}},{key:"TrackTimescale",get:function(){var _ref3;return defineProperty(_ref3={},PayloadType.H264,9e4),defineProperty(_ref3,PayloadType.AAC,0),_ref3}}]),createClass(Remuxer,[{key:"pullOOBData",value:function(curPTS){for(var ev=[];this._oobBuffer.size();){if(curPTS<this._oobBuffer.get(this._oobBuffer.size()-1).scaledPTS)break;ev.push(this._oobBuffer.deq())}return ev}},{key:"_initMSEHandlers",value:function(){this.mseEventSource.on("error",this.errorListener),this.mseEventSource.on("sourceclosed",this.closeListener)}},{key:"_reset",value:function(){this.tracks={},this._status=_REMUXER_UNINITED,this.initSegments={},this.codecs=[],this.streams={},this.enabled=!1,this._silentDts=0,this._enableSilentAAC=!1,Log$2.debug("reset remuxer")}},{key:"destroy",value:function(){Log$2.debug("destroy remuxer"),this._status=_REMUXER_DESTROYED,this.mseEventSource.destroy(),this.mse.destroy(),this.mse=null,this.detachClient(),this.eventSource.destroy()}},{key:"_onTracks",value:function(tracks){Log$2.debug("tracks: ",tracks.detail);var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=tracks.detail[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var track=_step.value;this.tracks[track.type]=new Remuxer.TrackConverters[track.type](Remuxer.TrackTimescale[track.type],Remuxer.TrackScaleFactor[track.type],track.params),track.offset&&(this.tracks[track.type].timeOffset=track.offset),track.duration?(this.tracks[track.type].mp4track.duration=track.duration*(this.tracks[track.type].timescale||Remuxer.TrackTimescale[track.type]),this.tracks[track.type].duration=track.duration):this.tracks[track.type].duration=0,track.type===PayloadType.H264&&this.tracks[track.type].setOOBDataHandler(this._oobHandler)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}this._setupSilentAAC(),this.mse.setLive(!this.client.seekable)}},{key:"setTimeOffset",value:function(timeOffset,track){this.tracks[track.type]&&(this.tracks[track.type].timeOffset=timeOffset)}},{key:"_setupSilentAAC",value:function(){if(!this.tracks[PayloadType.AAC]){var params={config:AACParser.parseAudioSpecificConfig(new Uint8Array([18,16]))};Log$2.debug("adding silent AAC track: ",params),this.tracks[PayloadType.AAC]=new AACRemuxer(0,0,params),this._enableSilentAAC=!0}}},{key:"_init",value:function(){var _this2=this;return Log$2.debug("initializing remuxer"),this.mse.attachMediaSource().then(function(){return _this2._initAllCodecs()})}},{key:"_initAllCodecs",value:function(){var _this3=this;Log$2.debug("initialize all codecs");var tracks=[];this.codecs=[];var initmse=[];for(var track_type in this.tracks){var track=this.tracks[track_type];if(!MSE.isSupported([track.mp4track.codec]))throw new Error(track.mp4track.type+" codec "+track.mp4track.codec+" is not supported");tracks.push(track.mp4track),this.codecs.push(track.mp4track.codec),track.init(1/0,1/0)}for(var _track_type in this.tracks){var _track=this.tracks[_track_type];this.initSegments[_track_type]=MP4.initSegment([_track.mp4track],_track.duration*_track.timescale,_track.timescale),initmse.push(this._initCodec(_track_type,_track.mp4track.codec))}return Promise.all(initmse).then(function(){_this3.enabled=!0,_this3._status=_REMUXER_RUNNING})}},{key:"_initCodec",value:function(track_type,codec){var _this4=this;if(MSE.isSupported(this.codecs))return this.mse.setCodec(track_type,PayloadType.map[track_type]+'/mp4; codecs="'+codec+'"').then(function(){_this4.mse.feed(track_type,_this4.initSegments[track_type])});throw new Error("Codecs are not supported")}},{key:"_mseClose",value:function(){this.client.stop(),this.eventSource.dispatchEvent("stopped")}},{key:"flush",value:function(){switch(this._status){case _REMUXER_UNINITED:if(this._onSamples(),Object.keys(this.tracks).length){for(var track_type in this.tracks)if(!this.tracks[track_type].readyToDecode||!this.tracks[track_type].samples.length)return;this._status=_REMUXER_INITILIZING,this._init()}return;case _REMUXER_INITILIZING:return;case _REMUXER_RUNNING:this._onSamples();for(var _track_type2 in this.tracks){var track=this.tracks[_track_type2],pay=track.getPayload();pay&&pay.byteLength&&(this.mse.feed(_track_type2,[MP4.moof(track.seq,track.scaled(track.firstDTS),track.mp4track),MP4.mdat(pay)]),track.flush())}return;case _REMUXER_DESTROYED:return}}},{key:"_remuxSilentAAC",value:function(dts){if(this.tracks[PayloadType.AAC]&&this._enableSilentAAC)for(var sampleDuration=this.tracks[PayloadType.AAC].expectedSampleDuration;this._silentDts<dts+2*sampleDuration;){var silent=new Uint8Array([33,0,73,144,2,25,0,35,128]);this.tracks[PayloadType.AAC].remux(new AACFrame(silent,this._silentDts)),this._silentDts+=sampleDuration}}},{key:"_onSamples",value:function(ev){for(var qidx in this.client.sampleQueues)for(var queue=this.client.sampleQueues[qidx];queue.length;){var units=queue.shift(),_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=units[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var chunk=_step2.value;void 0!=chunk.isSEI&&(this.tracks[qidx].remux(chunk),this.offset=this.tracks[qidx].getOffset()),void 0==chunk.isSEI||chunk.isSEI()||this._remuxSilentAAC(chunk.dts+this.offset)}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}}}},{key:"attachClient",value:function(client){this.detachClient(),this.client=client,this.clientEventSource=new EventSourceWrapper(this.client.eventSource),this.clientEventSource.on("tracks",this._onTracks.bind(this)),this.clientEventSource.on("flush",this.flush.bind(this)),this.clientEventSource.on("reconnected",this._reset.bind(this))}},{key:"detachClient",value:function(){this.client&&(this.clientEventSource.destroy(),this.client=null)}}]),Remuxer}(),State=function(){function State(name,stateMachine){classCallCheck(this,State),this.stateMachine=stateMachine,this.transitions=new Set,this.name=name}return createClass(State,[{key:"activate",value:function(){return Promise.resolve(null)}},{key:"finishTransition",value:function(){}},{key:"failHandler",value:function(){}},{key:"deactivate",value:function(){return Promise.resolve(null)}}]),State}(),StateMachine=function(){function StateMachine(){classCallCheck(this,StateMachine),this.storage={},this.currentState=null,this.states=new Map}return createClass(StateMachine,[{key:"addState",value:function(name,_ref){var activate=_ref.activate,finishTransition=_ref.finishTransition,deactivate=_ref.deactivate,state=new State(name,this);return activate&&(state.activate=activate),finishTransition&&(state.finishTransition=finishTransition),deactivate&&(state.deactivate=deactivate),this.states.set(name,state),this}},{key:"addTransition",value:function(fromName,toName){if(!this.states.has(fromName))throw ReferenceError("No such state: "+fromName+" while connecting to "+toName);if(!this.states.has(toName))throw ReferenceError("No such state: "+toName+" while connecting from "+fromName);return this.states.get(fromName).transitions.add(toName),this}},{key:"_promisify",value:function(res){var promise=void 0;try{(promise=res).then||(promise=Promise.resolve(promise))}catch(e){promise=Promise.reject(e)}return promise}},{key:"transitionTo",value:function(stateName){var _this=this;if(null==this.currentState){var state=this.states.get(stateName);return this._promisify(state.activate.call(this)).then(function(data){return _this.currentState=state,data}).then(state.finishTransition.bind(this)).catch(function(e){throw state.failHandler(),e})}if(this.currentState.name==stateName)return Promise.resolve();if(this.currentState.transitions.has(stateName)){var _state=this.states.get(stateName);return this._promisify(_state.deactivate.call(this)).then(_state.activate.bind(this)).then(function(data){return _this.currentState=_state,data}).then(_state.finishTransition.bind(this)).catch(function(e){throw _state.failHandler(),e})}return Promise.reject("No such transition: "+this.currentState.name+" to "+stateName)}}]),StateMachine}(),Log$8=getTagged("parser:sdp"),SDPParser=function(){function SDPParser(){classCallCheck(this,SDPParser),this.version=-1,this.origin=null,this.sessionName=null,this.timing=null,this.sessionBlock={},this.media={},this.tracks={},this.mediaMap={}}return createClass(SDPParser,[{key:"parse",value:function(content){var _this=this;return Log$8.debug(content),new Promise(function(resolve,reject){var dataString=content,success=!0,currentMediaBlock=_this.sessionBlock,_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=dataString.split("\n")[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var line=_step.value;if(0!==(line=line.replace(/\r/,"")).length){switch(line.charAt(0)){case"v":if(-1!==_this.version)return Log$8.log("Version present multiple times in SDP"),reject(),!1;success=success&&_this._parseVersion(line);break;case"o":if(null!==_this.origin)return Log$8.log("Origin present multiple times in SDP"),reject(),!1;success=success&&_this._parseOrigin(line);break;case"s":if(null!==_this.sessionName)return Log$8.log("Session Name present multiple times in SDP"),reject(),!1;success=success&&_this._parseSessionName(line);break;case"t":if(null!==_this.timing)return Log$8.log("Timing present multiple times in SDP"),reject(),!1;success=success&&_this._parseTiming(line);break;case"m":null!==currentMediaBlock&&_this.sessionBlock!==currentMediaBlock&&(_this.media[currentMediaBlock.type]=currentMediaBlock),(currentMediaBlock={}).rtpmap={},_this._parseMediaDescription(line,currentMediaBlock);break;case"a":SDPParser._parseAttribute(line,currentMediaBlock);break;default:Log$8.log("Ignored unknown SDP directive: "+line)}if(!success)return void reject()}}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}_this.media[currentMediaBlock.type]=currentMediaBlock,success?resolve():reject()})}},{key:"_parseVersion",value:function(line){var matches=line.match(/^v=([0-9]+)$/);return matches&&matches.length?(this.version=matches[1],0==this.version||(Log$8.log("Unsupported SDP version:"+this.version),!1)):(Log$8.log("'v=' (Version) formatted incorrectly: "+line),!1)}},{key:"_parseOrigin",value:function(line){var matches=line.match(/^o=([^ ]+) (-?[0-9]+) (-?[0-9]+) (IN) (IP4|IP6) ([^ ]+)$/);return matches&&matches.length?(this.origin={},this.origin.username=matches[1],this.origin.sessionid=matches[2],this.origin.sessionversion=matches[3],this.origin.nettype=matches[4],this.origin.addresstype=matches[5],this.origin.unicastaddress=matches[6],!0):(Log$8.log("'o=' (Origin) formatted incorrectly: "+line),this.origin={},!0)}},{key:"_parseSessionName",value:function(line){var matches=line.match(/^s=([^\r\n]+)$/);return matches&&matches.length?(this.sessionName=matches[1],!0):(Log$8.log("'s=' (Session Name) formatted incorrectly: "+line),!1)}},{key:"_parseTiming",value:function(line){var matches=line.match(/^t=([0-9]+) ([0-9]+)$/);return matches&&matches.length?(this.timing={},this.timing.start=matches[1],this.timing.stop=matches[2],!0):(Log$8.log("'t=' (Timing) formatted incorrectly: "+line),!1)}},{key:"_parseMediaDescription",value:function(line,media){var matches=line.match(/^m=([^ ]+) ([^ ]+) ([^ ]+)[ ]/);if(!matches||!matches.length)return Log$8.log("'m=' (Media) formatted incorrectly: "+line),!1;media.type=matches[1],media.port=matches[2],media.proto=matches[3],media.fmt=line.substr(matches[0].length).split(" ").map(function(fmt,index,array){return parseInt(fmt)});var _iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=media.fmt[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var fmt=_step2.value;this.mediaMap[fmt]=media}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return!0}},{key:"getSessionBlock",value:function(){return this.sessionBlock}},{key:"hasMedia",value:function(mediaType){return void 0!=this.media[mediaType]}},{key:"getMediaBlock",value:function(mediaType){return this.media[mediaType]}},{key:"getMediaBlockByPayloadType",value:function(pt){return this.mediaMap[pt]||null}},{key:"getMediaBlockList",value:function(){var res=[];for(var m in this.media)res.push(m);return res}}],[{key:"_parseAttribute",value:function(line,media){if(null===media)return!0;var matches,separator=line.indexOf(":");switch(line.substr(0,-1===separator?2147483647:separator)){case"a=recvonly":case"a=sendrecv":case"a=sendonly":case"a=inactive":media.mode=line.substr("a=".length);break;case"a=range":matches=line.match(/^a=range:\s*([a-zA-Z-]+)=([0-9.]+|now)\s*-\s*([0-9.]*)$/),media.range=[Number("now"==matches[2]?-1:matches[2]),Number(matches[3]),matches[1]];break;case"a=control":media.control=line.substr("a=control:".length);break;case"a=rtpmap":if(null===(matches=line.match(/^a=rtpmap:(\d+) (.*)$/)))return Log$8.log("Could not parse 'rtpmap' of 'a='"),!1;var payload=parseInt(matches[1]);media.rtpmap[payload]={};var attrs=matches[2].split("/");media.rtpmap[payload].name=attrs[0].toUpperCase(),media.rtpmap[payload].clock=attrs[1],void 0!==attrs[2]&&(media.rtpmap[payload].encparams=attrs[2]);var ptype=PayloadType.string_map[attrs[0].toUpperCase()];ptype&&(media.ptype=ptype);break;case"a=fmtp":if(0===(matches=line.match(/^a=fmtp:(\d+) (.*)$/)).length)return Log$8.log("Could not parse 'fmtp'  of 'a='"),!1;media.fmtp={};var _iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _step3,_iterator3=matches[2].split(";")[Symbol.iterator]();!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=!0){var param=_step3.value,idx=param.indexOf("=");media.fmtp[param.substr(0,idx).toLowerCase().trim()]=param.substr(idx+1).trim()}}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3.return&&_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}}}return!0}}]),SDPParser}();function safeAdd(x,y){var lsw=(65535&x)+(65535&y);return(x>>16)+(y>>16)+(lsw>>16)<<16|65535&lsw}function bitRotateLeft(num,cnt){return num<<cnt|num>>>32-cnt}function md5cmn(q,a,b,x,s,t){return safeAdd(bitRotateLeft(safeAdd(safeAdd(a,q),safeAdd(x,t)),s),b)}function md5ff(a,b,c,d,x,s,t){return md5cmn(b&c|~b&d,a,b,x,s,t)}function md5gg(a,b,c,d,x,s,t){return md5cmn(b&d|c&~d,a,b,x,s,t)}function md5hh(a,b,c,d,x,s,t){return md5cmn(b^c^d,a,b,x,s,t)}function md5ii(a,b,c,d,x,s,t){return md5cmn(c^(b|~d),a,b,x,s,t)}function binlMD5(x,len){var i,olda,oldb,oldc,oldd;x[len>>5]|=128<<len%32,x[14+(len+64>>>9<<4)]=len;var a=1732584193,b=-271733879,c=-1732584194,d=271733878;for(i=0;i<x.length;i+=16)olda=a,oldb=b,oldc=c,oldd=d,b=md5ii(b=md5ii(b=md5ii(b=md5ii(b=md5hh(b=md5hh(b=md5hh(b=md5hh(b=md5gg(b=md5gg(b=md5gg(b=md5gg(b=md5ff(b=md5ff(b=md5ff(b=md5ff(b,c=md5ff(c,d=md5ff(d,a=md5ff(a,b,c,d,x[i],7,-680876936),b,c,x[i+1],12,-389564586),a,b,x[i+2],17,606105819),d,a,x[i+3],22,-1044525330),c=md5ff(c,d=md5ff(d,a=md5ff(a,b,c,d,x[i+4],7,-176418897),b,c,x[i+5],12,1200080426),a,b,x[i+6],17,-1473231341),d,a,x[i+7],22,-45705983),c=md5ff(c,d=md5ff(d,a=md5ff(a,b,c,d,x[i+8],7,1770035416),b,c,x[i+9],12,-1958414417),a,b,x[i+10],17,-42063),d,a,x[i+11],22,-1990404162),c=md5ff(c,d=md5ff(d,a=md5ff(a,b,c,d,x[i+12],7,1804603682),b,c,x[i+13],12,-40341101),a,b,x[i+14],17,-1502002290),d,a,x[i+15],22,1236535329),c=md5gg(c,d=md5gg(d,a=md5gg(a,b,c,d,x[i+1],5,-165796510),b,c,x[i+6],9,-1069501632),a,b,x[i+11],14,643717713),d,a,x[i],20,-373897302),c=md5gg(c,d=md5gg(d,a=md5gg(a,b,c,d,x[i+5],5,-701558691),b,c,x[i+10],9,38016083),a,b,x[i+15],14,-660478335),d,a,x[i+4],20,-405537848),c=md5gg(c,d=md5gg(d,a=md5gg(a,b,c,d,x[i+9],5,568446438),b,c,x[i+14],9,-1019803690),a,b,x[i+3],14,-187363961),d,a,x[i+8],20,1163531501),c=md5gg(c,d=md5gg(d,a=md5gg(a,b,c,d,x[i+13],5,-1444681467),b,c,x[i+2],9,-51403784),a,b,x[i+7],14,1735328473),d,a,x[i+12],20,-1926607734),c=md5hh(c,d=md5hh(d,a=md5hh(a,b,c,d,x[i+5],4,-378558),b,c,x[i+8],11,-2022574463),a,b,x[i+11],16,1839030562),d,a,x[i+14],23,-35309556),c=md5hh(c,d=md5hh(d,a=md5hh(a,b,c,d,x[i+1],4,-1530992060),b,c,x[i+4],11,1272893353),a,b,x[i+7],16,-155497632),d,a,x[i+10],23,-1094730640),c=md5hh(c,d=md5hh(d,a=md5hh(a,b,c,d,x[i+13],4,681279174),b,c,x[i],11,-358537222),a,b,x[i+3],16,-722521979),d,a,x[i+6],23,76029189),c=md5hh(c,d=md5hh(d,a=md5hh(a,b,c,d,x[i+9],4,-640364487),b,c,x[i+12],11,-421815835),a,b,x[i+15],16,530742520),d,a,x[i+2],23,-995338651),c=md5ii(c,d=md5ii(d,a=md5ii(a,b,c,d,x[i],6,-198630844),b,c,x[i+7],10,1126891415),a,b,x[i+14],15,-1416354905),d,a,x[i+5],21,-57434055),c=md5ii(c,d=md5ii(d,a=md5ii(a,b,c,d,x[i+12],6,1700485571),b,c,x[i+3],10,-1894986606),a,b,x[i+10],15,-1051523),d,a,x[i+1],21,-2054922799),c=md5ii(c,d=md5ii(d,a=md5ii(a,b,c,d,x[i+8],6,1873313359),b,c,x[i+15],10,-30611744),a,b,x[i+6],15,-1560198380),d,a,x[i+13],21,1309151649),c=md5ii(c,d=md5ii(d,a=md5ii(a,b,c,d,x[i+4],6,-145523070),b,c,x[i+11],10,-1120210379),a,b,x[i+2],15,718787259),d,a,x[i+9],21,-343485551),a=safeAdd(a,olda),b=safeAdd(b,oldb),c=safeAdd(c,oldc),d=safeAdd(d,oldd);return[a,b,c,d]}function binl2rstr(input){var i,output="",length32=32*input.length;for(i=0;i<length32;i+=8)output+=String.fromCharCode(input[i>>5]>>>i%32&255);return output}function rstr2binl(input){var i,output=[];for(output[(input.length>>2)-1]=void 0,i=0;i<output.length;i+=1)output[i]=0;var length8=8*input.length;for(i=0;i<length8;i+=8)output[i>>5]|=(255&input.charCodeAt(i/8))<<i%32;return output}function rstrMD5(s){return binl2rstr(binlMD5(rstr2binl(s),8*s.length))}function rstrHMACMD5(key,data){var i,hash,bkey=rstr2binl(key),ipad=[],opad=[];for(ipad[15]=opad[15]=void 0,bkey.length>16&&(bkey=binlMD5(bkey,8*key.length)),i=0;i<16;i+=1)ipad[i]=909522486^bkey[i],opad[i]=1549556828^bkey[i];return hash=binlMD5(ipad.concat(rstr2binl(data)),512+8*data.length),binl2rstr(binlMD5(opad.concat(hash),640))}function rstr2hex(input){var x,i,output="";for(i=0;i<input.length;i+=1)x=input.charCodeAt(i),output+="0123456789abcdef".charAt(x>>>4&15)+"0123456789abcdef".charAt(15&x);return output}function str2rstrUTF8(input){return unescape(encodeURIComponent(input))}function rawMD5(s){return rstrMD5(str2rstrUTF8(s))}function hexMD5(s){return rstr2hex(rawMD5(s))}function rawHMACMD5(k,d){return rstrHMACMD5(str2rstrUTF8(k),str2rstrUTF8(d))}function hexHMACMD5(k,d){return rstr2hex(rawHMACMD5(k,d))}function md5(string,key,raw){return key?raw?rawHMACMD5(key,string):hexHMACMD5(key,string):raw?rawMD5(string):hexMD5(string)}var RTP=function(){function RTP(pkt,sdp){classCallCheck(this,RTP);var bytes=new DataView(pkt.buffer,pkt.byteOffset,pkt.byteLength);this.version=bytes.getUint8(0)>>>6,this.padding=32&bytes.getUint8(0),this.has_extension=16&bytes.getUint8(0),this.csrc=15&bytes.getUint8(0),this.marker=bytes.getUint8(1)>>>7,this.pt=127&bytes.getUint8(1),this.sequence=bytes.getUint16(2),this.timestamp=bytes.getUint32(4),this.ssrc=bytes.getUint32(8),this.csrcs=[];var pktIndex=12;this.csrc>0&&(this.csrcs.push(bytes.getUint32(pktIndex)),pktIndex+=4),this.has_extension>0&&(this.extension=bytes.getUint16(pktIndex),this.ehl=4*bytes.getUint16(pktIndex+2),pktIndex+=4,this.header_data=pkt.slice(pktIndex,this.ehl),pktIndex+=this.ehl),this.headerLength=pktIndex;this.padding>0&&bytes.getUint8(pkt.byteLength-1),this.media=sdp.getMediaBlockByPayloadType(this.pt),null===this.media?Log.log("Media description for payload type: "+this.pt+" not provided."):this.type=this.media.ptype,this.data=pkt.subarray(pktIndex)}return createClass(RTP,[{key:"getPayload",value:function(){return this.data}},{key:"getTimestampMS",value:function(){return this.timestamp}},{key:"toString",value:function(){return"RTP(version:"+this.version+", padding:"+this.padding+", has_extension:"+this.has_extension+", csrc:"+this.csrc+", marker:"+this.marker+", pt:"+this.pt+", sequence:"+this.sequence+", timestamp:"+this.timestamp+", ssrc:"+this.ssrc+")"}},{key:"isVideo",value:function(){return"video"==this.media.type}},{key:"isAudio",value:function(){return"audio"==this.media.type}}]),RTP}(),RTSPMessage=function(){function RTSPMessage(_rtsp_version){classCallCheck(this,RTSPMessage),this.version=_rtsp_version}return createClass(RTSPMessage,null,[{key:"RTSP_1_0",get:function(){return"RTSP/1.0"}}]),createClass(RTSPMessage,[{key:"build",value:function(_cmd,_host){var _params=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},_payload=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,requestString=_cmd+" "+_host+" "+this.version+"\r\n";for(var param in _params)requestString+=param+": "+_params[param]+"\r\n";return _payload&&(requestString+="Content-Length: "+_payload.length+"\r\n"),requestString+="\r\n",_payload&&(requestString+=_payload),requestString}},{key:"parse",value:function(_data){var lines=_data.split("\r\n"),parsed={headers:{},body:null,code:0,statusLine:""},_lines$0$match=lines[0].match(new RegExp(this.version+"[ ]+([0-9]{3})[ ]+(.*)")),_lines$0$match2=slicedToArray(_lines$0$match,3);_lines$0$match2[0],parsed.code=_lines$0$match2[1],parsed.statusLine=_lines$0$match2[2],parsed.code=Number(parsed.code);for(var lineIdx=1;lines[lineIdx];){var _lines$lineIdx$split=lines[lineIdx].split(/:(.+)/),_lines$lineIdx$split2=slicedToArray(_lines$lineIdx$split,2),k=_lines$lineIdx$split2[0],v=_lines$lineIdx$split2[1];parsed.headers[k.toLowerCase()]=v.trim(),lineIdx++}return parsed.body=lines.slice(lineIdx).join("\n\r"),parsed}}]),RTSPMessage}(),MessageBuilder=new RTSPMessage(RTSPMessage.RTSP_1_0),NALUAsm=function(){function NALUAsm(){classCallCheck(this,NALUAsm),this.fragmented_nalu=null}return createClass(NALUAsm,[{key:"parseSingleNALUPacket",value:function(rawData,header,dts,pts){return new NALU(header.type,header.nri,rawData.subarray(0),dts,pts)}},{key:"parseAggregationPacket",value:function(rawData,header,dts,pts){var data=new DataView(rawData.buffer,rawData.byteOffset,rawData.byteLength),nal_start_idx=0;NALU.STAP_B===header.type&&(data.getUint16(nal_start_idx),nal_start_idx+=2);for(var ret=[];nal_start_idx<data.byteLength;){var size=data.getUint16(nal_start_idx);nal_start_idx+=2;var _header=NALUAsm.parseNALHeader(data.getInt8(nal_start_idx));nal_start_idx++;var nalu=this.parseSingleNALUPacket(rawData.subarray(nal_start_idx,nal_start_idx+size),_header,dts,pts);null!==nalu&&ret.push(nalu),nal_start_idx+=size}return ret}},{key:"parseFragmentationUnit",value:function(rawData,header,dts,pts){var data=new DataView(rawData.buffer,rawData.byteOffset,rawData.byteLength),nal_start_idx=0,fu_header=data.getUint8(nal_start_idx),is_start=(128&fu_header)>>>7,is_end=(64&fu_header)>>>6,payload_type=31&fu_header,ret=null;nal_start_idx++;return NALU.FU_B===header.type&&(data.getUint16(nal_start_idx),nal_start_idx+=2),is_start&&(this.fragmented_nalu=new NALU(payload_type,header.nri,rawData.subarray(nal_start_idx),dts,pts)),this.fragmented_nalu&&this.fragmented_nalu.ntype===payload_type&&(is_start||this.fragmented_nalu.appendData(rawData.subarray(nal_start_idx)),is_end)?(ret=this.fragmented_nalu,this.fragmented_nalu=null,ret):null}},{key:"onNALUFragment",value:function(rawData,dts,pts){var data=new DataView(rawData.buffer,rawData.byteOffset,rawData.byteLength),header=NALUAsm.parseNALHeader(data.getUint8(0)),unit=null;if(header.type>0&&header.type<24)unit=this.parseSingleNALUPacket(rawData.subarray(1),header,dts,pts);else{if(NALU.FU_A!==header.type&&NALU.FU_B!==header.type)return NALU.STAP_A===header.type||NALU.STAP_B===header.type?this.parseAggregationPacket(rawData.subarray(1),header,dts,pts):(Log.log("Undefined NAL unit, type: "+header.type),null);unit=this.parseFragmentationUnit(rawData.subarray(1),header,dts,pts)}return unit?[unit]:null}}],[{key:"parseNALHeader",value:function(hdr){return{nri:96&hdr,type:31&hdr}}}]),NALUAsm}(),AACAsm=function(){function AACAsm(){classCallCheck(this,AACAsm),this.config=null}return createClass(AACAsm,[{key:"onAACFragment",value:function(pkt){var rawData=pkt.getPayload();if(!pkt.media)return null;var data=new DataView(rawData.buffer,rawData.byteOffset,rawData.byteLength),sizeLength=Number(pkt.media.fmtp.sizelength||0),indexLength=Number(pkt.media.fmtp.indexlength||0),indexDeltaLength=Number(pkt.media.fmtp.indexdeltalength||0),CTSDeltaLength=Number(pkt.media.fmtp.ctsdeltalength||0),DTSDeltaLength=Number(pkt.media.fmtp.dtsdeltalength||0),RandomAccessIndication=Number(pkt.media.fmtp.randomaccessindication||0),StreamStateIndication=Number(pkt.media.fmtp.streamstateindication||0),AuxiliaryDataSizeLength=Number(pkt.media.fmtp.auxiliarydatasizelength||0),configHeaderLength=sizeLength+Math.max(indexLength,indexDeltaLength)+CTSDeltaLength+DTSDeltaLength+RandomAccessIndication+StreamStateIndication+AuxiliaryDataSizeLength,auHeadersLengthPadded=0,offset=0,ts=9e4*(Math.round(pkt.getTimestampMS()/1024)<<10)/this.config.samplerate;if(0!==configHeaderLength){var auHeadersLengthInBits=data.getUint16(0);auHeadersLengthPadded=2+(auHeadersLengthInBits>>>3)+(7&auHeadersLengthInBits?1:0);for(var frames=[],frameOffset=0,bits=new BitArray(rawData.subarray(2+offset)),cts=0,dts=0,_offset=0;_offset<auHeadersLengthInBits;){var size=bits.readBits(sizeLength);bits.readBits(_offset?indexDeltaLength:indexLength);if(_offset+=sizeLength+(_offset?indexDeltaLength:indexLength),CTSDeltaLength){bits.readBits(1);cts=bits.readBits(CTSDeltaLength),_offset+=CTSDeltaLength}if(DTSDeltaLength){bits.readBits(1);dts=bits.readBits(DTSDeltaLength),_offset+=CTSDeltaLength}RandomAccessIndication&&(bits.skipBits(1),_offset+=1),StreamStateIndication&&(bits.skipBits(StreamStateIndication),_offset+=StreamStateIndication),frames.push(new AACFrame(rawData.subarray(auHeadersLengthPadded+frameOffset,auHeadersLengthPadded+frameOffset+size),ts+dts,ts+cts)),frameOffset+=size}return frames}for(var aacData=rawData.subarray(auHeadersLengthPadded);255==aacData[offset];)++offset;return++offset,[new AACFrame(rawData.subarray(auHeadersLengthPadded+offset),ts)]}}]),AACAsm}(),H264_TIMESCALE=9e4,RTPPayloadParser=function(){function RTPPayloadParser(){classCallCheck(this,RTPPayloadParser),this.h264parser=new RTPH264Parser,this.aacparser=new RTPAACParser}return createClass(RTPPayloadParser,[{key:"parse",value:function(rtp){return"video"==rtp.media.type?this.h264parser.parse(rtp):"audio"==rtp.media.type?this.aacparser.parse(rtp):null}}]),RTPPayloadParser}(),DtsGenerator=function(){function DtsGenerator(){classCallCheck(this,DtsGenerator),this.queue=[0,0,0,0],this.last_pts=void 0,this.last_dts=void 0}return createClass(DtsGenerator,[{key:"getDtsWithPts",value:function(pts){if(pts<this.last_dts)return this.last_dts;for(var index=0;index<this.queue.length;index++){if(pts<this.queue[index])break}this.queue.splice(index,0,pts);var dts=this.queue.shift();return this.last_pts=pts,this.last_dts=dts,dts}}]),DtsGenerator}(),RtpTimestampHandler=function(){function RtpTimestampHandler(){classCallCheck(this,RtpTimestampHandler),this.offset=0,this.last_timestamp=void 0,this.first_timestamp=void 0}return createClass(RtpTimestampHandler,[{key:"checkOverflow",value:function(timestamp){void 0===this.last_timestamp&&(this.last_timestamp=timestamp),Math.abs(timestamp-this.last_timestamp)>2147483647&&(this.offset+=4294967295,console.log("check overflow, last_timestamp: ",this.last_timestamp," timestamp: ",timestamp," offset: ",this.offset)),Math.abs(timestamp-this.last_timestamp)>H264_TIMESCALE&&console.log("warning diff too large pts:",timestamp," < last_pts:",this.last_timestamp),this.last_timestamp=timestamp}},{key:"adjust",value:function(timestamp){return timestamp+=this.offset,void 0===this.first_timestamp&&(this.first_timestamp=timestamp),timestamp-this.first_timestamp}}]),RtpTimestampHandler}(),RTPH264Parser=function(){function RTPH264Parser(){classCallCheck(this,RTPH264Parser),this.naluasm=new NALUAsm,this.dtsGenerator=new DtsGenerator,this.rtpTimestampHandler=new RtpTimestampHandler}return createClass(RTPH264Parser,[{key:"parse",value:function(rtp){var nalus=this.naluasm.onNALUFragment(rtp.getPayload(),0,0);if(!nalus)return null;var isSEI=!0,_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=nalus[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){if(!_step.value.isSEI()){isSEI=!1;break}}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}isSEI||this.rtpTimestampHandler.checkOverflow(rtp.timestamp),rtp.timestamp=this.rtpTimestampHandler.adjust(rtp.timestamp);var pts=rtp.getTimestampMS(),dts=pts;isSEI||(dts=this.dtsGenerator.getDtsWithPts(pts));var _iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=nalus[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var _nalu=_step2.value;_nalu.dts=dts,_nalu.pts=pts}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return nalus}}]),RTPH264Parser}(),RTPAACParser=function(){function RTPAACParser(){classCallCheck(this,RTPAACParser),this.scale=1,this.asm=new AACAsm,this.rtpTimestampHandler=new RtpTimestampHandler}return createClass(RTPAACParser,[{key:"setConfig",value:function(conf){this.asm.config=conf}},{key:"parse",value:function(rtp){return this.rtpTimestampHandler.checkOverflow(rtp.timestamp),rtp.timestamp=this.rtpTimestampHandler.adjust(rtp.timestamp),this.asm.onAACFragment(rtp)}}]),RTPAACParser}(),Log$9=getTagged("client:base"),BaseClient=function(){function BaseClient(){var _this=this,options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{flush:100};classCallCheck(this,BaseClient),this.options=options,this.eventSource=new EventEmitter,Object.defineProperties(this,{sourceUrl:{value:null,writable:!0},paused:{value:!0,writable:!0},seekable:{value:!1,writable:!0},connected:{value:!1,writable:!0}}),this._onData=function(){if(_this.connected)for(;_this.transport.dataQueue.length;)_this.onData(_this.transport.dataQueue.pop())},this._onConnect=this.onConnected.bind(this),this._onDisconnect=this.onDisconnected.bind(this),this._onError=options.onError||null,this._onReconnect=this.onReconnected.bind(this)}return createClass(BaseClient,[{key:"destroy",value:function(){this.detachTransport(),this.stopStreamFlush()}},{key:"attachTransport",value:function(transport){this.transport&&this.detachTransport(),this.transport=transport,this.transport.eventSource.addEventListener("data",this._onData),this.transport.eventSource.addEventListener("connected",this._onConnect),this.transport.eventSource.addEventListener("disconnected",this._onDisconnect),this.transport.eventSource.addEventListener("reconnected",this._onReconnect)}},{key:"detachTransport",value:function(){this.transport&&(this.transport.eventSource.removeEventListener("data",this._onData),this.transport.eventSource.removeEventListener("connected",this._onConnect),this.transport.eventSource.removeEventListener("disconnected",this._onDisconnect),this.transport.eventSource.removeEventListener("reconnected",this._onReconnect),this.transport=null)}},{key:"reset",value:function(){}},{key:"start",value:function(){Log$9.debug("Client started"),this.paused=!1}},{key:"stop",value:function(){Log$9.debug("Client stoped"),console.trace(),this.paused=!0}},{key:"seek",value:function(timeOffset){}},{key:"setSource",value:function(source){this.stop(),this.endpoint=source,this.sourceUrl=source.urlpath}},{key:"startStreamFlush",value:function(){var _this2=this;this.flushInterval=setInterval(function(){_this2.paused||_this2.eventSource.dispatchEvent("flush")},this.options.flush)}},{key:"stopStreamFlush",value:function(){clearInterval(this.flushInterval),Log$9.debug("stopped stream flush")}},{key:"onData",value:function(data){}},{key:"onConnected",value:function(){this.seekable||(this.transport.dataQueue=[]),this.connected=!0}},{key:"onDisconnected",value:function(){this.connected=!1,this.stopStreamFlush()}},{key:"onReconnected",value:function(){return __async(regeneratorRuntime.mark(function _callee(){return regeneratorRuntime.wrap(function(_context){for(;;)switch(_context.prev=_context.next){case 0:return _context.next=2,this.reset();case 2:this.eventSource.dispatchEvent("reconnected");case 3:case"end":return _context.stop()}},_callee,this)}).call(this))}},{key:"queryCredentials",value:function(){return Promise.resolve()}},{key:"setCredentials",value:function(user,password){this.endpoint.user=user,this.endpoint.pass=password,this.endpoint.auth=user+":"+password}}],[{key:"streamType",value:function(){return null}}]),BaseClient}(),ExtendableError=function ExtendableError(message){classCallCheck(this,ExtendableError),this.message=message,this.name=this.constructor.name,this.stack=(new Error).stack};ExtendableError.prototype=Object.create(Error.prototype);var LOG_TAG$2="client:rtsp",Log$7=getTagged(LOG_TAG$2),RTSPStream=function(){function RTSPStream(client,track){classCallCheck(this,RTSPStream),this.state=null,this.client=client,this.track=track,this.rtpChannel=1,this.stopKeepAlive(),this.keepaliveInterval=null}return createClass(RTSPStream,[{key:"reset",value:function(){this.stopKeepAlive(),this.client.forgetRTPChannel(this.rtpChannel),this.client=null,this.track=null}},{key:"start",value:function(){return this.sendSetup().then(this.sendPlay.bind(this))}},{key:"stop",value:function(){return this.sendTeardown()}},{key:"getSetupURL",value:function(track){var sessionBlock=this.client.sdp.getSessionBlock();return Url.isAbsolute(track.control)?track.control:Url.isAbsolute(""+sessionBlock.control+track.control)?""+sessionBlock.control+track.control:Url.isAbsolute(""+this.client.contentBase+track.control)?""+this.client.contentBase+track.control:track.control}},{key:"getControlURL",value:function(){var ctrl=this.client.sdp.getSessionBlock().control;return Url.isAbsolute(ctrl)?ctrl:ctrl&&"*"!==ctrl?""+this.client.contentBase+ctrl:this.client.contentBase}},{key:"sendKeepalive",value:function(){return this.client.methods.includes("GET_PARAMETER")&&!this.client.hacks.options_keepalive?this.client.sendRequest("GET_PARAMETER",this.getSetupURL(this.track),{Session:this.session}):this.client.sendRequest("OPTIONS","*")}},{key:"stopKeepAlive",value:function(){clearInterval(this.keepaliveInterval)}},{key:"startKeepAlive",value:function(){var _this=this;this.keepaliveInterval=setInterval(function(){_this.sendKeepalive().catch(function(e){Log$7.error(e),e instanceof RTSPError&&501==Number(e.data.parsed.code)||_this.client.reconnect()})},3e4)}},{key:"sendRequest",value:function(_cmd){var _params=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},params={};return this.session&&(params.Session=this.session),Object.assign(params,_params),this.client.sendRequest(_cmd,this.getControlURL(),params)}},{key:"sendSetup",value:function(){var _this2=this;this.state=RTSPClient.STATE_SETUP,this.rtpChannel=this.client.interleaveChannelIndex;var interleavedChannels=this.client.interleaveChannelIndex+++"-"+this.client.interleaveChannelIndex++;return this.client.sendRequest("SETUP",this.getSetupURL(this.track),{Transport:"RTP/AVP/TCP;unicast;interleaved="+interleavedChannels,Date:(new Date).toUTCString()}).then(function(_data){_this2.session=_data.headers.session.split(";")[0];var transport=_data.headers.transport;if(transport){var interleaved=transport.match(/interleaved=([0-9]+)-([0-9]+)/)[1];interleaved&&(_this2.rtpChannel=Number(interleaved))}_this2.startKeepAlive()})}},{key:"sendPlay",value:function(){return __async(regeneratorRuntime.mark(function _callee(){var params,range,data;return regeneratorRuntime.wrap(function(_context){for(;;)switch(_context.prev=_context.next){case 0:return this.state=RTSPStream.STATE_PLAY,params={},(range=this.client.sdp.sessionBlock.range)&&-1==range[0]&&(range[0]=0),this.client.useRTPChannel(this.rtpChannel),_context.next=7,this.sendRequest("PLAY",params);case 7:return data=_context.sent,this.state=RTSPClient.STATE_PLAYING,_context.abrupt("return",{track:this.track,data:data});case 10:case"end":return _context.stop()}},_callee,this)}).call(this))}},{key:"sendPause",value:function(){return __async(regeneratorRuntime.mark(function _callee2(){return regeneratorRuntime.wrap(function(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:if(this.client.supports("PAUSE")){_context2.next=2;break}return _context2.abrupt("return");case 2:return this.state=RTSPClient.STATE_PAUSE,_context2.next=5,this.sendRequest("PAUSE");case 5:this.state=RTSPClient.STATE_PAUSED;case 6:case"end":return _context2.stop()}},_callee2,this)}).call(this))}},{key:"sendTeardown",value:function(){return __async(regeneratorRuntime.mark(function _callee3(){return regeneratorRuntime.wrap(function(_context3){for(;;)switch(_context3.prev=_context3.next){case 0:if(this.state==RTSPClient.STATE_TEARDOWN){_context3.next=7;break}return this.client.forgetRTPChannel(this.rtpChannel),this.state=RTSPClient.STATE_TEARDOWN,this.stopKeepAlive(),_context3.next=6,this.sendRequest("TEARDOWN");case 6:Log$7.log("RTSPClient: STATE_TEARDOWN");case 7:case"end":return _context3.stop()}},_callee3,this)}).call(this))}}]),RTSPStream}(),RTPError=function(_ExtendableError){function RTPError(message,file,line){classCallCheck(this,RTPError);var _this3=possibleConstructorReturn(this,(RTPError.__proto__||Object.getPrototypeOf(RTPError)).call(this,message));return _this3.file=file,_this3.line=line,_this3}return inherits(RTPError,ExtendableError),RTPError}(),RTSPClient=function(_BaseClient){function RTSPClient(){var options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{flush:200};classCallCheck(this,RTSPClient);var _this4=possibleConstructorReturn(this,(RTSPClient.__proto__||Object.getPrototypeOf(RTSPClient)).call(this,options));return _this4.clientSM=new RTSPClientSM(_this4),_this4.clientSM.ontracks=function(tracks){_this4.eventSource.dispatchEvent("tracks",tracks),_this4.stopStreamFlush(),_this4.startStreamFlush()},_this4.sampleQueues={},_this4}return inherits(RTSPClient,BaseClient),createClass(RTSPClient,[{key:"setSource",value:function(url){get(RTSPClient.prototype.__proto__||Object.getPrototypeOf(RTSPClient.prototype),"setSource",this).call(this,url),this.clientSM.setSource(url)}},{key:"attachTransport",value:function(transport){get(RTSPClient.prototype.__proto__||Object.getPrototypeOf(RTSPClient.prototype),"attachTransport",this).call(this,transport),this.clientSM.transport=transport}},{key:"detachTransport",value:function(){get(RTSPClient.prototype.__proto__||Object.getPrototypeOf(RTSPClient.prototype),"detachTransport",this).call(this),this.clientSM.transport=null}},{key:"reset",value:function(){var _this5=this;return __async(regeneratorRuntime.mark(function _callee4($uper){return regeneratorRuntime.wrap(function(_context4){for(;;)switch(_context4.prev=_context4.next){case 0:return $uper("reset").call(this),_context4.next=3,this.clientSM.reset();case 3:this.sampleQueues={},Log$7.debug("rtsp client reset");case 5:case"end":return _context4.stop()}},_callee4,this)}).call(this,function(p){return get(RTSPClient.prototype.__proto__||Object.getPrototypeOf(RTSPClient.prototype),p,_this5)}))}},{key:"destroy",value:function(){return this.clientSM.destroy(),get(RTSPClient.prototype.__proto__||Object.getPrototypeOf(RTSPClient.prototype),"destroy",this).call(this)}},{key:"start",value:function(){var _this6=this;return get(RTSPClient.prototype.__proto__||Object.getPrototypeOf(RTSPClient.prototype),"start",this).call(this),this.transport?this.transport.ready().then(function(){return _this6.clientSM.start()}).catch(function(e){if(!_this6._onError)throw e;_this6._onError(e)}):Promise.reject("no transport attached")}},{key:"onData",value:function(data){this.clientSM.onData(data)}},{key:"onConnected",value:function(){this.clientSM.onConnected(),get(RTSPClient.prototype.__proto__||Object.getPrototypeOf(RTSPClient.prototype),"onConnected",this).call(this)}},{key:"onDisconnected",value:function(){get(RTSPClient.prototype.__proto__||Object.getPrototypeOf(RTSPClient.prototype),"onDisconnected",this).call(this),this.clientSM.onDisconnected()}}],[{key:"streamType",value:function(){return"rtsp"}}]),RTSPClient}(),AuthError=function(_ExtendableError2){function AuthError(msg){return classCallCheck(this,AuthError),possibleConstructorReturn(this,(AuthError.__proto__||Object.getPrototypeOf(AuthError)).call(this,msg))}return inherits(AuthError,ExtendableError),AuthError}(),RedirectError=function(_ExtendableError3){function RedirectError(data){classCallCheck(this,RedirectError);var _this8=possibleConstructorReturn(this,(RedirectError.__proto__||Object.getPrototypeOf(RedirectError)).call(this,data.msg||"redirect"));return _this8.data=data,_this8}return inherits(RedirectError,ExtendableError),RedirectError}(),RTSPError=function(_ExtendableError4){function RTSPError(data){classCallCheck(this,RTSPError);var _this9=possibleConstructorReturn(this,(RTSPError.__proto__||Object.getPrototypeOf(RTSPError)).call(this,data.msg));return _this9.data=data,_this9}return inherits(RTSPError,ExtendableError),RTSPError}(),RTSPClientSM=function(_StateMachine){function RTSPClientSM(parent){classCallCheck(this,RTSPClientSM);var _this10=possibleConstructorReturn(this,(RTSPClientSM.__proto__||Object.getPrototypeOf(RTSPClientSM)).call(this));return _this10.parent=parent,_this10.transport=null,_this10.payParser=new RTPPayloadParser,_this10.rtp_channels=new Set,_this10.ontracks=null,_this10.hacks={},_this10.addState(RTSPClientSM.STATE_INITIAL,{}).addState(RTSPClientSM.STATE_OPTIONS,{activate:_this10.sendOptions,finishTransition:_this10.onOptions}).addState(RTSPClientSM.STATE_DESCRIBE,{activate:_this10.sendDescribe,finishTransition:_this10.onDescribe}).addState(RTSPClientSM.STATE_SETUP,{activate:_this10.sendSetup,finishTransition:_this10.onSetup}).addState(RTSPClientSM.STATE_STREAMS,{}).addState(RTSPClientSM.STATE_TEARDOWN,{activate:function(){_this10.started=!1},finishTransition:function(){return _this10.transitionTo(RTSPClientSM.STATE_INITIAL)}}).addTransition(RTSPClientSM.STATE_INITIAL,RTSPClientSM.STATE_OPTIONS).addTransition(RTSPClientSM.STATE_INITIAL,RTSPClientSM.STATE_TEARDOWN).addTransition(RTSPClientSM.STATE_OPTIONS,RTSPClientSM.STATE_DESCRIBE).addTransition(RTSPClientSM.STATE_DESCRIBE,RTSPClientSM.STATE_SETUP).addTransition(RTSPClientSM.STATE_SETUP,RTSPClientSM.STATE_STREAMS).addTransition(RTSPClientSM.STATE_TEARDOWN,RTSPClientSM.STATE_INITIAL).addTransition(RTSPClientSM.STATE_STREAMS,RTSPClientSM.STATE_TEARDOWN).addTransition(RTSPClientSM.STATE_SETUP,RTSPClientSM.STATE_TEARDOWN).addTransition(RTSPClientSM.STATE_DESCRIBE,RTSPClientSM.STATE_TEARDOWN).addTransition(RTSPClientSM.STATE_OPTIONS,RTSPClientSM.STATE_TEARDOWN),_this10.reset(),_this10.shouldReconnect=!1,_this10}return inherits(RTSPClientSM,StateMachine),createClass(RTSPClientSM,null,[{key:"USER_AGENT",get:function(){return"SFRtsp 0.3"}},{key:"STATE_INITIAL",get:function(){return 1}},{key:"STATE_OPTIONS",get:function(){return 2}},{key:"STATE_DESCRIBE",get:function(){return 4}},{key:"STATE_SETUP",get:function(){return 8}},{key:"STATE_STREAMS",get:function(){return 16}},{key:"STATE_TEARDOWN",get:function(){return 32}}]),createClass(RTSPClientSM,[{key:"destroy",value:function(){var track_types=Object.keys(this.streams),_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=track_types[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var track_type=_step.value;"audio"!==track_type&&"video"!==track_type||(this.streams[track_type].stopKeepAlive(),Log$7.debug("stopped keepalive "+track_type))}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}this.parent=null}},{key:"setSource",value:function(url){this.reset(),this.endpoint=url;var full=url.protocol+"://"+url.location+url.urlpath;this.url=full}},{key:"onConnected",value:function(){this.shouldReconnect&&(this.start(),this.shouldReconnect=!1)}},{key:"onDisconnected",value:function(){return __async(regeneratorRuntime.mark(function _callee5(){return regeneratorRuntime.wrap(function(_context5){for(;;)switch(_context5.prev=_context5.next){case 0:return _context5.next=2,this.reset();case 2:return this.shouldReconnect=!0,_context5.next=5,this.transitionTo(RTSPClientSM.STATE_TEARDOWN);case 5:return _context5.next=7,this.transitionTo(RTSPClientSM.STATE_INITIAL);case 7:case"end":return _context5.stop()}},_callee5,this)}).call(this))}},{key:"transitionTo",value:function(s){var _this11=this;return get(RTSPClientSM.prototype.__proto__||Object.getPrototypeOf(RTSPClientSM.prototype),"transitionTo",this).call(this,s).catch(function(e){if(e instanceof RedirectError)_this11.parent.redirectHandler(e.data.redirectUrl);else{if(!_this11.parent._onError)throw e;_this11.parent._onError(e)}})}},{key:"start",value:function(){this.currentState.name!==RTSPClientSM.STATE_STREAMS&&this.transitionTo(RTSPClientSM.STATE_OPTIONS)}},{key:"onData",value:function(data){var channel=data[1];this.rtp_channels.has(channel)&&this.onRTP({packet:data.subarray(4),type:channel})}},{key:"useRTPChannel",value:function(channel){this.rtp_channels.add(channel)}},{key:"forgetRTPChannel",value:function(channel){this.rtp_channels.delete(channel)}},{key:"stop",value:function(){this.shouldReconnect=!1}},{key:"reset",value:function(){return __async(regeneratorRuntime.mark(function _callee6(){var stream;return regeneratorRuntime.wrap(function(_context6){for(;;)switch(_context6.prev=_context6.next){case 0:this.authUserInfo="",this.authenticator="",this.methods=[],this.tracks=[],this.rtpBuffer={};for(stream in this.streams)this.streams[stream].reset();if(this.streams={},this.contentBase="",!this.currentState){_context6.next=16;break}if(this.currentState.name==RTSPClientSM.STATE_INITIAL){_context6.next=14;break}return _context6.next=12,this.transitionTo(RTSPClientSM.STATE_TEARDOWN);case 12:return _context6.next=14,this.transitionTo(RTSPClientSM.STATE_INITIAL);case 14:_context6.next=18;break;case 16:return _context6.next=18,this.transitionTo(RTSPClientSM.STATE_INITIAL);case 18:this.sdp=null,this.interleaveChannelIndex=0,this.session=null,this.timeOffset={},this.lastTimestamp={};case 23:case"end":return _context6.stop()}},_callee6,this)}).call(this))}},{key:"reconnect",value:function(){return __async(regeneratorRuntime.mark(function _callee7(){return regeneratorRuntime.wrap(function(_context7){for(;;)switch(_context7.prev=_context7.next){case 0:return _context7.next=2,this.reset();case 2:if(this.currentState.name==RTSPClientSM.STATE_INITIAL){_context7.next=8;break}return _context7.next=5,this.transitionTo(RTSPClientSM.STATE_TEARDOWN);case 5:case 8:return _context7.abrupt("return",this.transitionTo(RTSPClientSM.STATE_OPTIONS));case 9:case"end":return _context7.stop()}},_callee7,this)}).call(this))}},{key:"supports",value:function(method){return this.methods.includes(method)}},{key:"parse",value:function(_data){Log$7.debug(_data.payload);var d=_data.payload.split("\r\n\r\n"),parsed=MessageBuilder.parse(d[0]);if(Number(parsed.headers["content-length"])){var _d=_data.payload.split("\r\n\r\n");parsed.body=_d[1]}else parsed.body="";return parsed}},{key:"sendRequest",value:function(_cmd,_host){var _this12=this,_params=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},_payload=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return this.cSeq++,Object.assign(_params,{CSeq:this.cSeq,"User-Agent":RTSPClientSM.USER_AGENT}),this.authenticator&&(_params.Authorization=this.authenticator(_cmd)),this.send(MessageBuilder.build(_cmd,_host,_params,_payload),_cmd).catch(function(e){if(e instanceof AuthError&&!_params.Authorization)return _this12.sendRequest(_cmd,_host,_params,_payload);throw e})}},{key:"send",value:function(_data,_method){return __async(regeneratorRuntime.mark(function _callee8(){var response,parsed,auth,method,chunks,ep,parsedChunks,_iteratorNormalCompletion2,_didIteratorError2,_iteratorError2,_iterator2,_step2,chunk,c,_c$split,_c$split2,k,v,redirectUrl,_ep,authPrefix,_this13=this;return regeneratorRuntime.wrap(function(_context8){for(;;)switch(_context8.prev=_context8.next){case 0:if(!this.transport){_context8.next=70;break}return _context8.prev=1,_context8.next=4,this.transport.ready();case 4:_context8.next=10;break;case 6:throw _context8.prev=6,_context8.t0=_context8.catch(1),this.onDisconnected(),_context8.t0;case 10:return Log$7.debug(_data),_context8.next=13,this.transport.send(_data);case 13:if(response=_context8.sent,401!=(parsed=this.parse(response)).code){_context8.next=59;break}if(Log$7.debug(parsed.headers["www-authenticate"]),auth=parsed.headers["www-authenticate"],method=auth.substring(0,auth.indexOf(" ")),auth=auth.substr(method.length+1),chunks=auth.split(","),ep=this.parent.endpoint,console.log("endpoint --\x3e ",ep),ep.user&&ep.pass){_context8.next=32;break}return _context8.prev=24,_context8.next=27,this.parent.queryCredentials.call(this.parent);case 27:_context8.next=32;break;case 29:throw _context8.prev=29,_context8.t1=_context8.catch(24),new AuthError;case 32:if("digest"!=method.toLowerCase()){_context8.next=57;break}for(parsedChunks={},_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0,_context8.prev=37,_iterator2=chunks[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0)chunk=_step2.value,c=chunk.trim(),_c$split=c.split("="),_c$split2=slicedToArray(_c$split,2),k=_c$split2[0],v=_c$split2[1],parsedChunks[k]=v.substr(1,v.length-2);_context8.next=45;break;case 41:_context8.prev=41,_context8.t2=_context8.catch(37),_didIteratorError2=!0,_iteratorError2=_context8.t2;case 45:_context8.prev=45,_context8.prev=46,!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return();case 48:if(_context8.prev=48,!_didIteratorError2){_context8.next=51;break}throw _iteratorError2;case 51:return _context8.finish(48);case 52:return _context8.finish(45);case 53:"RTSP Server"==parsed.headers.server&&"RTSP SERVER"==parsedChunks.realm&&(Log$7.debug("set OPTIONS keepalive hack"),this.hacks.options_keepalive=!0),this.authenticator=function(_method){var ep=_this13.parent.endpoint,ha1=md5(ep.user+":"+parsedChunks.realm+":"+ep.pass),ha2=md5(_method+":"+_this13.url),response=md5(ha1+":"+parsedChunks.nonce+":"+ha2);return'Digest username="'+ep.user+'", realm="'+parsedChunks.realm+'", nonce="'+parsedChunks.nonce+'", uri="'+_this13.url+'", response="'+response+'"'},_context8.next=58;break;case 57:this.authenticator=function(){return"Basic "+btoa(_this13.parent.endpoint.auth)};case 58:throw new AuthError(parsed);case 59:if(301!==parsed.code){_context8.next=64;break}throw redirectUrl=parsed.headers.location,(_ep=this.parent.endpoint).user&&_ep.pass&&(authPrefix=_ep.user+":"+_ep.pass+"@",redirectUrl=redirectUrl.slice(0,7)+authPrefix+redirectUrl.slice(7)),new RedirectError({redirectUrl:redirectUrl});case 64:if(!(parsed.code>=300)){_context8.next=67;break}throw Log$7.error("RTSP error:",parsed.statusLine),new RTSPError({msg:"RTSP error: "+parsed.code+" "+parsed.statusLine,parsed:parsed});case 67:return _context8.abrupt("return",parsed);case 70:return _context8.abrupt("return",Promise.reject("No transport attached"));case 71:case"end":return _context8.stop()}},_callee8,this,[[1,6],[24,29],[37,41,45,53],[46,,48,52]])}).call(this))}},{key:"sendOptions",value:function(){return this.reset(),this.started=!0,this.cSeq=0,this.sendRequest("OPTIONS",this.url,{})}},{key:"onOptions",value:function(data){data.headers.public?this.methods=data.headers.public.split(",").map(function(e){return e.trim()}):this.methods=["OPTIONS","DESCRIBE","TEARDOWN","PLAY"],this.transitionTo(RTSPClientSM.STATE_DESCRIBE)}},{key:"sendDescribe",value:function(){var _this14=this;return this.sendRequest("DESCRIBE",this.url,{Accept:"application/sdp"}).then(function(data){return _this14.sdp=new SDPParser,_this14.sdp.parse(data.body).catch(function(){throw new Error("Failed to parse SDP")}).then(function(){return data})})}},{key:"onDescribe",value:function(data){if(this.contentBase=data.headers["content-base"]||this.url,this.contentBase.endsWith("/")||(this.contentBase=this.contentBase+"/"),this.tracks=this.sdp.getMediaBlockList(),Log$7.log("SDP contained "+this.tracks.length+" track(s). Calling SETUP for each."),data.headers.session&&(this.session=data.headers.session),!this.tracks.length)throw new Error("No tracks in SDP");this.transitionTo(RTSPClientSM.STATE_SETUP)}},{key:"sendSetup",value:function(){var _this15=this,streams=[],_iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _step3,_iterator3=this.tracks[Symbol.iterator]();!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=!0){var track_type=_step3.value;if("audio"==track_type||"video"==track_type){var track=this.sdp.getMediaBlock(track_type);if(track.rtpmap[track.fmt[0]]&&PayloadType.string_map[track.rtpmap[track.fmt[0]].name]){Log$7.log("setup track: "+track_type),this.streams[track_type]=new RTSPStream(this,track);var playPromise=this.streams[track_type].start();this.parent.sampleQueues[PayloadType.string_map[track.rtpmap[track.fmt[0]].name]]=[],this.rtpBuffer[track.fmt[0]]=[],streams.push(playPromise.then(function(_ref){var track=_ref.track,data=_ref.data;_this15.timeOffset[track.fmt[0]]=0;try{var rtp_info=data.headers["rtp-info"].split(";"),_iteratorNormalCompletion4=!0,_didIteratorError4=!1,_iteratorError4=void 0;try{for(var _step4,_iterator4=rtp_info[Symbol.iterator]();!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=!0){var _chunk$split=_step4.value.split("="),_chunk$split2=slicedToArray(_chunk$split,2),key=_chunk$split2[0],val=_chunk$split2[1];"rtptime"===key&&(_this15.timeOffset[track.fmt[0]]=Number(val))}}catch(err){_didIteratorError4=!0,_iteratorError4=err}finally{try{!_iteratorNormalCompletion4&&_iterator4.return&&_iterator4.return()}finally{if(_didIteratorError4)throw _iteratorError4}}}catch(e){}var params={timescale:0,scaleFactor:0};if(track.fmtp&&track.fmtp["sprop-parameter-sets"]){var sps_pps=track.fmtp["sprop-parameter-sets"].split(",");params={sps:base64ToArrayBuffer(sps_pps[0]),pps:base64ToArrayBuffer(sps_pps[1])}}else if(track.fmtp&&track.fmtp.config){var config=track.fmtp.config;_this15.has_config="0"!=track.fmtp.cpresent,"MPEG4-GENERIC"==track.rtpmap[track.fmt[0]].name?(params={config:AACParser.parseAudioSpecificConfig(hexToByteArray(config))},_this15.payParser.aacparser.setConfig(params.config)):config&&(params={config:AACParser.parseStreamMuxConfig(hexToByteArray(config))},_this15.payParser.aacparser.setConfig(params.config))}if(params.duration=null,_this15.parent.seekable=!1,_this15.sdp.sessionBlock.range){var range=_this15.sdp.sessionBlock.range[1]-_this15.sdp.sessionBlock.range[0];range>1&&(Log$7.debug("set to seekable mode"),_this15.parent.seekable=!0,params.duration=range)}return{track:track,offset:_this15.timeOffset[track.fmt[0]],type:PayloadType.string_map[track.rtpmap[track.fmt[0]].name],params:params,duration:params.duration}}))}}}}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3.return&&_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}}return Promise.all(streams).then(function(tracks){_this15.ontracks&&_this15.ontracks(tracks)}).catch(function(e){return Log$7.error("setup error: ",e),_this15.stop(),_this15.reset()})}},{key:"onSetup",value:function(){this.firstKeyframeFound=!1,this.transitionTo(RTSPClientSM.STATE_STREAMS)}},{key:"onRTP",value:function(_data){var rtp=new RTP(_data.packet,this.sdp);if(rtp.type){var queue=this.rtpBuffer[rtp.pt];for(queue.push(rtp);queue.length;){var _rtp=queue.shift();if(_rtp.media){var pay=this.payParser.parse(_rtp);if(pay)if(_rtp.isVideo()){if(!this.firstKeyframeFound){var _iteratorNormalCompletion5=!0,_didIteratorError5=!1,_iteratorError5=void 0;try{for(var _step5,_iterator5=pay[Symbol.iterator]();!(_iteratorNormalCompletion5=(_step5=_iterator5.next()).done);_iteratorNormalCompletion5=!0){var nalu=_step5.value;nalu.isDataType()&&(this.firstKeyframeFound||!nalu.isSpsPps()&&!nalu.isKeyframe()?console.log("drop broken nalu",nalu.toString()):this.firstKeyframeFound=!0)}}catch(err){_didIteratorError5=!0,_iteratorError5=err}finally{try{!_iteratorNormalCompletion5&&_iterator5.return&&_iterator5.return()}finally{if(_didIteratorError5)throw _iteratorError5}}}this.firstKeyframeFound&&this.parent.sampleQueues[_rtp.type].push(pay)}else this.parent.sampleQueues[_rtp.type].push(pay)}}}}}]),RTSPClientSM}(),hardLimit=100,ellipsis="…",DOM={tag:function(tagName,className){var t=document.createElement(tagName);return t.className=className,t},text:function(str){return document.createTextNode(str)}},Stream=function(){function Stream(enc,pos){classCallCheck(this,Stream),enc instanceof Stream?(this.enc=enc.enc,this.pos=enc.pos):(this.enc=enc,this.pos=pos)}return createClass(Stream,null,[{key:"hexDigits",get:function(){return"0123456789ABCDEF"}},{key:"reTime",get:function(){return/^((?:1[89]|2\d)?\d\d)(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])([01]\d|2[0-3])(?:([0-5]\d)(?:([0-5]\d)(?:[.,](\d{1,3}))?)?)?(Z|[-+](?:[0]\d|1[0-2])([0-5]\d)?)?$/}}]),createClass(Stream,[{key:"get",value:function(pos){if(void 0===pos&&(pos=this.pos++),pos>=this.enc.length)throw"Requesting byte offset "+pos+" on a stream of length "+this.enc.length;return this.enc[pos]}},{key:"hexByte",value:function(b){return Stream.hexDigits.charAt(b>>4&15)+Stream.hexDigits.charAt(15&b)}},{key:"hexDump",value:function(start,end,raw){for(var s="",i=start;i<end;++i)if(s+=this.hexByte(this.get(i)),!0!==raw)switch(15&i){case 7:s+="  ";break;case 15:s+="\n";break;default:s+=" "}return s}},{key:"parseStringISO",value:function(start,end){for(var s="",i=start;i<end;++i)s+=String.fromCharCode(this.get(i));return s}},{key:"parseStringUTF",value:function(start,end){for(var s="",i=start;i<end;){var c=this.get(i++);s+=c<128?String.fromCharCode(c):c>191&&c<224?String.fromCharCode((31&c)<<6|63&this.get(i++)):String.fromCharCode((15&c)<<12|(63&this.get(i++))<<6|63&this.get(i++))}return s}},{key:"parseStringBMP",value:function(start,end){for(var str="",i=start;i<end;i+=2){var high_byte=this.get(i),low_byte=this.get(i+1);str+=String.fromCharCode((high_byte<<8)+low_byte)}return str}},{key:"parseTime",value:function(start,end){var s=this.parseStringISO(start,end),m=Stream.reTime.exec(s);return m?(s=m[1]+"-"+m[2]+"-"+m[3]+" "+m[4],m[5]&&(s+=":"+m[5],m[6]&&(s+=":"+m[6],m[7]&&(s+="."+m[7]))),m[8]&&(s+=" UTC","Z"!=m[8]&&(s+=m[8],m[9]&&(s+=":"+m[9]))),s):"Unrecognized time: "+s}},{key:"parseInteger",value:function(start,end){var len=end-start;if(len>4){len<<=3;var s=this.get(start);if(0===s)len-=8;else for(;s<128;)s<<=1,--len;return"("+len+" bit)"}for(var n=0,i=start;i<end;++i)n=n<<8|this.get(i);return n}},{key:"parseBitString",value:function(start,end){var unusedBit=this.get(start),lenBit=(end-start-1<<3)-unusedBit,s="("+lenBit+" bit)";if(lenBit<=20){var skip=unusedBit;s+=" ";for(var i=end-1;i>start;--i){for(var b=this.get(i),j=skip;j<8;++j)s+=b>>j&1?"1":"0";skip=0}}return s}},{key:"parseOctetString",value:function(start,end){var len=end-start,s="("+len+" byte) ";len>hardLimit&&(end=start+hardLimit);for(var i=start;i<end;++i)s+=this.hexByte(this.get(i));return len>hardLimit&&(s+=ellipsis),s}},{key:"parseOID",value:function(start,end){for(var s="",n=0,bits=0,i=start;i<end;++i){var v=this.get(i);if(n=n<<7|127&v,bits+=7,!(128&v)){if(""===s){var m=n<80?n<40?0:1:2;s=m+"."+(n-40*m)}else s+="."+(bits>=31?"bigint":n);n=bits=0}}return s}}]),Stream}(),ASN1=function(){function ASN1(stream,header,length,tag,sub){classCallCheck(this,ASN1),this.stream=stream,this.header=header,this.length=length,this.tag=tag,this.sub=sub}return createClass(ASN1,null,[{key:"reSeemsASCII",get:function(){return/^[ -~]+$/}}]),createClass(ASN1,[{key:"typeName",value:function(){if(void 0===this.tag)return"unknown";var tagClass=this.tag>>6,tagNumber=(this.tag,31&this.tag);switch(tagClass){case 0:switch(tagNumber){case 0:return"EOC";case 1:return"BOOLEAN";case 2:return"INTEGER";case 3:return"BIT_STRING";case 4:return"OCTET_STRING";case 5:return"NULL";case 6:return"OBJECT_IDENTIFIER";case 7:return"ObjectDescriptor";case 8:return"EXTERNAL";case 9:return"REAL";case 10:return"ENUMERATED";case 11:return"EMBEDDED_PDV";case 12:return"UTF8String";case 16:return"SEQUENCE";case 17:return"SET";case 18:return"NumericString";case 19:return"PrintableString";case 20:return"TeletexString";case 21:return"VideotexString";case 22:return"IA5String";case 23:return"UTCTime";case 24:return"GeneralizedTime";case 25:return"GraphicString";case 26:return"VisibleString";case 27:return"GeneralString";case 28:return"UniversalString";case 30:return"BMPString";default:return"Universal_"+tagNumber.toString(16)}case 1:return"Application_"+tagNumber.toString(16);case 2:return"["+tagNumber+"]";case 3:return"Private_"+tagNumber.toString(16)}}},{key:"content",value:function(){if(void 0===this.tag)return null;var tagClass=this.tag>>6,tagNumber=31&this.tag,content=this.posContent(),len=Math.abs(this.length);if(0!==tagClass){if(null!==this.sub)return"("+this.sub.length+" elem)";var s=this.stream.parseStringISO(content,content+Math.min(len,hardLimit));return ASN1.reSeemsASCII.test(s)?s.substring(0,2*hardLimit)+(s.length>2*hardLimit?ellipsis:""):this.stream.parseOctetString(content,content+len)}switch(tagNumber){case 1:return 0===this.stream.get(content)?"false":"true";case 2:return this.stream.parseInteger(content,content+len);case 3:return this.sub?"("+this.sub.length+" elem)":this.stream.parseBitString(content,content+len);case 4:return this.sub?"("+this.sub.length+" elem)":this.stream.parseOctetString(content,content+len);case 6:return this.stream.parseOID(content,content+len);case 16:case 17:return"("+this.sub.length+" elem)";case 12:return this.stream.parseStringUTF(content,content+len);case 18:case 19:case 20:case 21:case 22:case 26:return this.stream.parseStringISO(content,content+len);case 30:return this.stream.parseStringBMP(content,content+len);case 23:case 24:return this.stream.parseTime(content,content+len)}return null}},{key:"toString",value:function(){return this.typeName()+"@"+this.stream.pos+"[header:"+this.header+",length:"+this.length+",sub:"+(null===this.sub?"null":this.sub.length)+"]"}},{key:"print",value:function(indent){if(void 0===indent&&(indent=""),document.writeln(indent+this),null!==this.sub){indent+="  ";for(var i=0,max=this.sub.length;i<max;++i)this.sub[i].print(indent)}}},{key:"toPrettyString",value:function(indent){void 0===indent&&(indent="");var s=indent+this.typeName()+" @"+this.stream.pos;if(this.length>=0&&(s+="+"),s+=this.length,32&this.tag?s+=" (constructed)":3!=this.tag&&4!=this.tag||null===this.sub||(s+=" (encapsulates)"),s+="\n",null!==this.sub){indent+="  ";for(var i=0,max=this.sub.length;i<max;++i)s+=this.sub[i].toPrettyString(indent)}return s}},{key:"toDOM",value:function(){var node=DOM.tag("div","node");node.asn1=this;var head=DOM.tag("div","head"),s=this.typeName().replace(/_/g," ");head.innerHTML=s;var content=this.content();if(null!==content){content=String(content).replace(/</g,"&lt;");var preview=DOM.tag("span","preview");preview.appendChild(DOM.text(content)),head.appendChild(preview)}node.appendChild(head),this.node=node,this.head=head;var value=DOM.tag("div","value");if(s="Offset: "+this.stream.pos+"<br/>",s+="Length: "+this.header+"+",this.length>=0?s+=this.length:s+=-this.length+" (undefined)",32&this.tag?s+="<br/>(constructed)":3!=this.tag&&4!=this.tag||null===this.sub||(s+="<br/>(encapsulates)"),null!==content&&(s+="<br/>Value:<br/><b>"+content+"</b>","object"===("undefined"==typeof oids?"undefined":_typeof(oids))&&6==this.tag)){var oid=oids[content];oid&&(oid.d&&(s+="<br/>"+oid.d),oid.c&&(s+="<br/>"+oid.c),oid.w&&(s+="<br/>(warning!)"))}value.innerHTML=s,node.appendChild(value);var sub=DOM.tag("div","sub");if(null!==this.sub)for(var i=0,max=this.sub.length;i<max;++i)sub.appendChild(this.sub[i].toDOM());return node.appendChild(sub),head.onclick=function(){node.className="node collapsed"==node.className?"node":"node collapsed"},node}},{key:"posStart",value:function(){return this.stream.pos}},{key:"posContent",value:function(){return this.stream.pos+this.header}},{key:"posEnd",value:function(){return this.stream.pos+this.header+Math.abs(this.length)}},{key:"fakeHover",value:function(current){this.node.className+=" hover",current&&(this.head.className+=" hover")}},{key:"fakeOut",value:function(current){var re=/ ?hover/;this.node.className=this.node.className.replace(re,""),current&&(this.head.className=this.head.className.replace(re,""))}},{key:"toHexDOM_sub",value:function(node,className,stream,start,end){if(!(start>=end)){var sub=DOM.tag("span",className);sub.appendChild(DOM.text(stream.hexDump(start,end))),node.appendChild(sub)}}},{key:"toHexDOM",value:function(root){var node=DOM.tag("span","hex");if(void 0===root&&(root=node),this.head.hexNode=node,this.head.onmouseover=function(){this.hexNode.className="hexCurrent"},this.head.onmouseout=function(){this.hexNode.className="hex"},node.asn1=this,node.onmouseover=function(){var current=!root.selected;current&&(root.selected=this.asn1,this.className="hexCurrent"),this.asn1.fakeHover(current)},node.onmouseout=function(){var current=root.selected==this.asn1;this.asn1.fakeOut(current),current&&(root.selected=null,this.className="hex")},this.toHexDOM_sub(node,"tag",this.stream,this.posStart(),this.posStart()+1),this.toHexDOM_sub(node,this.length>=0?"dlen":"ulen",this.stream,this.posStart()+1,this.posContent()),null===this.sub)node.appendChild(DOM.text(this.stream.hexDump(this.posContent(),this.posEnd())));else if(this.sub.length>0){var first=this.sub[0],last=this.sub[this.sub.length-1];this.toHexDOM_sub(node,"intro",this.stream,this.posContent(),first.posStart());for(var i=0,max=this.sub.length;i<max;++i)node.appendChild(this.sub[i].toHexDOM(root));this.toHexDOM_sub(node,"outro",this.stream,last.posEnd(),this.posEnd())}return node}},{key:"toHexString",value:function(root){return this.stream.hexDump(this.posStart(),this.posEnd(),!0)}}]),ASN1}();ASN1.decodeLength=function(stream){var buf=stream.get(),len=127&buf;if(len==buf)return len;if(len>3)throw"Length over 24 bits not supported at position "+(stream.pos-1);if(0===len)return-1;buf=0;for(var i=0;i<len;++i)buf=buf<<8|stream.get();return buf},ASN1.hasContent=function(tag,len,stream){if(32&tag)return!0;if(tag<3||tag>4)return!1;var p=new Stream(stream);if(3==tag&&p.get(),p.get()>>6&1)return!1;try{var subLength=ASN1.decodeLength(p);return p.pos-stream.pos+subLength==len}catch(exception){return!1}},ASN1.decode=function(stream){stream instanceof Stream||(stream=new Stream(stream,0));var streamStart=new Stream(stream),tag=stream.get(),len=ASN1.decodeLength(stream),header=stream.pos-streamStart.pos,sub=null;if(ASN1.hasContent(tag,len,stream)){var start=stream.pos;if(3==tag&&stream.get(),sub=[],len>=0){for(var end=start+len;stream.pos<end;)sub[sub.length]=ASN1.decode(stream);if(stream.pos!=end)throw"Content size is not correct for container starting at offset "+start}else try{for(;;){var s=ASN1.decode(stream);if(0===s.tag)break;sub[sub.length]=s}len=start-stream.pos}catch(e){throw"Exception while decoding undefined length content: "+e}}else stream.pos+=len;return new ASN1(streamStart,header,len,tag,sub)},ASN1.test=function(){for(var test=[{value:[39],expected:39},{value:[129,201],expected:201},{value:[131,254,220,186],expected:16702650}],i=0,max=test.length;i<max;++i){var stream=new Stream(test[i].value,0),res=ASN1.decodeLength(stream);res!=test[i].expected&&document.write("In test["+i+"] expected "+test[i].expected+" got "+res+"\n")}};var Arcfour=function Arcfour(){classCallCheck(this,Arcfour),this.i=0,this.j=0,this.S=[]};function ARC4init(key){var i,j,t;for(i=0;i<256;++i)this.S[i]=i;for(j=0,i=0;i<256;++i)j=j+this.S[i]+key[i%key.length]&255,t=this.S[i],this.S[i]=this.S[j],this.S[j]=t;this.i=0,this.j=0}function ARC4next(){var t;return this.i=this.i+1&255,this.j=this.j+this.S[this.i]&255,t=this.S[this.i],this.S[this.i]=this.S[this.j],this.S[this.j]=t,this.S[t+this.S[this.i]&255]}function prng_newstate(){return new Arcfour}Arcfour.prototype.init=ARC4init,Arcfour.prototype.next=ARC4next;var rng_state,rng_pool,rng_pptr,rng_psize=256;if(null==rng_pool){var t;if(rng_pool=new Array,rng_pptr=0,window.crypto&&window.crypto.getRandomValues){var z=new Uint32Array(256);for(window.crypto.getRandomValues(z),t=0;t<z.length;++t)rng_pool[rng_pptr++]=255&z[t]}var onMouseMoveListener=function onMouseMoveListener(ev){if(this.count=this.count||0,this.count>=256||rng_pptr>=rng_psize)window.removeEventListener?window.removeEventListener("mousemove",onMouseMoveListener,!1):window.detachEvent&&window.detachEvent("onmousemove",onMouseMoveListener);else try{var mouseCoordinates=ev.x+ev.y;rng_pool[rng_pptr++]=255&mouseCoordinates,this.count+=1}catch(e){}};window.addEventListener?window.addEventListener("mousemove",onMouseMoveListener,!1):window.attachEvent&&window.attachEvent("onmousemove",onMouseMoveListener)}function rng_get_byte(){if(null==rng_state){for(rng_state=prng_newstate();rng_pptr<rng_psize;){var random=Math.floor(65536*Math.random());rng_pool[rng_pptr++]=255&random}for(rng_state.init(rng_pool),rng_pptr=0;rng_pptr<rng_pool.length;++rng_pptr)rng_pool[rng_pptr]=0;rng_pptr=0}return rng_state.next()}function rng_get_bytes(ba){var i;for(i=0;i<ba.length;++i)ba[i]=rng_get_byte()}var dbits,SecureRandom=function SecureRandom(){classCallCheck(this,SecureRandom)};SecureRandom.prototype.nextBytes=rng_get_bytes;var canary=0xdeadbeefcafe,j_lm=15715070==(16777215&canary),BigInteger=function BigInteger(a,b,c){classCallCheck(this,BigInteger),null!=a&&("number"==typeof a?this.fromNumber(a,b,c):null==b&&"string"!=typeof a?this.fromString(a,256):this.fromString(a,b))};function nbi(){return new BigInteger(null)}function am1(i,x,w,j,c,n){for(;--n>=0;){var v=x*this[i++]+w[j]+c;c=Math.floor(v/67108864),w[j++]=67108863&v}return c}function am2(i,x,w,j,c,n){for(var xl=32767&x,xh=x>>15;--n>=0;){var l=32767&this[i],h=this[i++]>>15,m=xh*l+h*xl;c=((l=xl*l+((32767&m)<<15)+w[j]+(1073741823&c))>>>30)+(m>>>15)+xh*h+(c>>>30),w[j++]=1073741823&l}return c}function am3(i,x,w,j,c,n){for(var xl=16383&x,xh=x>>14;--n>=0;){var l=16383&this[i],h=this[i++]>>14,m=xh*l+h*xl;c=((l=xl*l+((16383&m)<<14)+w[j]+c)>>28)+(m>>14)+xh*h,w[j++]=268435455&l}return c}j_lm&&"Microsoft Internet Explorer"==navigator.appName?(BigInteger.prototype.am=am2,dbits=30):j_lm&&"Netscape"!=navigator.appName?(BigInteger.prototype.am=am1,dbits=26):(BigInteger.prototype.am=am3,dbits=28),BigInteger.prototype.DB=dbits,BigInteger.prototype.DM=(1<<dbits)-1,BigInteger.prototype.DV=1<<dbits;var BI_FP=52;BigInteger.prototype.FV=Math.pow(2,BI_FP),BigInteger.prototype.F1=BI_FP-dbits,BigInteger.prototype.F2=2*dbits-BI_FP;var rr,vv,BI_RM="0123456789abcdefghijklmnopqrstuvwxyz",BI_RC=[];for(rr="0".charCodeAt(0),vv=0;vv<=9;++vv)BI_RC[rr++]=vv;for(rr="a".charCodeAt(0),vv=10;vv<36;++vv)BI_RC[rr++]=vv;for(rr="A".charCodeAt(0),vv=10;vv<36;++vv)BI_RC[rr++]=vv;function int2char(n){return BI_RM.charAt(n)}function intAt(s,i){var c=BI_RC[s.charCodeAt(i)];return null==c?-1:c}function bnpCopyTo(r){for(var i=this.t-1;i>=0;--i)r[i]=this[i];r.t=this.t,r.s=this.s}function bnpFromInt(x){this.t=1,this.s=x<0?-1:0,x>0?this[0]=x:x<-1?this[0]=x+this.DV:this.t=0}function nbv(i){var r=nbi();return r.fromInt(i),r}function bnpFromString(s,b){var k;if(16==b)k=4;else if(8==b)k=3;else if(256==b)k=8;else if(2==b)k=1;else if(32==b)k=5;else{if(4!=b)return void this.fromRadix(s,b);k=2}this.t=0,this.s=0;for(var i=s.length,mi=!1,sh=0;--i>=0;){var x=8==k?255&s[i]:intAt(s,i);x<0?"-"==s.charAt(i)&&(mi=!0):(mi=!1,0==sh?this[this.t++]=x:sh+k>this.DB?(this[this.t-1]|=(x&(1<<this.DB-sh)-1)<<sh,this[this.t++]=x>>this.DB-sh):this[this.t-1]|=x<<sh,(sh+=k)>=this.DB&&(sh-=this.DB))}8==k&&0!=(128&s[0])&&(this.s=-1,sh>0&&(this[this.t-1]|=(1<<this.DB-sh)-1<<sh)),this.clamp(),mi&&BigInteger.ZERO.subTo(this,this)}function bnpClamp(){for(var c=this.s&this.DM;this.t>0&&this[this.t-1]==c;)--this.t}function bnToString(b){if(this.s<0)return"-"+this.negate().toString(b);var k;if(16==b)k=4;else if(8==b)k=3;else if(2==b)k=1;else if(32==b)k=5;else{if(4!=b)return this.toRadix(b);k=2}var d,km=(1<<k)-1,m=!1,r="",i=this.t,p=this.DB-i*this.DB%k;if(i-- >0)for(p<this.DB&&(d=this[i]>>p)>0&&(m=!0,r=int2char(d));i>=0;)p<k?(d=(this[i]&(1<<p)-1)<<k-p,d|=this[--i]>>(p+=this.DB-k)):(d=this[i]>>(p-=k)&km,p<=0&&(p+=this.DB,--i)),d>0&&(m=!0),m&&(r+=int2char(d));return m?r:"0"}function bnNegate(){var r=nbi();return BigInteger.ZERO.subTo(this,r),r}function bnAbs(){return this.s<0?this.negate():this}function bnCompareTo(a){var r=this.s-a.s;if(0!=r)return r;var i=this.t;if(0!=(r=i-a.t))return this.s<0?-r:r;for(;--i>=0;)if(0!=(r=this[i]-a[i]))return r;return 0}function nbits(x){var t,r=1;return 0!=(t=x>>>16)&&(x=t,r+=16),0!=(t=x>>8)&&(x=t,r+=8),0!=(t=x>>4)&&(x=t,r+=4),0!=(t=x>>2)&&(x=t,r+=2),0!=(t=x>>1)&&(x=t,r+=1),r}function bnBitLength(){return this.t<=0?0:this.DB*(this.t-1)+nbits(this[this.t-1]^this.s&this.DM)}function bnpDLShiftTo(n,r){var i;for(i=this.t-1;i>=0;--i)r[i+n]=this[i];for(i=n-1;i>=0;--i)r[i]=0;r.t=this.t+n,r.s=this.s}function bnpDRShiftTo(n,r){for(var i=n;i<this.t;++i)r[i-n]=this[i];r.t=Math.max(this.t-n,0),r.s=this.s}function bnpLShiftTo(n,r){var i,bs=n%this.DB,cbs=this.DB-bs,bm=(1<<cbs)-1,ds=Math.floor(n/this.DB),c=this.s<<bs&this.DM;for(i=this.t-1;i>=0;--i)r[i+ds+1]=this[i]>>cbs|c,c=(this[i]&bm)<<bs;for(i=ds-1;i>=0;--i)r[i]=0;r[ds]=c,r.t=this.t+ds+1,r.s=this.s,r.clamp()}function bnpRShiftTo(n,r){r.s=this.s;var ds=Math.floor(n/this.DB);if(ds>=this.t)r.t=0;else{var bs=n%this.DB,cbs=this.DB-bs,bm=(1<<bs)-1;r[0]=this[ds]>>bs;for(var i=ds+1;i<this.t;++i)r[i-ds-1]|=(this[i]&bm)<<cbs,r[i-ds]=this[i]>>bs;bs>0&&(r[this.t-ds-1]|=(this.s&bm)<<cbs),r.t=this.t-ds,r.clamp()}}function bnpSubTo(a,r){for(var i=0,c=0,m=Math.min(a.t,this.t);i<m;)c+=this[i]-a[i],r[i++]=c&this.DM,c>>=this.DB;if(a.t<this.t){for(c-=a.s;i<this.t;)c+=this[i],r[i++]=c&this.DM,c>>=this.DB;c+=this.s}else{for(c+=this.s;i<a.t;)c-=a[i],r[i++]=c&this.DM,c>>=this.DB;c-=a.s}r.s=c<0?-1:0,c<-1?r[i++]=this.DV+c:c>0&&(r[i++]=c),r.t=i,r.clamp()}function bnpMultiplyTo(a,r){var x=this.abs(),y=a.abs(),i=x.t;for(r.t=i+y.t;--i>=0;)r[i]=0;for(i=0;i<y.t;++i)r[i+x.t]=x.am(0,y[i],r,i,0,x.t);r.s=0,r.clamp(),this.s!=a.s&&BigInteger.ZERO.subTo(r,r)}function bnpSquareTo(r){for(var x=this.abs(),i=r.t=2*x.t;--i>=0;)r[i]=0;for(i=0;i<x.t-1;++i){var c=x.am(i,x[i],r,2*i,0,1);(r[i+x.t]+=x.am(i+1,2*x[i],r,2*i+1,c,x.t-i-1))>=x.DV&&(r[i+x.t]-=x.DV,r[i+x.t+1]=1)}r.t>0&&(r[r.t-1]+=x.am(i,x[i],r,2*i,0,1)),r.s=0,r.clamp()}function bnpDivRemTo(m,q,r){var pm=m.abs();if(!(pm.t<=0)){var pt=this.abs();if(pt.t<pm.t)return null!=q&&q.fromInt(0),void(null!=r&&this.copyTo(r));null==r&&(r=nbi());var y=nbi(),ts=this.s,ms=m.s,nsh=this.DB-nbits(pm[pm.t-1]);nsh>0?(pm.lShiftTo(nsh,y),pt.lShiftTo(nsh,r)):(pm.copyTo(y),pt.copyTo(r));var ys=y.t,y0=y[ys-1];if(0!=y0){var yt=y0*(1<<this.F1)+(ys>1?y[ys-2]>>this.F2:0),d1=this.FV/yt,d2=(1<<this.F1)/yt,e=1<<this.F2,i=r.t,j=i-ys,t=null==q?nbi():q;for(y.dlShiftTo(j,t),r.compareTo(t)>=0&&(r[r.t++]=1,r.subTo(t,r)),BigInteger.ONE.dlShiftTo(ys,t),t.subTo(y,y);y.t<ys;)y[y.t++]=0;for(;--j>=0;){var qd=r[--i]==y0?this.DM:Math.floor(r[i]*d1+(r[i-1]+e)*d2);if((r[i]+=y.am(0,qd,r,j,0,ys))<qd)for(y.dlShiftTo(j,t),r.subTo(t,r);r[i]<--qd;)r.subTo(t,r)}null!=q&&(r.drShiftTo(ys,q),ts!=ms&&BigInteger.ZERO.subTo(q,q)),r.t=ys,r.clamp(),nsh>0&&r.rShiftTo(nsh,r),ts<0&&BigInteger.ZERO.subTo(r,r)}}}function bnMod(a){var r=nbi();return this.abs().divRemTo(a,null,r),this.s<0&&r.compareTo(BigInteger.ZERO)>0&&a.subTo(r,r),r}var Classic=function Classic(m){classCallCheck(this,Classic),this.m=m};function cConvert(x){return x.s<0||x.compareTo(this.m)>=0?x.mod(this.m):x}function cRevert(x){return x}function cReduce(x){x.divRemTo(this.m,null,x)}function cMulTo(x,y,r){x.multiplyTo(y,r),this.reduce(r)}function cSqrTo(x,r){x.squareTo(r),this.reduce(r)}function bnpInvDigit(){if(this.t<1)return 0;var x=this[0];if(0==(1&x))return 0;var y=3&x;return(y=(y=(y=(y=y*(2-(15&x)*y)&15)*(2-(255&x)*y)&255)*(2-((65535&x)*y&65535))&65535)*(2-x*y%this.DV)%this.DV)>0?this.DV-y:-y}Classic.prototype.convert=cConvert,Classic.prototype.revert=cRevert,Classic.prototype.reduce=cReduce,Classic.prototype.mulTo=cMulTo,Classic.prototype.sqrTo=cSqrTo;var Montgomery=function Montgomery(m){classCallCheck(this,Montgomery),this.m=m,this.mp=m.invDigit(),this.mpl=32767&this.mp,this.mph=this.mp>>15,this.um=(1<<m.DB-15)-1,this.mt2=2*m.t};function montConvert(x){var r=nbi();return x.abs().dlShiftTo(this.m.t,r),r.divRemTo(this.m,null,r),x.s<0&&r.compareTo(BigInteger.ZERO)>0&&this.m.subTo(r,r),r}function montRevert(x){var r=nbi();return x.copyTo(r),this.reduce(r),r}function montReduce(x){for(;x.t<=this.mt2;)x[x.t++]=0;for(var i=0;i<this.m.t;++i){var j=32767&x[i],u0=j*this.mpl+((j*this.mph+(x[i]>>15)*this.mpl&this.um)<<15)&x.DM;for(x[j=i+this.m.t]+=this.m.am(0,u0,x,i,0,this.m.t);x[j]>=x.DV;)x[j]-=x.DV,x[++j]++}x.clamp(),x.drShiftTo(this.m.t,x),x.compareTo(this.m)>=0&&x.subTo(this.m,x)}function montSqrTo(x,r){x.squareTo(r),this.reduce(r)}function montMulTo(x,y,r){x.multiplyTo(y,r),this.reduce(r)}function bnpIsEven(){return 0==(this.t>0?1&this[0]:this.s)}function bnpExp(e,z){if(e>4294967295||e<1)return BigInteger.ONE;var r=nbi(),r2=nbi(),g=z.convert(this),i=nbits(e)-1;for(g.copyTo(r);--i>=0;)if(z.sqrTo(r,r2),(e&1<<i)>0)z.mulTo(r2,g,r);else{var t=r;r=r2,r2=t}return z.revert(r)}function bnModPowInt(e,m){var z;return z=e<256||m.isEven()?new Classic(m):new Montgomery(m),this.exp(e,z)}function bnClone(){var r=nbi();return this.copyTo(r),r}function bnIntValue(){if(this.s<0){if(1==this.t)return this[0]-this.DV;if(0==this.t)return-1}else{if(1==this.t)return this[0];if(0==this.t)return 0}return(this[1]&(1<<32-this.DB)-1)<<this.DB|this[0]}function bnByteValue(){return 0==this.t?this.s:this[0]<<24>>24}function bnShortValue(){return 0==this.t?this.s:this[0]<<16>>16}function bnpChunkSize(r){return Math.floor(Math.LN2*this.DB/Math.log(r))}function bnSigNum(){return this.s<0?-1:this.t<=0||1==this.t&&this[0]<=0?0:1}function bnpToRadix(b){if(null==b&&(b=10),0==this.signum()||b<2||b>36)return"0";var cs=this.chunkSize(b),a=Math.pow(b,cs),d=nbv(a),y=nbi(),z=nbi(),r="";for(this.divRemTo(d,y,z);y.signum()>0;)r=(a+z.intValue()).toString(b).substr(1)+r,y.divRemTo(d,y,z);return z.intValue().toString(b)+r}function bnpFromRadix(s,b){this.fromInt(0),null==b&&(b=10);for(var cs=this.chunkSize(b),d=Math.pow(b,cs),mi=!1,j=0,w=0,i=0;i<s.length;++i){var x=intAt(s,i);x<0?"-"==s.charAt(i)&&0==this.signum()&&(mi=!0):(w=b*w+x,++j>=cs&&(this.dMultiply(d),this.dAddOffset(w,0),j=0,w=0))}j>0&&(this.dMultiply(Math.pow(b,j)),this.dAddOffset(w,0)),mi&&BigInteger.ZERO.subTo(this,this)}function bnpFromNumber(a,b,c){if("number"==typeof b)if(a<2)this.fromInt(1);else for(this.fromNumber(a,c),this.testBit(a-1)||this.bitwiseTo(BigInteger.ONE.shiftLeft(a-1),op_or,this),this.isEven()&&this.dAddOffset(1,0);!this.isProbablePrime(b);)this.dAddOffset(2,0),this.bitLength()>a&&this.subTo(BigInteger.ONE.shiftLeft(a-1),this);else{var x=[],t=7&a;x.length=1+(a>>3),b.nextBytes(x),t>0?x[0]&=(1<<t)-1:x[0]=0,this.fromString(x,256)}}function bnToByteArray(){var i=this.t,r=[];r[0]=this.s;var d,p=this.DB-i*this.DB%8,k=0;if(i-- >0)for(p<this.DB&&(d=this[i]>>p)!=(this.s&this.DM)>>p&&(r[k++]=d|this.s<<this.DB-p);i>=0;)p<8?(d=(this[i]&(1<<p)-1)<<8-p,d|=this[--i]>>(p+=this.DB-8)):(d=this[i]>>(p-=8)&255,p<=0&&(p+=this.DB,--i)),0!=(128&d)&&(d|=-256),0==k&&(128&this.s)!=(128&d)&&++k,(k>0||d!=this.s)&&(r[k++]=d);return r}function bnEquals(a){return 0==this.compareTo(a)}function bnMin(a){return this.compareTo(a)<0?this:a}function bnMax(a){return this.compareTo(a)>0?this:a}function bnpBitwiseTo(a,op,r){var i,f,m=Math.min(a.t,this.t);for(i=0;i<m;++i)r[i]=op(this[i],a[i]);if(a.t<this.t){for(f=a.s&this.DM,i=m;i<this.t;++i)r[i]=op(this[i],f);r.t=this.t}else{for(f=this.s&this.DM,i=m;i<a.t;++i)r[i]=op(f,a[i]);r.t=a.t}r.s=op(this.s,a.s),r.clamp()}function op_and(x,y){return x&y}function bnAnd(a){var r=nbi();return this.bitwiseTo(a,op_and,r),r}function op_or(x,y){return x|y}function bnOr(a){var r=nbi();return this.bitwiseTo(a,op_or,r),r}function op_xor(x,y){return x^y}function bnXor(a){var r=nbi();return this.bitwiseTo(a,op_xor,r),r}function op_andnot(x,y){return x&~y}function bnAndNot(a){var r=nbi();return this.bitwiseTo(a,op_andnot,r),r}function bnNot(){for(var r=nbi(),i=0;i<this.t;++i)r[i]=this.DM&~this[i];return r.t=this.t,r.s=~this.s,r}function bnShiftLeft(n){var r=nbi();return n<0?this.rShiftTo(-n,r):this.lShiftTo(n,r),r}function bnShiftRight(n){var r=nbi();return n<0?this.lShiftTo(-n,r):this.rShiftTo(n,r),r}function lbit(x){if(0==x)return-1;var r=0;return 0==(65535&x)&&(x>>=16,r+=16),0==(255&x)&&(x>>=8,r+=8),0==(15&x)&&(x>>=4,r+=4),0==(3&x)&&(x>>=2,r+=2),0==(1&x)&&++r,r}function bnGetLowestSetBit(){for(var i=0;i<this.t;++i)if(0!=this[i])return i*this.DB+lbit(this[i]);return this.s<0?this.t*this.DB:-1}function cbit(x){for(var r=0;0!=x;)x&=x-1,++r;return r}function bnBitCount(){for(var r=0,x=this.s&this.DM,i=0;i<this.t;++i)r+=cbit(this[i]^x);return r}function bnTestBit(n){var j=Math.floor(n/this.DB);return j>=this.t?0!=this.s:0!=(this[j]&1<<n%this.DB)}function bnpChangeBit(n,op){var r=BigInteger.ONE.shiftLeft(n);return this.bitwiseTo(r,op,r),r}function bnSetBit(n){return this.changeBit(n,op_or)}function bnClearBit(n){return this.changeBit(n,op_andnot)}function bnFlipBit(n){return this.changeBit(n,op_xor)}function bnpAddTo(a,r){for(var i=0,c=0,m=Math.min(a.t,this.t);i<m;)c+=this[i]+a[i],r[i++]=c&this.DM,c>>=this.DB;if(a.t<this.t){for(c+=a.s;i<this.t;)c+=this[i],r[i++]=c&this.DM,c>>=this.DB;c+=this.s}else{for(c+=this.s;i<a.t;)c+=a[i],r[i++]=c&this.DM,c>>=this.DB;c+=a.s}r.s=c<0?-1:0,c>0?r[i++]=c:c<-1&&(r[i++]=this.DV+c),r.t=i,r.clamp()}function bnAdd(a){var r=nbi();return this.addTo(a,r),r}function bnSubtract(a){var r=nbi();return this.subTo(a,r),r}function bnMultiply(a){var r=nbi();return this.multiplyTo(a,r),r}function bnSquare(){var r=nbi();return this.squareTo(r),r}function bnDivide(a){var r=nbi();return this.divRemTo(a,r,null),r}function bnRemainder(a){var r=nbi();return this.divRemTo(a,null,r),r}function bnDivideAndRemainder(a){var q=nbi(),r=nbi();return this.divRemTo(a,q,r),new Array(q,r)}function bnpDMultiply(n){this[this.t]=this.am(0,n-1,this,0,0,this.t),++this.t,this.clamp()}function bnpDAddOffset(n,w){if(0!=n){for(;this.t<=w;)this[this.t++]=0;for(this[w]+=n;this[w]>=this.DV;)this[w]-=this.DV,++w>=this.t&&(this[this.t++]=0),++this[w]}}function NullExp(){}function nNop(x){return x}function nMulTo(x,y,r){x.multiplyTo(y,r)}function nSqrTo(x,r){x.squareTo(r)}function bnPow(e){return this.exp(e,new NullExp)}function bnpMultiplyLowerTo(a,n,r){var j,i=Math.min(this.t+a.t,n);for(r.s=0,r.t=i;i>0;)r[--i]=0;for(j=r.t-this.t;i<j;++i)r[i+this.t]=this.am(0,a[i],r,i,0,this.t);for(j=Math.min(a.t,n);i<j;++i)this.am(0,a[i],r,i,0,n-i);r.clamp()}function bnpMultiplyUpperTo(a,n,r){--n;var i=r.t=this.t+a.t-n;for(r.s=0;--i>=0;)r[i]=0;for(i=Math.max(n-this.t,0);i<a.t;++i)r[this.t+i-n]=this.am(n-i,a[i],r,0,0,this.t+i-n);r.clamp(),r.drShiftTo(1,r)}function Barrett(m){this.r2=nbi(),this.q3=nbi(),BigInteger.ONE.dlShiftTo(2*m.t,this.r2),this.mu=this.r2.divide(m),this.m=m}function barrettConvert(x){if(x.s<0||x.t>2*this.m.t)return x.mod(this.m);if(x.compareTo(this.m)<0)return x;var r=nbi();return x.copyTo(r),this.reduce(r),r}function barrettRevert(x){return x}function barrettReduce(x){for(x.drShiftTo(this.m.t-1,this.r2),x.t>this.m.t+1&&(x.t=this.m.t+1,x.clamp()),this.mu.multiplyUpperTo(this.r2,this.m.t+1,this.q3),this.m.multiplyLowerTo(this.q3,this.m.t+1,this.r2);x.compareTo(this.r2)<0;)x.dAddOffset(1,this.m.t+1);for(x.subTo(this.r2,x);x.compareTo(this.m)>=0;)x.subTo(this.m,x)}function barrettSqrTo(x,r){x.squareTo(r),this.reduce(r)}function barrettMulTo(x,y,r){x.multiplyTo(y,r),this.reduce(r)}function bnModPow(e,m){var k,z,i=e.bitLength(),r=nbv(1);if(i<=0)return r;k=i<18?1:i<48?3:i<144?4:i<768?5:6,z=i<8?new Classic(m):m.isEven()?new Barrett(m):new Montgomery(m);var g=[],n=3,k1=k-1,km=(1<<k)-1;if(g[1]=z.convert(this),k>1){var g2=nbi();for(z.sqrTo(g[1],g2);n<=km;)g[n]=nbi(),z.mulTo(g2,g[n-2],g[n]),n+=2}var w,t,j=e.t-1,is1=!0,r2=nbi();for(i=nbits(e[j])-1;j>=0;){for(i>=k1?w=e[j]>>i-k1&km:(w=(e[j]&(1<<i+1)-1)<<k1-i,j>0&&(w|=e[j-1]>>this.DB+i-k1)),n=k;0==(1&w);)w>>=1,--n;if((i-=n)<0&&(i+=this.DB,--j),is1)g[w].copyTo(r),is1=!1;else{for(;n>1;)z.sqrTo(r,r2),z.sqrTo(r2,r),n-=2;n>0?z.sqrTo(r,r2):(t=r,r=r2,r2=t),z.mulTo(r2,g[w],r)}for(;j>=0&&0==(e[j]&1<<i);)z.sqrTo(r,r2),t=r,r=r2,r2=t,--i<0&&(i=this.DB-1,--j)}return z.revert(r)}function bnGCD(a){var x=this.s<0?this.negate():this.clone(),y=a.s<0?a.negate():a.clone();if(x.compareTo(y)<0){var t=x;x=y,y=t}var i=x.getLowestSetBit(),g=y.getLowestSetBit();if(g<0)return x;for(i<g&&(g=i),g>0&&(x.rShiftTo(g,x),y.rShiftTo(g,y));x.signum()>0;)(i=x.getLowestSetBit())>0&&x.rShiftTo(i,x),(i=y.getLowestSetBit())>0&&y.rShiftTo(i,y),x.compareTo(y)>=0?(x.subTo(y,x),x.rShiftTo(1,x)):(y.subTo(x,y),y.rShiftTo(1,y));return g>0&&y.lShiftTo(g,y),y}function bnpModInt(n){if(n<=0)return 0;var d=this.DV%n,r=this.s<0?n-1:0;if(this.t>0)if(0==d)r=this[0]%n;else for(var i=this.t-1;i>=0;--i)r=(d*r+this[i])%n;return r}function bnModInverse(m){var ac=m.isEven();if(this.isEven()&&ac||0==m.signum())return BigInteger.ZERO;for(var u=m.clone(),v=this.clone(),a=nbv(1),b=nbv(0),c=nbv(0),d=nbv(1);0!=u.signum();){for(;u.isEven();)u.rShiftTo(1,u),ac?(a.isEven()&&b.isEven()||(a.addTo(this,a),b.subTo(m,b)),a.rShiftTo(1,a)):b.isEven()||b.subTo(m,b),b.rShiftTo(1,b);for(;v.isEven();)v.rShiftTo(1,v),ac?(c.isEven()&&d.isEven()||(c.addTo(this,c),d.subTo(m,d)),c.rShiftTo(1,c)):d.isEven()||d.subTo(m,d),d.rShiftTo(1,d);u.compareTo(v)>=0?(u.subTo(v,u),ac&&a.subTo(c,a),b.subTo(d,b)):(v.subTo(u,v),ac&&c.subTo(a,c),d.subTo(b,d))}return 0!=v.compareTo(BigInteger.ONE)?BigInteger.ZERO:d.compareTo(m)>=0?d.subtract(m):d.signum()<0?(d.addTo(m,d),d.signum()<0?d.add(m):d):d}Montgomery.prototype.convert=montConvert,Montgomery.prototype.revert=montRevert,Montgomery.prototype.reduce=montReduce,Montgomery.prototype.mulTo=montMulTo,Montgomery.prototype.sqrTo=montSqrTo,BigInteger.prototype.copyTo=bnpCopyTo,BigInteger.prototype.fromInt=bnpFromInt,BigInteger.prototype.fromString=bnpFromString,BigInteger.prototype.clamp=bnpClamp,BigInteger.prototype.dlShiftTo=bnpDLShiftTo,BigInteger.prototype.drShiftTo=bnpDRShiftTo,BigInteger.prototype.lShiftTo=bnpLShiftTo,BigInteger.prototype.rShiftTo=bnpRShiftTo,BigInteger.prototype.subTo=bnpSubTo,BigInteger.prototype.multiplyTo=bnpMultiplyTo,BigInteger.prototype.squareTo=bnpSquareTo,BigInteger.prototype.divRemTo=bnpDivRemTo,BigInteger.prototype.invDigit=bnpInvDigit,BigInteger.prototype.isEven=bnpIsEven,BigInteger.prototype.exp=bnpExp,BigInteger.prototype.toString=bnToString,BigInteger.prototype.negate=bnNegate,BigInteger.prototype.abs=bnAbs,BigInteger.prototype.compareTo=bnCompareTo,BigInteger.prototype.bitLength=bnBitLength,BigInteger.prototype.mod=bnMod,BigInteger.prototype.modPowInt=bnModPowInt,BigInteger.ZERO=nbv(0),BigInteger.ONE=nbv(1),NullExp.prototype.convert=nNop,NullExp.prototype.revert=nNop,NullExp.prototype.mulTo=nMulTo,NullExp.prototype.sqrTo=nSqrTo,Barrett.prototype.convert=barrettConvert,Barrett.prototype.revert=barrettRevert,Barrett.prototype.reduce=barrettReduce,Barrett.prototype.mulTo=barrettMulTo,Barrett.prototype.sqrTo=barrettSqrTo;var lowprimes=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509,521,523,541,547,557,563,569,571,577,587,593,599,601,607,613,617,619,631,641,643,647,653,659,661,673,677,683,691,701,709,719,727,733,739,743,751,757,761,769,773,787,797,809,811,821,823,827,829,839,853,857,859,863,877,881,883,887,907,911,919,929,937,941,947,953,967,971,977,983,991,997],lplim=(1<<26)/lowprimes[lowprimes.length-1];function bnIsProbablePrime(t){var i,x=this.abs();if(1==x.t&&x[0]<=lowprimes[lowprimes.length-1]){for(i=0;i<lowprimes.length;++i)if(x[0]==lowprimes[i])return!0;return!1}if(x.isEven())return!1;for(i=1;i<lowprimes.length;){for(var m=lowprimes[i],j=i+1;j<lowprimes.length&&m<lplim;)m*=lowprimes[j++];for(m=x.modInt(m);i<j;)if(m%lowprimes[i++]==0)return!1}return x.millerRabin(t)}function bnpMillerRabin(t){var n1=this.subtract(BigInteger.ONE),k=n1.getLowestSetBit();if(k<=0)return!1;var r=n1.shiftRight(k);(t=t+1>>1)>lowprimes.length&&(t=lowprimes.length);for(var a=nbi(),i=0;i<t;++i){a.fromInt(lowprimes[Math.floor(Math.random()*lowprimes.length)]);var y=a.modPow(r,this);if(0!=y.compareTo(BigInteger.ONE)&&0!=y.compareTo(n1)){for(var j=1;j++<k&&0!=y.compareTo(n1);)if(0==(y=y.modPowInt(2,this)).compareTo(BigInteger.ONE))return!1;if(0!=y.compareTo(n1))return!1}}return!0}function parseBigInt(str,r){return new BigInteger(str,r)}function pkcs1pad2(s,n){if(n<s.length+11)return console.error("Message too long for RSA"),null;for(var ba=[],i=s.length-1;i>=0&&n>0;){var c=s.charCodeAt(i--);c<128?ba[--n]=c:c>127&&c<2048?(ba[--n]=63&c|128,ba[--n]=c>>6|192):(ba[--n]=63&c|128,ba[--n]=c>>6&63|128,ba[--n]=c>>12|224)}ba[--n]=0;for(var rng=new SecureRandom,x=[];n>2;){for(x[0]=0;0==x[0];)rng.nextBytes(x);ba[--n]=x[0]}return ba[--n]=2,ba[--n]=0,new BigInteger(ba)}BigInteger.prototype.chunkSize=bnpChunkSize,BigInteger.prototype.toRadix=bnpToRadix,BigInteger.prototype.fromRadix=bnpFromRadix,BigInteger.prototype.fromNumber=bnpFromNumber,BigInteger.prototype.bitwiseTo=bnpBitwiseTo,BigInteger.prototype.changeBit=bnpChangeBit,BigInteger.prototype.addTo=bnpAddTo,BigInteger.prototype.dMultiply=bnpDMultiply,BigInteger.prototype.dAddOffset=bnpDAddOffset,BigInteger.prototype.multiplyLowerTo=bnpMultiplyLowerTo,BigInteger.prototype.multiplyUpperTo=bnpMultiplyUpperTo,BigInteger.prototype.modInt=bnpModInt,BigInteger.prototype.millerRabin=bnpMillerRabin,BigInteger.prototype.clone=bnClone,BigInteger.prototype.intValue=bnIntValue,BigInteger.prototype.byteValue=bnByteValue,BigInteger.prototype.shortValue=bnShortValue,BigInteger.prototype.signum=bnSigNum,BigInteger.prototype.toByteArray=bnToByteArray,BigInteger.prototype.equals=bnEquals,BigInteger.prototype.min=bnMin,BigInteger.prototype.max=bnMax,BigInteger.prototype.and=bnAnd,BigInteger.prototype.or=bnOr,BigInteger.prototype.xor=bnXor,BigInteger.prototype.andNot=bnAndNot,BigInteger.prototype.not=bnNot,BigInteger.prototype.shiftLeft=bnShiftLeft,BigInteger.prototype.shiftRight=bnShiftRight,BigInteger.prototype.getLowestSetBit=bnGetLowestSetBit,BigInteger.prototype.bitCount=bnBitCount,BigInteger.prototype.testBit=bnTestBit,BigInteger.prototype.setBit=bnSetBit,BigInteger.prototype.clearBit=bnClearBit,BigInteger.prototype.flipBit=bnFlipBit,BigInteger.prototype.add=bnAdd,BigInteger.prototype.subtract=bnSubtract,BigInteger.prototype.multiply=bnMultiply,BigInteger.prototype.divide=bnDivide,BigInteger.prototype.remainder=bnRemainder,BigInteger.prototype.divideAndRemainder=bnDivideAndRemainder,BigInteger.prototype.modPow=bnModPow,BigInteger.prototype.modInverse=bnModInverse,BigInteger.prototype.pow=bnPow,BigInteger.prototype.gcd=bnGCD,BigInteger.prototype.isProbablePrime=bnIsProbablePrime,BigInteger.prototype.square=bnSquare;var RSAKey=function RSAKey(){classCallCheck(this,RSAKey),this.n=null,this.e=0,this.d=null,this.p=null,this.q=null,this.dmp1=null,this.dmq1=null,this.coeff=null};function RSASetPublic(N,E){null!=N&&null!=E&&N.length>0&&E.length>0?(this.n=parseBigInt(N,16),this.e=parseInt(E,16)):console.error("Invalid RSA public key")}function RSADoPublic(x){return x.modPowInt(this.e,this.n)}function RSAEncrypt(text){var m=pkcs1pad2(text,this.n.bitLength()+7>>3);if(null==m)return null;var c=this.doPublic(m);if(null==c)return null;var h=c.toString(16);return 0==(1&h.length)?h:"0"+h}function pkcs1unpad2(d,n){for(var b=d.toByteArray(),i=0;i<b.length&&0==b[i];)++i;if(b.length-i!=n-1||2!=b[i])return null;for(++i;0!=b[i];)if(++i>=b.length)return null;for(var ret="";++i<b.length;){var c=255&b[i];c<128?ret+=String.fromCharCode(c):c>191&&c<224?(ret+=String.fromCharCode((31&c)<<6|63&b[i+1]),++i):(ret+=String.fromCharCode((15&c)<<12|(63&b[i+1])<<6|63&b[i+2]),i+=2)}return ret}function RSASetPrivate(N,E,D){null!=N&&null!=E&&N.length>0&&E.length>0?(this.n=parseBigInt(N,16),this.e=parseInt(E,16),this.d=parseBigInt(D,16)):console.error("Invalid RSA private key")}function RSASetPrivateEx(N,E,D,P,Q,DP,DQ,C){null!=N&&null!=E&&N.length>0&&E.length>0?(this.n=parseBigInt(N,16),this.e=parseInt(E,16),this.d=parseBigInt(D,16),this.p=parseBigInt(P,16),this.q=parseBigInt(Q,16),this.dmp1=parseBigInt(DP,16),this.dmq1=parseBigInt(DQ,16),this.coeff=parseBigInt(C,16)):console.error("Invalid RSA private key")}function RSAGenerate(B,E){var rng=new SecureRandom,qs=B>>1;this.e=parseInt(E,16);for(var ee=new BigInteger(E,16);;){for(;this.p=new BigInteger(B-qs,1,rng),0!=this.p.subtract(BigInteger.ONE).gcd(ee).compareTo(BigInteger.ONE)||!this.p.isProbablePrime(10););for(;this.q=new BigInteger(qs,1,rng),0!=this.q.subtract(BigInteger.ONE).gcd(ee).compareTo(BigInteger.ONE)||!this.q.isProbablePrime(10););if(this.p.compareTo(this.q)<=0){var t=this.p;this.p=this.q,this.q=t}var p1=this.p.subtract(BigInteger.ONE),q1=this.q.subtract(BigInteger.ONE),phi=p1.multiply(q1);if(0==phi.gcd(ee).compareTo(BigInteger.ONE)){this.n=this.p.multiply(this.q),this.d=ee.modInverse(phi),this.dmp1=this.d.mod(p1),this.dmq1=this.d.mod(q1),this.coeff=this.q.modInverse(this.p);break}}}function RSADoPrivate(x){if(null==this.p||null==this.q)return x.modPow(this.d,this.n);for(var xp=x.mod(this.p).modPow(this.dmp1,this.p),xq=x.mod(this.q).modPow(this.dmq1,this.q);xp.compareTo(xq)<0;)xp=xp.add(this.p);return xp.subtract(xq).multiply(this.coeff).mod(this.p).multiply(this.q).add(xq)}function RSADecrypt(ctext){var c=parseBigInt(ctext,16),m=this.doPrivate(c);return null==m?null:pkcs1unpad2(m,this.n.bitLength()+7>>3)}RSAKey.prototype.doPublic=RSADoPublic,RSAKey.prototype.setPublic=RSASetPublic,RSAKey.prototype.encrypt=RSAEncrypt,RSAKey.prototype.doPrivate=RSADoPrivate,RSAKey.prototype.setPrivate=RSASetPrivate,RSAKey.prototype.setPrivateEx=RSASetPrivateEx,RSAKey.prototype.generate=RSAGenerate,RSAKey.prototype.decrypt=RSADecrypt;var Base64={},decoder=void 0;Base64.decode=function(a){var i;if(void 0===decoder){var ignore="= \f\n\r\t \u2028\u2029";for(decoder=[],i=0;i<64;++i)decoder["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(i)]=i;for(i=0;i<ignore.length;++i)decoder[ignore.charAt(i)]=-1}var out=[],bits=0,char_count=0;for(i=0;i<a.length;++i){var c=a.charAt(i);if("="==c)break;if(-1!=(c=decoder[c])){if(void 0===c)throw"Illegal character at offset "+i;bits|=c,++char_count>=4?(out[out.length]=bits>>16,out[out.length]=bits>>8&255,out[out.length]=255&bits,bits=0,char_count=0):bits<<=6}}switch(char_count){case 1:throw"Base64 encoding incomplete: at least 2 bits missing";case 2:out[out.length]=bits>>10;break;case 3:out[out.length]=bits>>16,out[out.length]=bits>>8&255}return out},Base64.re=/-----BEGIN [^-]+-----([A-Za-z0-9+\/=\s]+)-----END [^-]+-----|begin-base64[^\n]+\n([A-Za-z0-9+\/=\s]+)====/,Base64.unarmor=function(a){var m=Base64.re.exec(a);if(m)if(m[1])a=m[1];else{if(!m[2])throw"RegExp out of sync";a=m[2]}return Base64.decode(a)};var Hex={},decoder$1=void 0;Hex.decode=function(a){var i;if(void 0===decoder$1){var hex="0123456789ABCDEF",ignore=" \f\n\r\t \u2028\u2029";for(decoder$1=[],i=0;i<16;++i)decoder$1[hex.charAt(i)]=i;for(hex=hex.toLowerCase(),i=10;i<16;++i)decoder$1[hex.charAt(i)]=i;for(i=0;i<ignore.length;++i)decoder$1[ignore.charAt(i)]=-1}var out=[],bits=0,char_count=0;for(i=0;i<a.length;++i){var c=a.charAt(i);if("="==c)break;if(-1!=(c=decoder$1[c])){if(void 0===c)throw"Illegal character at offset "+i;bits|=c,++char_count>=2?(out[out.length]=bits,bits=0,char_count=0):bits<<=4}}if(char_count)throw"Hex encoding incomplete: 4 bits missing";return out};var JSX={};JSX.env=JSX.env||{};var L=JSX,OP=Object.prototype,FUNCTION_TOSTRING="[object Function]",ADD=["toString","valueOf"];JSX.env.parseUA=function(agent){var m,numberify=function(s){var c=0;return parseFloat(s.replace(/\./g,function(){return 1==c++?"":"."}))},nav=navigator,o={ie:0,opera:0,gecko:0,webkit:0,chrome:0,mobile:null,air:0,ipad:0,iphone:0,ipod:0,ios:null,android:0,webos:0,caja:nav&&nav.cajaVersion,secure:!1,os:null},ua=agent||navigator&&navigator.userAgent,loc=window&&window.location,href=loc&&loc.href;return o.secure=href&&0===href.toLowerCase().indexOf("https"),ua&&(/windows|win32/i.test(ua)?o.os="windows":/macintosh/i.test(ua)?o.os="macintosh":/rhino/i.test(ua)&&(o.os="rhino"),/KHTML/.test(ua)&&(o.webkit=1),(m=ua.match(/AppleWebKit\/([^\s]*)/))&&m[1]&&(o.webkit=numberify(m[1]),/ Mobile\//.test(ua)?(o.mobile="Apple",(m=ua.match(/OS ([^\s]*)/))&&m[1]&&(m=numberify(m[1].replace("_","."))),o.ios=m,o.ipad=o.ipod=o.iphone=0,(m=ua.match(/iPad|iPod|iPhone/))&&m[0]&&(o[m[0].toLowerCase()]=o.ios)):((m=ua.match(/NokiaN[^\/]*|Android \d\.\d|webOS\/\d\.\d/))&&(o.mobile=m[0]),/webOS/.test(ua)&&(o.mobile="WebOS",(m=ua.match(/webOS\/([^\s]*);/))&&m[1]&&(o.webos=numberify(m[1]))),/ Android/.test(ua)&&(o.mobile="Android",(m=ua.match(/Android ([^\s]*);/))&&m[1]&&(o.android=numberify(m[1])))),(m=ua.match(/Chrome\/([^\s]*)/))&&m[1]?o.chrome=numberify(m[1]):(m=ua.match(/AdobeAIR\/([^\s]*)/))&&(o.air=m[0])),o.webkit||((m=ua.match(/Opera[\s\/]([^\s]*)/))&&m[1]?(o.opera=numberify(m[1]),(m=ua.match(/Version\/([^\s]*)/))&&m[1]&&(o.opera=numberify(m[1])),(m=ua.match(/Opera Mini[^;]*/))&&(o.mobile=m[0])):(m=ua.match(/MSIE\s([^;]*)/))&&m[1]?o.ie=numberify(m[1]):(m=ua.match(/Gecko\/([^\s]*)/))&&(o.gecko=1,(m=ua.match(/rv:([^\s\)]*)/))&&m[1]&&(o.gecko=numberify(m[1]))))),o},JSX.env.ua=JSX.env.parseUA(),JSX.isFunction=function(o){return"function"==typeof o||OP.toString.apply(o)===FUNCTION_TOSTRING},JSX._IEEnumFix=JSX.env.ua.ie?function(r,s){var i,fname,f;for(i=0;i<ADD.length;i+=1)f=s[fname=ADD[i]],L.isFunction(f)&&f!=OP[fname]&&(r[fname]=f)}:function(){},JSX.extend=function(subc,superc,overrides){if(!superc||!subc)throw new Error("extend failed, please check that all dependencies are included.");var i,F=function(){};if(F.prototype=superc.prototype,subc.prototype=new F,subc.prototype.constructor=subc,subc.superclass=superc.prototype,superc.prototype.constructor==OP.constructor&&(superc.prototype.constructor=superc),overrides){for(i in overrides)L.hasOwnProperty(overrides,i)&&(subc.prototype[i]=overrides[i]);L._IEEnumFix(subc.prototype,overrides)}};var KJUR={};void 0!==KJUR.asn1&&KJUR.asn1||(KJUR.asn1={}),KJUR.asn1.ASN1Util=new function(){this.integerToByteHex=function(i){var h=i.toString(16);return h.length%2==1&&(h="0"+h),h},this.bigIntToMinTwosComplementsHex=function(bigIntegerValue){var h=bigIntegerValue.toString(16);if("-"!=h.substr(0,1))h.length%2==1?h="0"+h:h.match(/^[0-7]/)||(h="00"+h);else{var xorLen=h.substr(1).length;xorLen%2==1?xorLen+=1:h.match(/^[0-7]/)||(xorLen+=2);for(var hMask="",i=0;i<xorLen;i++)hMask+="f";h=new BigInteger(hMask,16).xor(bigIntegerValue).add(BigInteger.ONE).toString(16).replace(/^-/,"")}return h},this.getPEMStringFromHex=function(dataHex,pemHeader){var dataWA=CryptoJS.enc.Hex.parse(dataHex),pemBody=CryptoJS.enc.Base64.stringify(dataWA).replace(/(.{64})/g,"$1\r\n");return"-----BEGIN "+pemHeader+"-----\r\n"+(pemBody=pemBody.replace(/\r\n$/,""))+"\r\n-----END "+pemHeader+"-----\r\n"}},KJUR.asn1.ASN1Object=function(){this.getLengthHexFromValue=function(){if(void 0===this.hV||null==this.hV)throw"this.hV is null or undefined.";if(this.hV.length%2==1)throw"value hex must be even length: n="+"".length+",v="+this.hV;var n=this.hV.length/2,hN=n.toString(16);if(hN.length%2==1&&(hN="0"+hN),n<128)return hN;var hNlen=hN.length/2;if(hNlen>15)throw"ASN.1 length too long to represent by 8x: n = "+n.toString(16);return(128+hNlen).toString(16)+hN},this.getEncodedHex=function(){return(null==this.hTLV||this.isModified)&&(this.hV=this.getFreshValueHex(),this.hL=this.getLengthHexFromValue(),this.hTLV=this.hT+this.hL+this.hV,this.isModified=!1),this.hTLV},this.getValueHex=function(){return this.getEncodedHex(),this.hV},this.getFreshValueHex=function(){return""}},KJUR.asn1.DERAbstractString=function(params){KJUR.asn1.DERAbstractString.superclass.constructor.call(this),this.getString=function(){return this.s},this.setString=function(newS){this.hTLV=null,this.isModified=!0,this.s=newS,this.hV=stohex(this.s)},this.setStringHex=function(newHexString){this.hTLV=null,this.isModified=!0,this.s=null,this.hV=newHexString},this.getFreshValueHex=function(){return this.hV},void 0!==params&&(void 0!==params.str?this.setString(params.str):void 0!==params.hex&&this.setStringHex(params.hex))},JSX.extend(KJUR.asn1.DERAbstractString,KJUR.asn1.ASN1Object),KJUR.asn1.DERAbstractTime=function(params){KJUR.asn1.DERAbstractTime.superclass.constructor.call(this),this.localDateToUTC=function(d){return utc=d.getTime()+6e4*d.getTimezoneOffset(),new Date(utc)},this.formatDate=function(dateObject,type){var pad=this.zeroPadding,d=this.localDateToUTC(dateObject),year=String(d.getFullYear());return"utc"==type&&(year=year.substr(2,2)),year+pad(String(d.getMonth()+1),2)+pad(String(d.getDate()),2)+pad(String(d.getHours()),2)+pad(String(d.getMinutes()),2)+pad(String(d.getSeconds()),2)+"Z"},this.zeroPadding=function(s,len){return s.length>=len?s:new Array(len-s.length+1).join("0")+s},this.getString=function(){return this.s},this.setString=function(newS){this.hTLV=null,this.isModified=!0,this.s=newS,this.hV=stohex(this.s)},this.setByDateValue=function(year,month,day,hour,min,sec){var dateObject=new Date(Date.UTC(year,month-1,day,hour,min,sec,0));this.setByDate(dateObject)},this.getFreshValueHex=function(){return this.hV}},JSX.extend(KJUR.asn1.DERAbstractTime,KJUR.asn1.ASN1Object),KJUR.asn1.DERAbstractStructured=function(params){KJUR.asn1.DERAbstractString.superclass.constructor.call(this),this.setByASN1ObjectArray=function(asn1ObjectArray){this.hTLV=null,this.isModified=!0,this.asn1Array=asn1ObjectArray},this.appendASN1Object=function(asn1Object){this.hTLV=null,this.isModified=!0,this.asn1Array.push(asn1Object)},this.asn1Array=new Array,void 0!==params&&void 0!==params.array&&(this.asn1Array=params.array)},JSX.extend(KJUR.asn1.DERAbstractStructured,KJUR.asn1.ASN1Object),KJUR.asn1.DERBoolean=function(){KJUR.asn1.DERBoolean.superclass.constructor.call(this),this.hT="01",this.hTLV="0101ff"},JSX.extend(KJUR.asn1.DERBoolean,KJUR.asn1.ASN1Object),KJUR.asn1.DERInteger=function(params){KJUR.asn1.DERInteger.superclass.constructor.call(this),this.hT="02",this.setByBigInteger=function(bigIntegerValue){this.hTLV=null,this.isModified=!0,this.hV=KJUR.asn1.ASN1Util.bigIntToMinTwosComplementsHex(bigIntegerValue)},this.setByInteger=function(intValue){var bi=new BigInteger(String(intValue),10);this.setByBigInteger(bi)},this.setValueHex=function(newHexString){this.hV=newHexString},this.getFreshValueHex=function(){return this.hV},void 0!==params&&(void 0!==params.bigint?this.setByBigInteger(params.bigint):void 0!==params.int?this.setByInteger(params.int):void 0!==params.hex&&this.setValueHex(params.hex))},JSX.extend(KJUR.asn1.DERInteger,KJUR.asn1.ASN1Object),KJUR.asn1.DERBitString=function(params){KJUR.asn1.DERBitString.superclass.constructor.call(this),this.hT="03",this.setHexValueIncludingUnusedBits=function(newHexStringIncludingUnusedBits){this.hTLV=null,this.isModified=!0,this.hV=newHexStringIncludingUnusedBits},this.setUnusedBitsAndHexValue=function(unusedBits,hValue){if(unusedBits<0||7<unusedBits)throw"unused bits shall be from 0 to 7: u = "+unusedBits;var hUnusedBits="0"+unusedBits;this.hTLV=null,this.isModified=!0,this.hV=hUnusedBits+hValue},this.setByBinaryString=function(binaryString){var unusedBits=8-(binaryString=binaryString.replace(/0+$/,"")).length%8;8==unusedBits&&(unusedBits=0);for(var i=0;i<=unusedBits;i++)binaryString+="0";var h="";for(i=0;i<binaryString.length-1;i+=8){var b=binaryString.substr(i,8),x=parseInt(b,2).toString(16);1==x.length&&(x="0"+x),h+=x}this.hTLV=null,this.isModified=!0,this.hV="0"+unusedBits+h},this.setByBooleanArray=function(booleanArray){for(var s="",i=0;i<booleanArray.length;i++)1==booleanArray[i]?s+="1":s+="0";this.setByBinaryString(s)},this.newFalseArray=function(nLength){for(var a=new Array(nLength),i=0;i<nLength;i++)a[i]=!1;return a},this.getFreshValueHex=function(){return this.hV},void 0!==params&&(void 0!==params.hex?this.setHexValueIncludingUnusedBits(params.hex):void 0!==params.bin?this.setByBinaryString(params.bin):void 0!==params.array&&this.setByBooleanArray(params.array))},JSX.extend(KJUR.asn1.DERBitString,KJUR.asn1.ASN1Object),KJUR.asn1.DEROctetString=function(params){KJUR.asn1.DEROctetString.superclass.constructor.call(this,params),this.hT="04"},JSX.extend(KJUR.asn1.DEROctetString,KJUR.asn1.DERAbstractString),KJUR.asn1.DERNull=function(){KJUR.asn1.DERNull.superclass.constructor.call(this),this.hT="05",this.hTLV="0500"},JSX.extend(KJUR.asn1.DERNull,KJUR.asn1.ASN1Object),KJUR.asn1.DERObjectIdentifier=function(params){var itox=function(i){var h=i.toString(16);return 1==h.length&&(h="0"+h),h},roidtox=function(roid){var h="",b=new BigInteger(roid,10).toString(2),padLen=7-b.length%7;7==padLen&&(padLen=0);for(var bPad="",i=0;i<padLen;i++)bPad+="0";b=bPad+b;for(i=0;i<b.length-1;i+=7){var b8=b.substr(i,7);i!=b.length-7&&(b8="1"+b8),h+=itox(parseInt(b8,2))}return h};KJUR.asn1.DERObjectIdentifier.superclass.constructor.call(this),this.hT="06",this.setValueHex=function(newHexString){this.hTLV=null,this.isModified=!0,this.s=null,this.hV=newHexString},this.setValueOidString=function(oidString){if(!oidString.match(/^[0-9.]+$/))throw"malformed oid string: "+oidString;var h="",a=oidString.split("."),i0=40*parseInt(a[0])+parseInt(a[1]);h+=itox(i0),a.splice(0,2);for(var i=0;i<a.length;i++)h+=roidtox(a[i]);this.hTLV=null,this.isModified=!0,this.s=null,this.hV=h},this.setValueName=function(oidName){if(void 0===KJUR.asn1.x509.OID.name2oidList[oidName])throw"DERObjectIdentifier oidName undefined: "+oidName;var oid=KJUR.asn1.x509.OID.name2oidList[oidName];this.setValueOidString(oid)},this.getFreshValueHex=function(){return this.hV},void 0!==params&&(void 0!==params.oid?this.setValueOidString(params.oid):void 0!==params.hex?this.setValueHex(params.hex):void 0!==params.name&&this.setValueName(params.name))},JSX.extend(KJUR.asn1.DERObjectIdentifier,KJUR.asn1.ASN1Object),KJUR.asn1.DERUTF8String=function(params){KJUR.asn1.DERUTF8String.superclass.constructor.call(this,params),this.hT="0c"},JSX.extend(KJUR.asn1.DERUTF8String,KJUR.asn1.DERAbstractString),KJUR.asn1.DERNumericString=function(params){KJUR.asn1.DERNumericString.superclass.constructor.call(this,params),this.hT="12"},JSX.extend(KJUR.asn1.DERNumericString,KJUR.asn1.DERAbstractString),KJUR.asn1.DERPrintableString=function(params){KJUR.asn1.DERPrintableString.superclass.constructor.call(this,params),this.hT="13"},JSX.extend(KJUR.asn1.DERPrintableString,KJUR.asn1.DERAbstractString),KJUR.asn1.DERTeletexString=function(params){KJUR.asn1.DERTeletexString.superclass.constructor.call(this,params),this.hT="14"},JSX.extend(KJUR.asn1.DERTeletexString,KJUR.asn1.DERAbstractString),KJUR.asn1.DERIA5String=function(params){KJUR.asn1.DERIA5String.superclass.constructor.call(this,params),this.hT="16"},JSX.extend(KJUR.asn1.DERIA5String,KJUR.asn1.DERAbstractString),KJUR.asn1.DERUTCTime=function(params){KJUR.asn1.DERUTCTime.superclass.constructor.call(this,params),this.hT="17",this.setByDate=function(dateObject){this.hTLV=null,this.isModified=!0,this.date=dateObject,this.s=this.formatDate(this.date,"utc"),this.hV=stohex(this.s)},void 0!==params&&(void 0!==params.str?this.setString(params.str):void 0!==params.hex?this.setStringHex(params.hex):void 0!==params.date&&this.setByDate(params.date))},JSX.extend(KJUR.asn1.DERUTCTime,KJUR.asn1.DERAbstractTime),KJUR.asn1.DERGeneralizedTime=function(params){KJUR.asn1.DERGeneralizedTime.superclass.constructor.call(this,params),this.hT="18",this.setByDate=function(dateObject){this.hTLV=null,this.isModified=!0,this.date=dateObject,this.s=this.formatDate(this.date,"gen"),this.hV=stohex(this.s)},void 0!==params&&(void 0!==params.str?this.setString(params.str):void 0!==params.hex?this.setStringHex(params.hex):void 0!==params.date&&this.setByDate(params.date))},JSX.extend(KJUR.asn1.DERGeneralizedTime,KJUR.asn1.DERAbstractTime),KJUR.asn1.DERSequence=function(params){KJUR.asn1.DERSequence.superclass.constructor.call(this,params),this.hT="30",this.getFreshValueHex=function(){for(var h="",i=0;i<this.asn1Array.length;i++){h+=this.asn1Array[i].getEncodedHex()}return this.hV=h,this.hV}},JSX.extend(KJUR.asn1.DERSequence,KJUR.asn1.DERAbstractStructured),KJUR.asn1.DERSet=function(params){KJUR.asn1.DERSet.superclass.constructor.call(this,params),this.hT="31",this.getFreshValueHex=function(){for(var a=new Array,i=0;i<this.asn1Array.length;i++){var asn1Obj=this.asn1Array[i];a.push(asn1Obj.getEncodedHex())}return a.sort(),this.hV=a.join(""),this.hV}},JSX.extend(KJUR.asn1.DERSet,KJUR.asn1.DERAbstractStructured),KJUR.asn1.DERTaggedObject=function(params){KJUR.asn1.DERTaggedObject.superclass.constructor.call(this),this.hT="a0",this.hV="",this.isExplicit=!0,this.asn1Object=null,this.setASN1Object=function(isExplicitFlag,tagNoHex,asn1Object){this.hT=tagNoHex,this.isExplicit=isExplicitFlag,this.asn1Object=asn1Object,this.isExplicit?(this.hV=this.asn1Object.getEncodedHex(),this.hTLV=null,this.isModified=!0):(this.hV=null,this.hTLV=asn1Object.getEncodedHex(),this.hTLV=this.hTLV.replace(/^../,tagNoHex),this.isModified=!1)},this.getFreshValueHex=function(){return this.hV},void 0!==params&&(void 0!==params.tag&&(this.hT=params.tag),void 0!==params.explicit&&(this.isExplicit=params.explicit),void 0!==params.obj&&(this.asn1Object=params.obj,this.setASN1Object(this.isExplicit,this.hT,this.asn1Object)))},JSX.extend(KJUR.asn1.DERTaggedObject,KJUR.asn1.ASN1Object);var b64map="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",b64pad="=";function hex2b64(h){var i,c,ret="";for(i=0;i+3<=h.length;i+=3)c=parseInt(h.substring(i,i+3),16),ret+=b64map.charAt(c>>6)+b64map.charAt(63&c);for(i+1==h.length?(c=parseInt(h.substring(i,i+1),16),ret+=b64map.charAt(c<<2)):i+2==h.length&&(c=parseInt(h.substring(i,i+2),16),ret+=b64map.charAt(c>>2)+b64map.charAt((3&c)<<4));(3&ret.length)>0;)ret+=b64pad;return ret}function b64tohex(s){var i,slop,ret="",k=0;for(i=0;i<s.length&&s.charAt(i)!=b64pad;++i){var v=b64map.indexOf(s.charAt(i));v<0||(0==k?(ret+=int2char(v>>2),slop=3&v,k=1):1==k?(ret+=int2char(slop<<2|v>>4),slop=15&v,k=2):2==k?(ret+=int2char(slop),ret+=int2char(v>>2),slop=3&v,k=3):(ret+=int2char(slop<<2|v>>4),ret+=int2char(15&v),k=0))}return 1==k&&(ret+=int2char(slop<<2)),ret}ASN1.prototype.getHexStringValue=function(){var hexString=this.toHexString(),offset=2*this.header,length=2*this.length;return hexString.substr(offset,length)},RSAKey.prototype.parseKey=function(pem){try{var modulus=0,public_exponent=0,der=/^\s*(?:[0-9A-Fa-f][0-9A-Fa-f]\s*)+$/.test(pem)?Hex.decode(pem):Base64.unarmor(pem),asn1=ASN1.decode(der);if(3===asn1.sub.length&&(asn1=asn1.sub[2].sub[0]),9===asn1.sub.length){modulus=asn1.sub[1].getHexStringValue(),this.n=parseBigInt(modulus,16),public_exponent=asn1.sub[2].getHexStringValue(),this.e=parseInt(public_exponent,16);var private_exponent=asn1.sub[3].getHexStringValue();this.d=parseBigInt(private_exponent,16);var prime1=asn1.sub[4].getHexStringValue();this.p=parseBigInt(prime1,16);var prime2=asn1.sub[5].getHexStringValue();this.q=parseBigInt(prime2,16);var exponent1=asn1.sub[6].getHexStringValue();this.dmp1=parseBigInt(exponent1,16);var exponent2=asn1.sub[7].getHexStringValue();this.dmq1=parseBigInt(exponent2,16);var coefficient=asn1.sub[8].getHexStringValue();this.coeff=parseBigInt(coefficient,16)}else{if(2!==asn1.sub.length)return!1;var sequence=asn1.sub[1].sub[0];modulus=sequence.sub[0].getHexStringValue(),this.n=parseBigInt(modulus,16),public_exponent=sequence.sub[1].getHexStringValue(),this.e=parseInt(public_exponent,16)}return!0}catch(ex){return!1}},RSAKey.prototype.getPrivateBaseKey=function(){var options={array:[new KJUR.asn1.DERInteger({int:0}),new KJUR.asn1.DERInteger({bigint:this.n}),new KJUR.asn1.DERInteger({int:this.e}),new KJUR.asn1.DERInteger({bigint:this.d}),new KJUR.asn1.DERInteger({bigint:this.p}),new KJUR.asn1.DERInteger({bigint:this.q}),new KJUR.asn1.DERInteger({bigint:this.dmp1}),new KJUR.asn1.DERInteger({bigint:this.dmq1}),new KJUR.asn1.DERInteger({bigint:this.coeff})]};return new KJUR.asn1.DERSequence(options).getEncodedHex()},RSAKey.prototype.getPrivateBaseKeyB64=function(){return hex2b64(this.getPrivateBaseKey())},RSAKey.prototype.getPublicBaseKey=function(){var options={array:[new KJUR.asn1.DERObjectIdentifier({oid:"1.2.840.113549.1.1.1"}),new KJUR.asn1.DERNull]},first_sequence=new KJUR.asn1.DERSequence(options);return options={array:[new KJUR.asn1.DERInteger({bigint:this.n}),new KJUR.asn1.DERInteger({int:this.e})]},options={hex:"00"+new KJUR.asn1.DERSequence(options).getEncodedHex()},options={array:[first_sequence,new KJUR.asn1.DERBitString(options)]},new KJUR.asn1.DERSequence(options).getEncodedHex()},RSAKey.prototype.getPublicBaseKeyB64=function(){return hex2b64(this.getPublicBaseKey())},RSAKey.prototype.wordwrap=function(str,width){if(width=width||64,!str)return str;var regex="(.{1,"+width+"})( +|$\n?)|(.{1,"+width+"})";return str.match(RegExp(regex,"g")).join("\n")},RSAKey.prototype.getPrivateKey=function(){var key="-----BEGIN RSA PRIVATE KEY-----\n";return key+=this.wordwrap(this.getPrivateBaseKeyB64())+"\n",key+="-----END RSA PRIVATE KEY-----"},RSAKey.prototype.getPublicKey=function(){var key="-----BEGIN PUBLIC KEY-----\n";return key+=this.wordwrap(this.getPublicBaseKeyB64())+"\n",key+="-----END PUBLIC KEY-----"},RSAKey.prototype.hasPublicKeyProperty=function(obj){return(obj=obj||{}).hasOwnProperty("n")&&obj.hasOwnProperty("e")},RSAKey.prototype.hasPrivateKeyProperty=function(obj){return(obj=obj||{}).hasOwnProperty("n")&&obj.hasOwnProperty("e")&&obj.hasOwnProperty("d")&&obj.hasOwnProperty("p")&&obj.hasOwnProperty("q")&&obj.hasOwnProperty("dmp1")&&obj.hasOwnProperty("dmq1")&&obj.hasOwnProperty("coeff")},RSAKey.prototype.parsePropertiesFrom=function(obj){this.n=obj.n,this.e=obj.e,obj.hasOwnProperty("d")&&(this.d=obj.d,this.p=obj.p,this.q=obj.q,this.dmp1=obj.dmp1,this.dmq1=obj.dmq1,this.coeff=obj.coeff)};var JSEncryptRSAKey=function(_RSAKey){function JSEncryptRSAKey(key){classCallCheck(this,JSEncryptRSAKey);var _this=possibleConstructorReturn(this,(JSEncryptRSAKey.__proto__||Object.getPrototypeOf(JSEncryptRSAKey)).call(this));return key&&("string"==typeof key?_this.parseKey(key):(_this.hasPrivateKeyProperty(key)||_this.hasPublicKeyProperty(key))&&_this.parsePropertiesFrom(key)),_this}return inherits(JSEncryptRSAKey,RSAKey),JSEncryptRSAKey}(),JSEncrypt=function JSEncrypt(options){classCallCheck(this,JSEncrypt),options=options||{},this.default_key_size=parseInt(options.default_key_size)||1024,this.default_public_exponent=options.default_public_exponent||"010001",this.log=options.log||!1,this.key=null};JSEncrypt.prototype.setKey=function(key){this.log&&this.key&&console.warn("A key was already set, overriding existing."),this.key=new JSEncryptRSAKey(key)},JSEncrypt.prototype.setPrivateKey=function(privkey){this.setKey(privkey)},JSEncrypt.prototype.setPublicKey=function(pubkey){this.setKey(pubkey)},JSEncrypt.prototype.decrypt=function(string){try{return this.getKey().decrypt(b64tohex(string))}catch(ex){return!1}},JSEncrypt.prototype.encrypt=function(string){try{return hex2b64(this.getKey().encrypt(string))}catch(ex){return!1}},JSEncrypt.prototype.getKey=function(cb){if(!this.key){if(this.key=new JSEncryptRSAKey,cb&&"[object Function]"==={}.toString.call(cb))return void this.key.generateAsync(this.default_key_size,this.default_public_exponent,cb);this.key.generate(this.default_key_size,this.default_public_exponent)}return this.key},JSEncrypt.prototype.getPrivateKey=function(){return this.getKey().getPrivateKey()},JSEncrypt.prototype.getPrivateKeyB64=function(){return this.getKey().getPrivateBaseKeyB64()},JSEncrypt.prototype.getPublicKey=function(){return this.getKey().getPublicKey()},JSEncrypt.prototype.getPublicKeyB64=function(){return this.getKey().getPublicBaseKeyB64()};var BaseRequest=function(){function BaseRequest(data){classCallCheck(this,BaseRequest),this.data=data,this.before=function(data){return Promise.resolve(data)}}return createClass(BaseRequest,[{key:"send",value:function(){return this.before(this.data)}},{key:"before",value:function(fn){return Promise.resolve}}]),BaseRequest}(),BaseTransport=function(){function BaseTransport(endpoint,stream_type){classCallCheck(this,BaseTransport),this.stream_type=stream_type,this.endpoint=endpoint,this.eventSource=new EventEmitter,this.dataQueue=[]}return createClass(BaseTransport,[{key:"destroy",value:function(){this.eventSource.destroy()}},{key:"connect",value:function(){}},{key:"disconnect",value:function(){}},{key:"reconnect",value:function(){var _this=this;return this.disconnect().then(function(){return _this.connect()})}},{key:"ready",value:function(){}},{key:"setEndpoint",value:function(endpoint){return this.endpoint=endpoint,this.reconnect()}},{key:"send",value:function(data){}},{key:"prepare",value:function(data){}}],[{key:"canTransfer",value:function(stream_type){return BaseTransport.streamTypes().includes(stream_type)}},{key:"streamTypes",value:function(){return[]}}]),BaseTransport}(),isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),LOG_TAG$3="transport:ws",Log$10=getTagged(LOG_TAG$3),ProtocolError=function(_ExtendableError){function ProtocolError(ty){return classCallCheck(this,ProtocolError),possibleConstructorReturn(this,(ProtocolError.__proto__||Object.getPrototypeOf(ProtocolError)).call(this,"failed to parse "+ty+" websocket protocol"))}return inherits(ProtocolError,ExtendableError),ProtocolError}(),WebsocketTransport=function(_BaseTransport){function WebsocketTransport(endpoint,stream_type){var options=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{socket:location.protocol.replace("http","ws")+"//"+location.host+"/ws/",workers:1};classCallCheck(this,WebsocketTransport);var _this2=possibleConstructorReturn(this,(WebsocketTransport.__proto__||Object.getPrototypeOf(WebsocketTransport)).call(this,endpoint,stream_type));return _this2.proxies=[],_this2.currentProxy=0,_this2.workers=1,_this2.socket_url=options.socket,_this2.reconnectHandler=options.reconnectHandler||_this2.defaultReconnectHandler,_this2.disconnectHandler=options.disconnectHandler||_this2.defaultDisconnectHandler,_this2._ready=_this2.connect(),_this2}return inherits(WebsocketTransport,BaseTransport),createClass(WebsocketTransport,[{key:"destroy",value:function(){var _this3=this;this.disconnect().then(function(){get(WebsocketTransport.prototype.__proto__||Object.getPrototypeOf(WebsocketTransport.prototype),"destroy",_this3).call(_this3),Log$10.debug("WebsocketTransport destroy")})}},{key:"ready",value:function(){return this._ready}},{key:"defaultReconnectHandler",value:function(e){return new Promise(function(resolve,reject){confirm(e.code+": "+e.msg+"\nDo You Want To Reconnect ?")?resolve():reject()})}},{key:"defaultDisconnectHandler",value:function(e){Log$10.error("[disconnect] "+e.type+". code: "+e.code+", reason: "+e)}},{key:"connect",value:function(){var _this4=this;return this.disconnect().then(function(){for(var promises=[],i=0;i<_this4.workers;++i){var proxy=new WebSocketProxy(_this4.socket_url,_this4.endpoint,_this4.stream_type);proxy.set_reconnect_handler(function(e){return _this4.reconnectHandler(e)}),proxy.set_disconnect_handler(function(e){_this4.eventSource.dispatchEvent("disconnected",{code:e.code,reason:e.reason}),[0,1e3,1006,1013,1011].includes(e.code)&&setTimeout(function(){_this4._ready&&_this4._ready.reject&&_this4._ready.reject(),_this4._ready=_this4.connect(),_this4._ready.then(function(){_this4.eventSource.dispatchEvent("reconnected")})},3e3),_this4.disconnectHandler(e)}),proxy.set_data_handler(function(data){_this4.dataQueue.push(new Uint8Array(data)),_this4.eventSource.dispatchEvent("data")}),promises.push(proxy.connect().then(function(){_this4.eventSource.dispatchEvent("connected")}).catch(function(e){throw _this4.eventSource.dispatchEvent("error"),new Error(e)})),_this4.proxies.push(proxy)}return Promise.all(promises)})}},{key:"disconnect",value:function(){for(var promises=[],i=0;i<this.proxies.length;++i)promises.push(this.proxies[i].close());return this.proxies=[],this.proxies.length?Promise.all(promises):Promise.resolve()}},{key:"socket",value:function(){return this.proxies[this.currentProxy++%this.proxies.length]}},{key:"send",value:function(_data,fn){var res=this.socket().send(_data);return fn&&fn(res.seq),res.promise}}],[{key:"canTransfer",value:function(stream_type){return WebsocketTransport.streamTypes().includes(stream_type)}},{key:"streamTypes",value:function(){return["hls","rtsp"]}}]),WebsocketTransport}(),WSPProtocol=function(){function WSPProtocol(ver){classCallCheck(this,WSPProtocol),this.ver=ver}return createClass(WSPProtocol,null,[{key:"PROTO",get:function(){return"WSP"}},{key:"V1_1",get:function(){return"1.1"}},{key:"CMD_INIT",get:function(){return"INIT"}},{key:"CMD_JOIN",get:function(){return"JOIN"}},{key:"CMD_WRAP",get:function(){return"WRAP"}}]),createClass(WSPProtocol,[{key:"build",value:function(cmd,data){var payload=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",data_str="";data.seq||(data.seq=++WSPProtocol.seq);for(var k in data)data_str+=k+": "+data[k]+"\r\n";return WSPProtocol.PROTO+"/"+this.ver+" "+cmd+"\r\n"+data_str+"\r\n"+payload}}],[{key:"parse",value:function(data){var payIdx=data.indexOf("\r\n\r\n"),lines=data.substr(0,payIdx).split("\r\n"),hdr=lines.shift().match(new RegExp(WSPProtocol.PROTO+"/"+WSPProtocol.V1_1+"\\s+(\\d+)\\s+(.+)"));if(hdr){for(var res={code:Number(hdr[1]),msg:hdr[2],data:{},payload:""};lines.length;){var line=lines.shift();if(!line)break;var _line$split=line.split(":"),_line$split2=slicedToArray(_line$split,2),k=_line$split2[0],v=_line$split2[1];res.data[k.trim()]=v.trim()}return res.payload=data.substr(payIdx+4),res}return null}}]),WSPProtocol}();WSPProtocol.seq=0;var WebSocketProxy=function(){function WebSocketProxy(wsurl,endpoint,stream_type){classCallCheck(this,WebSocketProxy),this.url=wsurl,this.stream_type=stream_type,this.endpoint=endpoint,this.data_handler=function(){},this.disconnect_handler=function(){},this.reconnect_handler=function(){},this.builder=new WSPProtocol(WSPProtocol.V1_1),this.awaitingPromises={},this.seq=0,this.encryptor=new JSEncrypt}return createClass(WebSocketProxy,null,[{key:"CHN_CONTROL",get:function(){return"control"}},{key:"CHN_DATA",get:function(){return"data"}}]),createClass(WebSocketProxy,[{key:"set_data_handler",value:function(handler){this.data_handler=handler}},{key:"set_disconnect_handler",value:function(handler){this.disconnect_handler=handler}},{key:"set_reconnect_handler",value:function(handler){this.reconnect_handler=handler}},{key:"close",value:function(){var _this5=this;return Log$10.log("closing connection"),new Promise(function(resolve){_this5.ctrlChannel.onclose=function(){_this5.dataChannel?(_this5.dataChannel.onclose=function(){Log$10.log("closed"),resolve()},_this5.dataChannel.close()):(Log$10.log("closed"),resolve())},_this5.ctrlChannel.close()})}},{key:"onDisconnect",value:function(e){this.ctrlChannel.onclose=null,this.ctrlChannel.close(),this.dataChannel&&(this.dataChannel.onclose=null,this.dataChannel.close()),this.disconnect_handler(e)}},{key:"initDataChannel",value:function(channel_id){var _this6=this;return new Promise(function(resolve,reject){_this6.dataChannel=new WebSocket(_this6.url,WebSocketProxy.CHN_DATA),_this6.dataChannel.binaryType="arraybuffer",_this6.dataChannel.onopen=function(){var msg=_this6.builder.build(WSPProtocol.CMD_JOIN,{channel:channel_id});Log$10.debug(msg),_this6.dataChannel.send(msg)},_this6.dataChannel.onmessage=function(ev){if(Log$10.debug("[data]\r\n"+ev.data),!WSPProtocol.parse(ev.data))return reject(new ProtocolError("data"));_this6.dataChannel.onmessage=function(e){_this6.data_handler&&_this6.data_handler(e.data)},resolve()},_this6.dataChannel.onerror=function(e){Log$10.error("[data] "+e.type+". code: "+e.code+", reason: "+e),_this6.dataChannel.close()},_this6.dataChannel.onclose=function(e){_this6.onDisconnect(e)}})}},{key:"connect",value:function(){var _this7=this;return this.encryptionKey=null,new Promise(function(resolve,reject){_this7.ctrlChannel=new WebSocket(_this7.url,WebSocketProxy.CHN_CONTROL),_this7.connected=!1,_this7.ctrlChannel.onopen=function(){var headers={proto:_this7.stream_type};_this7.endpoint.socket?headers.socket=_this7.endpoint.socket:Object.assign(headers,{host:_this7.endpoint.host,port:_this7.endpoint.port});var msg=_this7.builder.build(WSPProtocol.CMD_INIT,headers);Log$10.debug(msg),_this7.ctrlChannel.send(msg)},_this7.ctrlChannel.onmessage=function(ev){Log$10.debug("[ctrl] onmessage\r\n"+ev.data);var res=WSPProtocol.parse(ev.data);return res?res.code>=300?(Log$10.error("[ctrl]\r\n"+res.code+": "+res.msg),_this7.reconnect_handler(res).then(function(){_this7.disconnect_handler({code:0,reason:"reconnect"})}),reject(new Error(res.msg))):(_this7.ctrlChannel.onmessage=function(e){var res=WSPProtocol.parse(e.data);Log$10.debug("[ctrl] onmessage1\r\n"+e.data),res.data.seq in _this7.awaitingPromises&&(res||_this7.awaitingPromises[res.data.seq].reject(new ProtocolError("ctrl")),res.code<300?_this7.awaitingPromises[res.data.seq].resolve(res):_this7.awaitingPromises[res.data.seq].reject(new Error(res.msg)),delete _this7.awaitingPromises[res.data.seq])},_this7.encryptionKey=res.data.pubkey||null,_this7.encryptionKey&&_this7.encryptor.setPublicKey(_this7.encryptionKey),void _this7.initDataChannel(res.data.channel).then(resolve).catch(reject)):reject(new ProtocolError("ctrl"))},_this7.ctrlChannel.onerror=function(e){Log$10.error("[ctrl] "+e.type+". code: "+e.code,e),_this7.ctrlChannel.close(1011,"onerror")},_this7.ctrlChannel.onclose=function(e){_this7.onDisconnect(e)}})}},{key:"encrypt",value:function(msg){if(this.encryptionKey){var crypted=this.encryptor.encrypt(msg);if(!1===crypted)throw new Error("Encryption failed. Stopping");return crypted}return msg}},{key:"send",value:function(payload){var _this8=this;if(this.ctrlChannel.readyState!=WebSocket.OPEN)throw this.close(),new Error("disconnected");var data={contentLength:payload.length,seq:++WSPProtocol.seq};return{seq:data.seq,promise:new Promise(function(resolve,reject){_this8.awaitingPromises[data.seq]={resolve:resolve,reject:reject};var msg=_this8.builder.build(WSPProtocol.CMD_WRAP,data,payload);Log$10.debug(msg),_this8.ctrlChannel.send(_this8.encrypt(msg))})}}}]),WebSocketProxy}(),Log$1=getTagged("wsp"),StreamType=function(){function StreamType(){classCallCheck(this,StreamType)}return createClass(StreamType,null,[{key:"isSupported",value:function(type){return[StreamType.HLS,StreamType.RTSP].includes(type)}},{key:"fromUrl",value:function(url){var parsed=void 0;try{parsed=Url.parse(url)}catch(e){return null}switch(parsed.protocol){case"rtsp":return StreamType.RTSP;case"http":case"https":return url.indexOf(".m3u8")>=0?StreamType.HLS:null;default:return null}}},{key:"fromMime",value:function(mime){switch(mime){case"application/x-rtsp":return StreamType.RTSP;case"application/vnd.apple.mpegurl":case"application/x-mpegurl":return StreamType.HLS;default:return null}}},{key:"HLS",get:function(){return"hls"}},{key:"RTSP",get:function(){return"rtsp"}}]),StreamType}(),WSPlayer=function(){function WSPlayer(node,opts){var _this=this;classCallCheck(this,WSPlayer),(void 0===node?"undefined":_typeof(node))==_typeof("")?this.player=document.getElementById(node):this.player=node;var modules=opts.modules||{client:RTSPClient,transport:{constructor:WebsocketTransport}};this.errorHandler=opts.errorHandler||null,this.queryCredentials=opts.queryCredentials.bind(this)||null,this.redirectHandler=opts.redirectHandler||this.defaultTransportRedirectHandler,this.modules={};var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=modules[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var module=_step.value,transport=module.transport||WebsocketTransport,client=module.client||RTSPClient;transport.constructor.canTransfer(client.streamType())?this.modules[client.streamType()]={client:client,transport:transport}:Log$1.warn("Client stream type "+client.streamType()+" is incompatible with transport types ["+transport.streamTypes().join(", ")+"]. Skip")}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}if(this.type=StreamType.RTSP,this.url=null,opts.url&&opts.type)this.url=opts.url,this.type=opts.type;else if(!this._checkSource(this.player))for(var i=0;i<this.player.children.length&&!this._checkSource(this.player.children[i]);++i);this.url&&this.setSource(this.url,this.type),this.player.addEventListener("play",function(){_this.client&&(_this.isPlaying()||_this.client.start())},!1),this.player.addEventListener("pause",function(){_this.client&&_this.client.stop()},!1)}return createClass(WSPlayer,[{key:"isPlaying",value:function(){return!(this.player.paused||this.client.paused)}},{key:"canPlayUrl",value:function(src){return StreamType.fromUrl(src)in this.modules}},{key:"_checkSource",value:function(src){return!(src.dataset.ignore||!src.src||this.player.canPlayType(src.type)||!StreamType.fromMime(src.type)&&!StreamType.fromUrl(src.src))&&(this.url=src.src,this.type=src.type?StreamType.fromMime(src.type):StreamType.fromUrl(src.src),!0)}},{key:"defaultTransportRedirectHandler",value:function(url){this.endpoint=Url.parse(url),this.setSource(url||this.url,this.type)}},{key:"setSource",value:function(url,type){return __async(regeneratorRuntime.mark(function _callee(){var transport,lastType,client;return regeneratorRuntime.wrap(function(_context){for(;;)switch(_context.prev=_context.next){case 0:this.transport&&(this.client&&this.client.detachTransport(),this.transport.destroy()),_context.prev=1,this.endpoint=Url.parse(url),_context.next=9;break;case 5:return _context.prev=5,_context.t0=_context.catch(1),console.error("bad endpoint: ",_context.t0),_context.abrupt("return");case 9:if(this.url=url,transport=this.modules[type].transport,this.transport=new transport.constructor(this.endpoint,this.type,transport.options),lastType=this.type,this.type=!!StreamType.isSupported(type)&&type||StreamType.fromMime(type),this.type){_context.next=16;break}throw new Error("Bad stream type");case 16:if(lastType==this.type&&this.client){_context.next=22;break}this.client&&this.client.destroy(),client=this.modules[type].client,this.client=new client({flush:200,onError:this.errorHandler}),_context.next=24;break;case 22:return _context.next=24,this.client.reset();case 24:this.queryCredentials&&(this.client.queryCredentials=this.queryCredentials.bind(this)),this.redirectHandler&&(this.client.redirectHandler=this.redirectHandler),this.remuxer&&(this.remuxer.destroy(),this.remuxer=null),this.remuxer=new Remuxer(this.player),this.remuxer.attachClient(this.client),this.client.attachTransport(this.transport),this.client.setSource(this.endpoint),this.player.autoplay&&this.start();case 32:case"end":return _context.stop()}},_callee,this,[[1,5]])}).call(this))}},{key:"start",value:function(){this.transport&&this.client&&this.client.start()}},{key:"stop",value:function(){this.client&&this.client.stop()}},{key:"destroy",value:function(){this.transport&&(this.client&&this.client.detachTransport(),this.transport.destroy()),this.client&&this.client.destroy(),this.remuxer&&(this.remuxer.destroy(),this.remuxer=null)}},{key:"pullOOBData",value:function(pts){if(this.remuxer)return this.remuxer.pullOOBData(pts)}}],[{key:"canPlayWithModules",value:function(mimeType,modules){var filteredModules={},_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=modules[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var module=_step2.value,transport=module.transport||WebsocketTransport,client=module.client||RTSPClient;transport.canTransfer(client.streamType())&&(filteredModules[client.streamType()]=!0)}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}for(var type in filteredModules)if(type==StreamType.fromMime(mimeType))return!0;return!1}},{key:"canPlay",value:function(resource){return StreamType.fromMime(resource.type)||StreamType.fromUrl(resource.src)}}]),WSPlayer}();function renderPolygon(vertices,color,lineWidth,animation,fillOpacity,offlineCtx){offlineCtx.beginPath(),0!=animation.status&&(offlineCtx.globalAlpha=animation.opacity,1==animation.status?(animation.opacity-=EventStyle.opacitySpeed,animation.opacity<=.5&&(animation.opacity=.5,animation.status=2)):(animation.opacity+=EventStyle.opacitySpeed,animation.opacity>=1&&(animation.opacity=1,animation.status=1))),offlineCtx.lineWidth=lineWidth,offlineCtx.strokeStyle=color,offlineCtx.beginPath(),offlineCtx.moveTo(vertices[0].x,vertices[0].y);for(var i=1;i<vertices.length;i++)offlineCtx.lineTo(vertices[i].x,vertices[i].y);offlineCtx.closePath(),offlineCtx.stroke(),fillOpacity&&fillOpacity>0?(offlineCtx.globalAlpha=fillOpacity*animation.opacity,offlineCtx.fillStyle=color,offlineCtx.fill()):0!=animation.status&&(offlineCtx.globalAlpha=.3*animation.opacity,offlineCtx.fillStyle=color,offlineCtx.fill()),offlineCtx.globalAlpha=1}function rectangleToPolygon(x,y,w,h){var vertices=[],vertice1={x:x,y:y};vertices.push(vertice1);var vertice2={x:x+w,y:y};vertices.push(vertice2);var vertice3={x:x+w,y:y+h};vertices.push(vertice3);var vertice4={x:x,y:y+h};return vertices.push(vertice4),vertices}var _defaultColormapConfi,defaultStyle={color:"white",lineWidth:1},ObjectRenderer=function(){function ObjectRenderer(offlineCtx,canvasWidth,canvasHeight){classCallCheck(this,ObjectRenderer),this.tracklets={},this.offlineCtx=offlineCtx,this.canvasWidth=canvasWidth,this.canvasHeight=canvasHeight}return createClass(ObjectRenderer,[{key:"setCanvas",value:function(width,height){this.canvasWidth=width,this.canvasHeight=height}},{key:"style",value:function(target){if(target.algo&&AlgoObjectInfoMap[target.algo.appName]){switch(target.algo.objectType){case"OBJECT_FACE":return PreviewInfoObjectMap[1];case"OBJECT_PEDESTRIAN":return PreviewInfoObjectMap[2];case"OBJECT_AUTOMOBILE":return PreviewInfoObjectMap[3];case"OBJECT_CYCLIST":return PreviewInfoObjectMap[4];case"OBJECT_HUMAN_POWERED_VEHICLE":return PreviewInfoObjectMap[5]}var algoStyleConfig=AlgoObjectInfoMap[target.algo.appName][target.algo.objectType];if(algoStyleConfig)return algoStyleConfig}return PreviewInfoObjectMap[target.objectType]}},{key:"enqueue",value:function(currentTime,videoWidth,videoHeight,target,status){if(target&&target.bounding){var wordWidth=0;this.offlineCtx.font=TextStyle.textFont;var items=[];Console.isConsole&&Console.consoleObject&&console.log(target);var style=this.style(target);if(style){var scale=1;if(scale=videoWidth/videoHeight>this.canvasWidth/this.canvasHeight?this.canvasWidth/videoWidth:this.canvasHeight/videoHeight,items.push(style.title),target.attributes)for(var i in style.attrs){var title=style.attrs[i],value=AttributeEnglishToChinese[target.attributes[i]]||target.attributes[i];if(value){var content=title+": "+value;items.push(content);var itemWidth=this.offlineCtx.measureText(content).width;itemWidth>wordWidth&&(wordWidth=itemWidth)}}var w=target.bounding.vertices[1].x-target.bounding.vertices[0].x,h=target.bounding.vertices[1].y-target.bounding.vertices[0].y,x=target.bounding.vertices[0].x,y=target.bounding.vertices[0].y;w*=scale,h*=scale,x*=scale,y*=scale,this.tracklets[target.trackId]={roi:rectangleToPolygon(x,y,w,h),object:target.objectId||"",style:{color:style.color||defaultStyle.color,lineWidth:style.lineWidth||defaultStyle.lineWidth,opacity:style.opacity||0,frameWidth:wordWidth+8},attr:{items:items},animation:{duration:style.duration||200,status:status,opacity:1},ts:currentTime}}}}},{key:"_rendererTracklet",value:function(tracklet,offlineCtx){renderPolygon(tracklet.roi,tracklet.style.color,tracklet.style.lineWidth,tracklet.animation,tracklet.style.opacity,offlineCtx);var items=tracklet.attr.items;if(items.length>0){var x=0,y=0;x=tracklet.roi[0].x,y=tracklet.roi[0].y;for(var i=1;i<tracklet.roi.length;i++)x<tracklet.roi[i].x&&(x=tracklet.roi[i].x),y>tracklet.roi[i].y&&(y=tracklet.roi[i].y);offlineCtx.font=TextStyle.textFont,offlineCtx.textAlign="start",items.forEach(function(item,index){offlineCtx.fillStyle=TextStyle.textBackgroundColor,offlineCtx.fillRect(x,y+TextStyle.lineSpace*index+TextStyle.textFrameInterval*index,tracklet.style.frameWidth,TextStyle.textFrameInterval),offlineCtx.fillStyle=TextStyle.textColor,offlineCtx.fillText(item,x+4,y+TextStyle.lineSpace*index+TextStyle.textFrameInterval*(index+1))})}}},{key:"render",value:function(currentTime){var _this=this;Object.keys(this.tracklets).forEach(function(k){_this._rendererTracklet(_this.tracklets[k],_this.offlineCtx);var lastTime=_this.tracklets[k].ts;currentTime-lastTime>_this.tracklets[k].animation.duration&&delete _this.tracklets[k]})}},{key:"clear",value:function(){var _this2=this;Object.keys(this.tracklets).forEach(function(k){delete _this2.tracklets[k]})}}]),ObjectRenderer}(),Log$12=getTagged("heatmap"),defaultColormapConfigs=(defineProperty(_defaultColormapConfi={jet:[{index:0,rgb:[0,0,131]},{index:.125,rgb:[0,60,170]},{index:.375,rgb:[5,255,255]},{index:.625,rgb:[255,255,0]},{index:.875,rgb:[250,0,0]},{index:1,rgb:[128,0,0]}],hsv:[{index:0,rgb:[255,0,0]},{index:.169,rgb:[253,255,2]},{index:.173,rgb:[247,255,2]},{index:.337,rgb:[0,252,4]},{index:.341,rgb:[0,252,10]},{index:.506,rgb:[1,249,255]},{index:.671,rgb:[2,0,253]},{index:.675,rgb:[8,0,253]},{index:.839,rgb:[255,0,251]},{index:.843,rgb:[255,0,245]},{index:1,rgb:[255,0,6]}],hot:[{index:0,rgb:[0,0,0]},{index:.3,rgb:[230,0,0]},{index:.6,rgb:[255,210,0]},{index:1,rgb:[255,255,255]}],cool:[{index:0,rgb:[0,255,255]},{index:1,rgb:[255,0,255]}],spring:[{index:0,rgb:[255,0,255]},{index:1,rgb:[255,255,0]}],summer:[{index:0,rgb:[0,128,102]},{index:1,rgb:[255,255,102]}],autumn:[{index:0,rgb:[255,0,0]},{index:1,rgb:[255,255,0]}],winter:[{index:0,rgb:[0,0,255]},{index:1,rgb:[0,255,128]}],bone:[{index:0,rgb:[0,0,0]},{index:.376,rgb:[84,84,116]},{index:.753,rgb:[169,200,200]},{index:1,rgb:[255,255,255]}],copper:[{index:0,rgb:[0,0,0]},{index:.804,rgb:[255,160,102]},{index:1,rgb:[255,199,127]}],greys:[{index:0,rgb:[0,0,0]},{index:1,rgb:[255,255,255]}],yignbu:[{index:0,rgb:[8,29,88]},{index:.125,rgb:[37,52,148]},{index:.25,rgb:[34,94,168]},{index:.375,rgb:[29,145,192]},{index:.5,rgb:[65,182,196]},{index:.625,rgb:[127,205,187]},{index:.75,rgb:[199,233,180]},{index:.875,rgb:[237,248,217]},{index:1,rgb:[255,255,217]}],greens:[{index:0,rgb:[0,68,27]},{index:.125,rgb:[0,109,44]},{index:.25,rgb:[35,139,69]},{index:.375,rgb:[65,171,93]},{index:.5,rgb:[116,196,118]},{index:.625,rgb:[161,217,155]},{index:.75,rgb:[199,233,192]},{index:.875,rgb:[229,245,224]},{index:1,rgb:[247,252,245]}],yiorrd:[{index:0,rgb:[128,0,38]},{index:.125,rgb:[189,0,38]},{index:.25,rgb:[227,26,28]},{index:.375,rgb:[252,78,42]},{index:.5,rgb:[253,141,60]},{index:.625,rgb:[254,178,76]},{index:.75,rgb:[254,217,118]},{index:.875,rgb:[255,237,160]},{index:1,rgb:[255,255,204]}],bluered:[{index:0,rgb:[0,0,255]},{index:1,rgb:[255,0,0]}],rdbu:[{index:0,rgb:[5,10,172]},{index:.35,rgb:[106,137,247]},{index:.5,rgb:[190,190,190]},{index:.6,rgb:[220,170,132]},{index:.7,rgb:[230,145,90]},{index:1,rgb:[178,10,28]}],picnic:[{index:0,rgb:[0,0,255]},{index:.1,rgb:[51,153,255]},{index:.2,rgb:[102,204,255]},{index:.3,rgb:[153,204,255]},{index:.4,rgb:[204,204,255]},{index:.5,rgb:[255,255,255]},{index:.6,rgb:[255,204,255]},{index:.7,rgb:[255,153,255]},{index:.8,rgb:[255,102,204]},{index:.9,rgb:[255,102,102]},{index:1,rgb:[255,0,0]}],rainbow:[{index:0,rgb:[150,0,90]},{index:.125,rgb:[0,0,200]},{index:.25,rgb:[0,25,255]},{index:.375,rgb:[0,152,255]},{index:.5,rgb:[44,255,150]},{index:.625,rgb:[151,255,0]},{index:.75,rgb:[255,234,0]},{index:.875,rgb:[255,111,0]},{index:1,rgb:[255,0,0]}],portland:[{index:0,rgb:[12,51,131]},{index:.25,rgb:[10,136,186]},{index:.5,rgb:[242,211,56]},{index:.75,rgb:[242,143,56]},{index:1,rgb:[217,30,30]}],blackbody:[{index:0,rgb:[0,0,0]},{index:.2,rgb:[230,0,0]},{index:.4,rgb:[230,210,0]},{index:.7,rgb:[255,255,255]},{index:1,rgb:[160,200,255]}],earth:[{index:0,rgb:[0,0,130]},{index:.1,rgb:[0,180,180]},{index:.2,rgb:[40,210,40]},{index:.4,rgb:[230,230,50]},{index:.6,rgb:[120,70,20]},{index:1,rgb:[255,255,255]}],electric:[{index:0,rgb:[0,0,0]},{index:.15,rgb:[30,0,100]},{index:.4,rgb:[120,0,100]},{index:.6,rgb:[160,90,0]},{index:.8,rgb:[230,200,0]},{index:1,rgb:[255,250,220]}],alpha:[{index:0,rgb:[255,255,255,0]},{index:1,rgb:[255,255,255,1]}],viridis:[{index:0,rgb:[68,1,84]},{index:.13,rgb:[71,44,122]},{index:.25,rgb:[59,81,139]},{index:.38,rgb:[44,113,142]},{index:.5,rgb:[33,144,141]},{index:.63,rgb:[39,173,129]},{index:.75,rgb:[92,200,99]},{index:.88,rgb:[170,220,50]},{index:1,rgb:[253,231,37]}],inferno:[{index:0,rgb:[0,0,4]},{index:.13,rgb:[31,12,72]},{index:.25,rgb:[85,15,109]},{index:.38,rgb:[136,34,106]},{index:.5,rgb:[186,54,85]},{index:.63,rgb:[227,89,51]},{index:.75,rgb:[249,140,10]},{index:.88,rgb:[249,201,50]},{index:1,rgb:[252,255,164]}],magma:[{index:0,rgb:[0,0,4]},{index:.13,rgb:[28,16,68]},{index:.25,rgb:[79,18,123]},{index:.38,rgb:[129,37,129]},{index:.5,rgb:[181,54,122]},{index:.63,rgb:[229,80,100]},{index:.75,rgb:[251,135,97]},{index:.88,rgb:[254,194,135]},{index:1,rgb:[252,253,191]}],plasma:[{index:0,rgb:[13,8,135]},{index:.13,rgb:[75,3,161]},{index:.25,rgb:[125,3,168]},{index:.38,rgb:[168,34,150]},{index:.5,rgb:[203,70,121]},{index:.63,rgb:[229,107,93]},{index:.75,rgb:[248,148,65]},{index:.88,rgb:[253,195,40]},{index:1,rgb:[240,249,33]}],warm:[{index:0,rgb:[125,0,179]},{index:.13,rgb:[172,0,187]},{index:.25,rgb:[219,0,170]},{index:.38,rgb:[255,0,130]},{index:.5,rgb:[255,63,74]},{index:.63,rgb:[255,123,0]},{index:.75,rgb:[234,176,0]},{index:.88,rgb:[190,228,0]},{index:1,rgb:[147,255,0]}]},"cool",[{index:0,rgb:[125,0,179]},{index:.13,rgb:[116,0,218]},{index:.25,rgb:[98,74,237]},{index:.38,rgb:[68,146,231]},{index:.5,rgb:[0,204,197]},{index:.63,rgb:[0,247,146]},{index:.75,rgb:[0,255,88]},{index:.88,rgb:[40,255,8]},{index:1,rgb:[147,255,0]}]),defineProperty(_defaultColormapConfi,"rainbow-soft",[{index:0,rgb:[125,0,179]},{index:.1,rgb:[199,0,180]},{index:.2,rgb:[255,0,121]},{index:.3,rgb:[255,108,0]},{index:.4,rgb:[222,194,0]},{index:.5,rgb:[150,255,0]},{index:.6,rgb:[0,255,55]},{index:.7,rgb:[0,246,150]},{index:.8,rgb:[50,167,222]},{index:.9,rgb:[103,51,235]},{index:1,rgb:[124,0,186]}]),defineProperty(_defaultColormapConfi,"bathymetry",[{index:0,rgb:[40,26,44]},{index:.13,rgb:[59,49,90]},{index:.25,rgb:[64,76,139]},{index:.38,rgb:[63,110,151]},{index:.5,rgb:[72,142,158]},{index:.63,rgb:[85,174,163]},{index:.75,rgb:[120,206,163]},{index:.88,rgb:[187,230,172]},{index:1,rgb:[253,254,204]}]),defineProperty(_defaultColormapConfi,"cdom",[{index:0,rgb:[47,15,62]},{index:.13,rgb:[87,23,86]},{index:.25,rgb:[130,28,99]},{index:.38,rgb:[171,41,96]},{index:.5,rgb:[206,67,86]},{index:.63,rgb:[230,106,84]},{index:.75,rgb:[242,149,103]},{index:.88,rgb:[249,193,135]},{index:1,rgb:[254,237,176]}]),defineProperty(_defaultColormapConfi,"chlorophyll",[{index:0,rgb:[18,36,20]},{index:.13,rgb:[25,63,41]},{index:.25,rgb:[24,91,59]},{index:.38,rgb:[13,119,72]},{index:.5,rgb:[18,148,80]},{index:.63,rgb:[80,173,89]},{index:.75,rgb:[132,196,122]},{index:.88,rgb:[175,221,162]},{index:1,rgb:[215,249,208]}]),defineProperty(_defaultColormapConfi,"density",[{index:0,rgb:[54,14,36]},{index:.13,rgb:[89,23,80]},{index:.25,rgb:[110,45,132]},{index:.38,rgb:[120,77,178]},{index:.5,rgb:[120,113,213]},{index:.63,rgb:[115,151,228]},{index:.75,rgb:[134,185,227]},{index:.88,rgb:[177,214,227]},{index:1,rgb:[230,241,241]}]),defineProperty(_defaultColormapConfi,"freesurface-blue",[{index:0,rgb:[30,4,110]},{index:.13,rgb:[47,14,176]},{index:.25,rgb:[41,45,236]},{index:.38,rgb:[25,99,212]},{index:.5,rgb:[68,131,200]},{index:.63,rgb:[114,156,197]},{index:.75,rgb:[157,181,203]},{index:.88,rgb:[200,208,216]},{index:1,rgb:[241,237,236]}]),defineProperty(_defaultColormapConfi,"freesurface-red",[{index:0,rgb:[60,9,18]},{index:.13,rgb:[100,17,27]},{index:.25,rgb:[142,20,29]},{index:.38,rgb:[177,43,27]},{index:.5,rgb:[192,87,63]},{index:.63,rgb:[205,125,105]},{index:.75,rgb:[216,162,148]},{index:.88,rgb:[227,199,193]},{index:1,rgb:[241,237,236]}]),defineProperty(_defaultColormapConfi,"oxygen",[{index:0,rgb:[64,5,5]},{index:.13,rgb:[106,6,15]},{index:.25,rgb:[144,26,7]},{index:.38,rgb:[168,64,3]},{index:.5,rgb:[188,100,4]},{index:.63,rgb:[206,136,11]},{index:.75,rgb:[220,174,25]},{index:.88,rgb:[231,215,44]},{index:1,rgb:[248,254,105]}]),defineProperty(_defaultColormapConfi,"par",[{index:0,rgb:[51,20,24]},{index:.13,rgb:[90,32,35]},{index:.25,rgb:[129,44,34]},{index:.38,rgb:[159,68,25]},{index:.5,rgb:[182,99,19]},{index:.63,rgb:[199,134,22]},{index:.75,rgb:[212,171,35]},{index:.88,rgb:[221,210,54]},{index:1,rgb:[225,253,75]}]),defineProperty(_defaultColormapConfi,"phase",[{index:0,rgb:[145,105,18]},{index:.13,rgb:[184,71,38]},{index:.25,rgb:[186,58,115]},{index:.38,rgb:[160,71,185]},{index:.5,rgb:[110,97,218]},{index:.63,rgb:[50,123,164]},{index:.75,rgb:[31,131,110]},{index:.88,rgb:[77,129,34]},{index:1,rgb:[145,105,18]}]),defineProperty(_defaultColormapConfi,"salinity",[{index:0,rgb:[42,24,108]},{index:.13,rgb:[33,50,162]},{index:.25,rgb:[15,90,145]},{index:.38,rgb:[40,118,137]},{index:.5,rgb:[59,146,135]},{index:.63,rgb:[79,175,126]},{index:.75,rgb:[120,203,104]},{index:.88,rgb:[193,221,100]},{index:1,rgb:[253,239,154]}]),defineProperty(_defaultColormapConfi,"temperature",[{index:0,rgb:[4,35,51]},{index:.13,rgb:[23,51,122]},{index:.25,rgb:[85,59,157]},{index:.38,rgb:[129,79,143]},{index:.5,rgb:[175,95,130]},{index:.63,rgb:[222,112,101]},{index:.75,rgb:[249,146,66]},{index:.88,rgb:[249,196,65]},{index:1,rgb:[232,250,91]}]),defineProperty(_defaultColormapConfi,"turbidity",[{index:0,rgb:[34,31,27]},{index:.13,rgb:[65,50,41]},{index:.25,rgb:[98,69,52]},{index:.38,rgb:[131,89,57]},{index:.5,rgb:[161,112,59]},{index:.63,rgb:[185,140,66]},{index:.75,rgb:[202,174,88]},{index:.88,rgb:[216,209,126]},{index:1,rgb:[233,246,171]}]),defineProperty(_defaultColormapConfi,"velocity-blue",[{index:0,rgb:[17,32,64]},{index:.13,rgb:[35,52,116]},{index:.25,rgb:[29,81,156]},{index:.38,rgb:[31,113,162]},{index:.5,rgb:[50,144,169]},{index:.63,rgb:[87,173,176]},{index:.75,rgb:[149,196,189]},{index:.88,rgb:[203,221,211]},{index:1,rgb:[254,251,230]}]),defineProperty(_defaultColormapConfi,"velocity-green",[{index:0,rgb:[23,35,19]},{index:.13,rgb:[24,64,38]},{index:.25,rgb:[11,95,45]},{index:.38,rgb:[39,123,35]},{index:.5,rgb:[95,146,12]},{index:.63,rgb:[152,165,18]},{index:.75,rgb:[201,186,69]},{index:.88,rgb:[233,216,137]},{index:1,rgb:[255,253,205]}]),defineProperty(_defaultColormapConfi,"cubehelix",[{index:0,rgb:[0,0,0]},{index:.07,rgb:[22,5,59]},{index:.13,rgb:[60,4,105]},{index:.2,rgb:[109,1,135]},{index:.27,rgb:[161,0,147]},{index:.33,rgb:[210,2,142]},{index:.4,rgb:[251,11,123]},{index:.47,rgb:[255,29,97]},{index:.53,rgb:[255,54,69]},{index:.6,rgb:[255,85,46]},{index:.67,rgb:[255,120,34]},{index:.73,rgb:[255,157,37]},{index:.8,rgb:[241,191,57]},{index:.87,rgb:[224,220,93]},{index:.93,rgb:[218,241,142]},{index:1,rgb:[227,253,198]}]),defineProperty(_defaultColormapConfi,"crowd",[{index:0,rgba:[0,0,131,0]},{index:.125,rgba:[0,60,170,.3]},{index:.3,rgba:[5,255,255,.3]},{index:.4,rgba:[255,255,0,.3]},{index:.5,rgba:[250,0,0,.3]},{index:1,rgba:[128,0,0,.3]}]),_defaultColormapConfi),defaultColormapConfig=defaultColormapConfigs.crowd,Colormap=function(){function Colormap(config){classCallCheck(this,Colormap),this.updateConfig(config)}return createClass(Colormap,[{key:"_configFromList",value:function(l){for(var e,config={},i=0;i<l.length;i++)(e=l[i]).rgba?config[e.index]="rgba("+e.rgba[0]+","+e.rgba[1]+","+e.rgba[2]+","+e.rgba[3]+")":config[e.index]="rgb("+e.rgb[0]+","+e.rgb[1]+","+e.rgb[2]+")";return config}},{key:"updateConfig",value:function(config){config&&(void 0===config?"undefined":_typeof(config))==_typeof("")&&(config=defaultColormapConfigs[config]),config&&(void 0===config?"undefined":_typeof(config))==_typeof([])&&(config=this._configFromList(config)),config||(Log$12.log("colormap config not set, use default"),config=this._configFromList(defaultColormapConfig));var canvas=document.createElement("canvas"),ctx=canvas.getContext("2d");canvas.width=256,canvas.height=1;var colors=ctx.createLinearGradient(0,0,256,1);for(var key in config)colors.addColorStop(key,config[key]);ctx.fillStyle=colors,ctx.fillRect(0,0,256,1),this.data=ctx.getImageData(0,0,256,1).data}},{key:"getColor",value:function(gray){gray<0?gray=0:gray>255&&(gray=255);var idx=4*gray;return[this.data[idx],this.data[idx+1],this.data[idx+2],this.data[idx+3]]}}]),Colormap}(),HeatmapRenderer=function(){function HeatmapRenderer(offlineCtx,canvasWidth,canvasHeight,colormapConfig){classCallCheck(this,HeatmapRenderer),this.offlineCtx=offlineCtx,this.canvasWidth=canvasWidth,this.canvasHeight=canvasHeight,this.colormap=new Colormap(colormapConfig),this.offlineHeatmapCanvas=document.createElement("canvas"),this.offlineHeatmapCtx=this.offlineHeatmapCanvas.getContext("2d"),this.offlineHeatmapCtx.show=!1,this.offlineHeatmapCtx.duration=HeatmapStyle.duration||200,this.offlineHeatmapCtx.ts=0}return createClass(HeatmapRenderer,[{key:"setCanvas",value:function(width,height){this.canvasWidth=width,this.canvasHeight=height}},{key:"style",value:function(target){}},{key:"enqueue",value:function(currentTime,videoWidth,videoHeight,target){if(target&&HeatmapStyle&&HeatmapStyle.enable){if(8==target.objectType&&target.algo&&target.algo.data){var data=JSON.parse(target.algo.data);if(!data||!data.density_map)return;var density_map=data.density_map,buf=base64ToArrayBuffer(density_map.buffer),length=(density_map.width*density_map.height*density_map.bits+7)/8;length=Math.floor(length),density_map.buffer=new BitArray(new Uint8Array(buf,0,length)),Console.isConsole&&Console.consoleAlgo&&(console.log(target),console.log(density_map)),this.offlineHeatmapCanvas.width=density_map.width,this.offlineHeatmapCanvas.height=density_map.height;for(var offlineHeatmapImg=this.offlineHeatmapCtx.getImageData(0,0,density_map.width,density_map.height),i=0;i<density_map.height;i++)for(var j=0;j<density_map.width;j++)(idx=i*density_map.width+j)<8||(gray=density_map.buffer.readBits(density_map.bits),gray<<=8-density_map.bits,idx*=4,color=this.colormap.getColor(gray),offlineHeatmapImg.data[idx]=color[0],offlineHeatmapImg.data[idx+1]=color[1],offlineHeatmapImg.data[idx+2]=color[2],offlineHeatmapImg.data[idx+3]=color[3]);this.offlineHeatmapCtx.putImageData(offlineHeatmapImg,0,0),this.offlineHeatmapCtx.show=!0,this.offlineHeatmapCtx.content="",this.offlineHeatmapCtx.ts=currentTime}if(6==target.objectType&&target.crowd){Console.isConsole&&Console.consoleCrowd&&console.log(target),this.offlineHeatmapCanvas.width=target.crowd.densitySize.width,this.offlineHeatmapCanvas.height=target.crowd.densitySize.height;var gray,idx,color;for(offlineHeatmapImg=this.offlineHeatmapCtx.getImageData(0,0,target.crowd.densitySize.width,target.crowd.densitySize.height),i=0;i<target.crowd.densitySize.height;i++)for(j=0;j<target.crowd.densitySize.width;j++)idx=i*target.crowd.densitySize.width+j,gray=target.crowd.density[idx],idx*=4,color=this.colormap.getColor(gray),offlineHeatmapImg.data[idx]=color[0],offlineHeatmapImg.data[idx+1]=color[1],offlineHeatmapImg.data[idx+2]=color[2],offlineHeatmapImg.data[idx+3]=color[3];this.offlineHeatmapCtx.putImageData(offlineHeatmapImg,0,0),this.offlineHeatmapCtx.show=!0,this.offlineHeatmapCtx.content=HeatmapStyle.content+target.crowd.quantity,this.offlineHeatmapCtx.ts=currentTime}}}},{key:"render",value:function(currentTime){currentTime-this.offlineHeatmapCtx.ts>=this.offlineHeatmapCtx.duration&&(this.offlineHeatmapCtx.show=!1),this.offlineHeatmapCtx.show&&(this.offlineCtx.drawImage(this.offlineHeatmapCanvas,0,0,this.canvasWidth,this.canvasHeight),this.offlineCtx.textAlign="left",this.offlineCtx.font=HeatmapStyle.textFont,this.offlineCtx.fillStyle=HeatmapStyle.textColor,this.offlineCtx.fillText(this.offlineHeatmapCtx.content,HeatmapStyle.left,HeatmapStyle.top,HeatmapStyle.textWidth,HeatmapStyle.textHeight))}},{key:"clear",value:function(){this.offlineHeatmapCtx.show=!1}}]),HeatmapRenderer}(),defaultStyle$1={color:"black",lineWidth:1},EventRenderer=function(){function EventRenderer(offlineCtx,canvasWidth,canvasHeight){classCallCheck(this,EventRenderer),this.eventrules={},this.offlineCtx=offlineCtx,this.canvasWidth=canvasWidth,this.canvasHeight=canvasHeight}return createClass(EventRenderer,[{key:"setCanvas",value:function(width,height){this.canvasWidth=width,this.canvasHeight=height}},{key:"style",value:function(rule){return PreviewInfoEventMap[rule.type]}},{key:"_addEventRule",value:function(currentTime,rule){Console.isConsole&&Console.consoleEventRule&&console.log(rule);var style=this.style(rule);if(style){var data,i,is_uniformed=!0;for(i=0;i<rule.roi.vertices.length;i++)if((data=rule.roi.vertices[i]).x>1||data.y>1){is_uniformed=!1;break}var scaleWidth=this.scale,scaleHeight=this.scale;is_uniformed&&(scaleWidth=this.canvasWidth,scaleHeight=this.canvasHeight);var vertices=[];rule.roi.vertices.forEach(function(data){var vertice={x:data.x*scaleWidth,y:data.y*scaleHeight};vertices.push(vertice)}),this.eventrules[rule.ruleId]={type:rule.type,roi:vertices,ts:currentTime,style:{color:style.color||defaultStyle$1.color,lineWidth:style.lineWidth||defaultStyle$1.lineWidth,opacity:style.opacity||0},animation:{duration:style.duration||1e3,status:1,opacity:1}}}}},{key:"update",value:function(currentTime,videoWidth,videoHeight,rules){var _this=this,scale=1;scale=videoWidth/videoHeight>this.canvasWidth/this.canvasHeight?this.canvasWidth/videoWidth:this.canvasHeight/videoHeight,this.scale=scale,rules.forEach(function(rule){_this._addEventRule(currentTime,rule)})}},{key:"enqueue",value:function(currentTime,videoWidth,videoHeight,target){var _this2=this,scale=1;scale=videoWidth/videoHeight>this.canvasWidth/this.canvasHeight?this.canvasWidth/videoWidth:this.canvasHeight/videoHeight,this.scale=scale;var triggered=!1;if(target.events&&target.events.forEach(function(event){_this2.eventrules[event.ruleId]&&(triggered=!0,_this2.eventrules[event.ruleId].animation.status=1)}),target.algo&&target.algo.data){var data=JSON.parse(target.algo.data);data&&data.rule&&(this._addEventRule(currentTime,data.rule),this.eventrules[data.rule.ruleId]&&(this.eventrules[data.rule.ruleId].animation.status=1,triggered=!0))}return triggered}},{key:"_renderEventrule",value:function(eventrule,offlineCtx,blink){eventrule.type;if(blink||(eventrule.animation.opacity=1,eventrule.animation.status=0),eventrule.roi.length>0&&(renderPolygon(eventrule.roi,eventrule.style.color,eventrule.style.lineWidth,eventrule.animation,eventrule.style.opacity,offlineCtx),blink)){for(var x=0,y=0,i=0;i<eventrule.roi.length;i++)x+=eventrule.roi[i].x,y+=eventrule.roi[i].y;x/=eventrule.roi.length,y/=eventrule.roi.length,offlineCtx.textAlign="center",offlineCtx.font=EventStyle.textFont;var content=PreviewInfoEventMap[eventrule.type].title,width=offlineCtx.measureText(content).width+8;offlineCtx.fillStyle=EventStyle.textBackgroundColor,offlineCtx.fillRect(x-width/2,y-EventStyle.textFrameInterval/2,width,EventStyle.textFrameInterval),offlineCtx.fillStyle=EventStyle.textColor,offlineCtx.fillText(content,x,y-EventStyle.textFrameInterval/2+EventStyle.textFrameHeightPerLine,width,EventStyle.textFrameInterval)}}},{key:"render",value:function(currentTime){var _this3=this;Object.keys(this.eventrules).forEach(function(k){var lastTime=_this3.eventrules[k].ts,blink=currentTime-lastTime<_this3.eventrules[k].animation.duration;_this3._renderEventrule(_this3.eventrules[k],_this3.offlineCtx,blink)})}},{key:"clear",value:function(){var _this4=this;Object.keys(this.eventrules).forEach(function(k){delete _this4.eventrules[k]})}}]),EventRenderer}(),LOG_TAG$4="overlay",Log$11=getTagged(LOG_TAG$4),defaultOverlayConfig={canvas:"#canvas",canvasWidth:1920,canvasHeight:1080,video:"#player"},OverlayRenderer=function(){function OverlayRenderer(config,colormapConfig){classCallCheck(this,OverlayRenderer),this._initConfig(config),this.previewTrackID=0,this.eventRenderer=new EventRenderer(this.offlineCtx,this.canvasWidth,this.canvasHeight),this.objectRenderer=new ObjectRenderer(this.offlineCtx,this.canvasWidth,this.canvasHeight),this.heatmapRenderer=new HeatmapRenderer(this.offlineCtx,this.canvasWidth,this.canvasHeight,colormapConfig)}return createClass(OverlayRenderer,[{key:"getColormap",value:function(){return this.heatmapRenderer.colormap}},{key:"_initConfig",value:function(config){_typeof((config=config||defaultOverlayConfig).canvas)==_typeof("")?this.canvas=document.getElementById(config.canvas):this.canvas=config.canvas,_typeof(config.video)==_typeof("")?this.video=document.getElementById(config.video):this.video=config.video,this.ctx=this.canvas.getContext("2d"),this.offlineCanvas=document.createElement("canvas"),this.offlineCanvas.width=config.video.offsetWidth,this.offlineCanvas.height=config.video.offsetHeight,this.offlineCanvas.style.width=config.video.offsetWidth+"px",this.offlineCanvas.style.height=config.video.offsetHeight+"px",this.offlineCtx=this.offlineCanvas.getContext("2d"),this.canvasWidth=config.video.offsetWidth,this.canvasHeight=config.video.offsetHeight}},{key:"restart",value:function(){this.objectRenderer.clear(),this.heatmapRenderer.clear(),this.eventRenderer.clear(),this.ctx.clearRect(0,0,this.canvasWidth,this.canvasHeight)}},{key:"updateCanvas",value:function(){var width=this.video.offsetWidth,height=this.video.offsetHeight;this.offlineCanvas.width=width,this.offlineCanvas.height=height,this.offlineCanvas.style.width=width+"px",this.offlineCanvas.style.height=height+"px",this.objectRenderer.setCanvas(width,height),this.heatmapRenderer.setCanvas(width,height),this.eventRenderer.setCanvas(width,height)}},{key:"render",value:function(currentTime,previewInfo,videoWidth,videoHeight){var _this=this;this.updateCanvas(),this.offlineCtx.clearRect(0,0,this.canvasWidth,this.canvasHeight),previewInfo&&(previewInfo.rules&&this.eventRenderer.update(currentTime,videoWidth,videoHeight,previewInfo.rules),previewInfo.objects.forEach(function(target){void 0!=target.trackId&&0!=target.trackId||(_this.previewTrackID++,target.trackId=_this.previewTrackID,_this.previewTrackID>1e6&&(_this.previewTrackID=0));var status=_this.eventRenderer.enqueue(currentTime,videoWidth,videoHeight,target)?1:0;_this.objectRenderer.enqueue(currentTime,videoWidth,videoHeight,target,status),_this.heatmapRenderer.enqueue(currentTime,videoWidth,videoHeight,target,status)})),this.heatmapRenderer.render(currentTime),this.eventRenderer.render(currentTime),this.objectRenderer.render(currentTime),this.ctx.clearRect(0,0,this.canvasWidth,this.canvasHeight),this.ctx.drawImage(this.offlineCanvas,0,0,this.canvasWidth,this.canvasHeight)}}]),OverlayRenderer}();setDefaultLogLevel(LogLevel.Error);var streamedian={logger:function(tag){return getTagged(tag)},player:function(node,opts){if(console.info("Player: @sensetime/streamedian@0.5.0"),!opts.socket)throw new Error("socket parameter is not set");var _options={modules:[{client:RTSPClient,transport:{constructor:WebsocketTransport,options:{socket:opts.socket,reconnectHandler:opts.reconnectHandler||null,disconnectHandler:opts.disconnectHandler||null}}}],errorHandler:function(e){console.error("Failed to start player: "+e.message)},queryCredentials:function(){var _this=this;return new Promise(function(resolve,reject){var c=prompt("input credentials in format user:password");c?(_this.setCredentials(c.split(":")),resolve()):reject()})}};return new WSPlayer(node,_options)},overlayRenderer:function(config){return new OverlayRenderer(config)}};
